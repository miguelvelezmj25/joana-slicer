<html><body><pre><code><div>  /*</div><div>   * Copyright 2013, Morten Nobel-Joergensen</div><div>   *</div><div>   * License: The BSD 3-Clause License</div><div>   * http://opensource.org/licenses/BSD-3-Clause</div><div>   */</div><div>  package com.mortennobel.imagescaling;</div><div>  </div><div>  import java.awt.*;</div><div>  import java.awt.image.BufferedImage;</div><div>  </div><div>  /**</div><div>   * This code is very inspired on Chris Campbells article &quot;The Perils of Image.getScaledInstance()&quot;</div><div>   *</div><div>   * &lt;p&gt;The article can be found here:</div><div>   * http://today.java.net/pub/a/today/2007/04/03/perils-of-image-getscaledinstance.html</div><div>   *</div><div>   * &lt;p&gt;Note that the filter method is threadsafe</div><div>   */</div><div>  public class MultiStepRescaleOp extends AdvancedResizeOp {</div><div>    private final Object renderingHintInterpolation;</div><div>  </div><div>    public MultiStepRescaleOp(int dstWidth, int dstHeight) {</div><div>      this(dstWidth, dstHeight, RenderingHints.VALUE_INTERPOLATION_BILINEAR);</div><div>    }</div><div>  </div><div>    public MultiStepRescaleOp(int dstWidth, int dstHeight, Object renderingHintInterpolation) {</div><div>*     this(</div><div>*         DimensionConstrain.createAbsolutionDimension(dstWidth, dstHeight),</div><div>          renderingHintInterpolation);</div><div>    }</div><div>  </div><div>    public MultiStepRescaleOp(DimensionConstrain dimensionConstain) {</div><div>      this(dimensionConstain, RenderingHints.VALUE_INTERPOLATION_BILINEAR);</div><div>    }</div><div>  </div><div>    public MultiStepRescaleOp(</div><div>        DimensionConstrain dimensionConstain, Object renderingHintInterpolation) {</div><div>*     super(dimensionConstain);</div><div>      this.renderingHintInterpolation = renderingHintInterpolation;</div><div>*     assert RenderingHints.KEY_INTERPOLATION.isCompatibleValue(renderingHintInterpolation)</div><div>          : &quot;Rendering hint &quot; + renderingHintInterpolation + &quot; is not compatible with interpolation&quot;;</div><div>    }</div><div>  </div><div>    public BufferedImage doFilter(</div><div>        BufferedImage img, BufferedImage dest, int dstWidth, int dstHeight) {</div><div>      int type =</div><div>*         (img.getTransparency() == Transparency.OPAQUE)</div><div>              ? BufferedImage.TYPE_INT_RGB</div><div>              : BufferedImage.TYPE_INT_ARGB;</div><div>      BufferedImage ret = img;</div><div>      int w, h;</div><div>  </div><div>      // Use multi-step technique: start with original size, then</div><div>      // scale down in multiple passes with drawImage()</div><div>      // until the target size is reached</div><div>*     w = img.getWidth();</div><div>*     h = img.getHeight();</div><div>  </div><div>      do {</div><div>*       if (w &gt; dstWidth) {</div><div>*         w /= 2;</div><div>*         if (w &lt; dstWidth) {</div><div>            w = dstWidth;</div><div>          }</div><div>        } else {</div><div>          w = dstWidth;</div><div>        }</div><div>  </div><div>*       if (h &gt; dstHeight) {</div><div>*         h /= 2;</div><div>*         if (h &lt; dstHeight) {</div><div>            h = dstHeight;</div><div>          }</div><div>        } else {</div><div>          h = dstHeight;</div><div>        }</div><div>  </div><div>        BufferedImage tmp;</div><div>*       if (dest != null</div><div>*           &amp;&amp; dest.getWidth() == w</div><div>*           &amp;&amp; dest.getHeight() == h</div><div>            &amp;&amp; w == dstWidth</div><div>            &amp;&amp; h == dstHeight) {</div><div>          tmp = dest;</div><div>        } else {</div><div>*         tmp = new BufferedImage(w, h, type);</div><div>        }</div><div>*       Graphics2D g2 = tmp.createGraphics();</div><div>        g2.setRenderingHint(RenderingHints.KEY_INTERPOLATION, renderingHintInterpolation);</div><div>        g2.drawImage(ret, 0, 0, w, h, null);</div><div>        g2.dispose();</div><div>  </div><div>        ret = tmp;</div><div>*     } while (w != dstWidth || h != dstHeight);</div><div>  </div><div>*     return ret;</div><div>    }</div><div>  }</div></code></pre></body></html>