<html><body style="font-size:16px;width:1000px;"><pre><code><div> /*</div><div>  *  Copyright 2016 Patrick Favre-Bulle</div><div>  *</div><div>  *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</div><div>  *  you may not use this file except in compliance with the License.</div><div>  *  You may obtain a copy of the License at</div><div>  *</div><div>  *      http://www.apache.org/licenses/LICENSE-2.0</div><div>  *</div><div>  * Unless required by applicable law or agreed to in writing, software</div><div>  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</div><div>  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div><div>  * See the License for the specific language governing permissions and</div><div>  * limitations under the License.</div><div>  */</div><div> </div><div> package at.favre.tools.dconvert;</div><div> </div><div> import at.favre.tools.dconvert.arg.Arguments;</div><div> import at.favre.tools.dconvert.arg.EPlatform;</div><div> import at.favre.tools.dconvert.converters.IPlatformConverter;</div><div> import at.favre.tools.dconvert.converters.postprocessing.IPostProcessor;</div><div> import at.favre.tools.dconvert.converters.postprocessing.MozJpegProcessor;</div><div> import at.favre.tools.dconvert.converters.postprocessing.PngCrushProcessor;</div><div> import at.favre.tools.dconvert.converters.postprocessing.WebpProcessor;</div><div> import at.favre.tools.dconvert.converters.scaling.ImageHandler;</div><div> import at.favre.tools.dconvert.converters.scaling.ScaleAlgorithm;</div><div> import at.favre.tools.dconvert.util.MiscUtil;</div><div> </div><div> import javax.imageio.ImageIO;</div><div> import javax.imageio.ImageReader;</div><div> import javax.imageio.ImageWriter;</div><div> import java.io.File;</div><div> import java.util.*;</div><div> import java.util.concurrent.CountDownLatch;</div><div> import java.util.concurrent.TimeUnit;</div><div> </div><div> /**</div><div>  * This is the main class handling all of the converters and post processors. This handles the</div><div>  * threading and orchestration of the threads.</div><div>  *</div><div>  * &lt;p&gt;All user interfaces will call this class to execute.</div><div>  */</div><div style="background-color:MediumSpringGreen;"> public class DConvert {</div><div>   private CountDownLatch mainLatch;</div><div> </div><div>   private HandlerCallback handlerCallback;</div><div>   private long beginMs;</div><div>   private final StringBuilder logStringBuilder = new StringBuilder();</div><div> </div><div>   /**</div><div>    * Starts the execution of the dconvert</div><div>    *</div><div>    * @param args from user interface</div><div>    * @param blockingWaitForFinish if true will block the thread until all threads are finished</div><div>    * @param callback main callback</div><div>    */</div><div>   public void execute(final Arguments args, boolean blockingWaitForFinish, HandlerCallback callback) {</div><div>     beginMs = System.currentTimeMillis();</div><div>     handlerCallback = callback;</div><div> </div><div>     logStringBuilder</div><div>         .append(&quot;registered image readers:\n&quot;)</div><div style="background-color:MediumSpringGreen;">         .append(getRegisteredImageReadersAndWriters())</div><div style="background-color:MediumSpringGreen;">         .append(&quot;\n&quot;);</div><div style="background-color:MediumSpringGreen;">     logStringBuilder.append(&quot;begin execution using &quot;).append(args.threadCount).append(&quot; theads\n&quot;);</div><div style="background-color:MediumSpringGreen;">     logStringBuilder.append(&quot;args: &quot;).append(args).append(&quot;\n&quot;);</div><div> </div><div>     if (!args.filesToProcess.isEmpty()) {</div><div>       List&lt;IPlatformConverter&gt; converters = new ArrayList&lt;IPlatformConverter&gt;();</div><div>       final List&lt;IPostProcessor&gt; postProcessors = new ArrayList&lt;IPostProcessor&gt;();</div><div> </div><div style="background-color:MediumSpringGreen;">       for (EPlatform ePlatform : args.platform) {</div><div style="background-color:MediumSpringGreen;">         logStringBuilder</div><div style="background-color:MediumSpringGreen;">             .append(&quot;add &quot;)</div><div style="background-color:MediumSpringGreen;">             .append(ePlatform.getConverter().getClass().getSimpleName())</div><div style="background-color:MediumSpringGreen;">             .append(&quot;\n&quot;);</div><div style="background-color:MediumSpringGreen;">         converters.add(ePlatform.getConverter());</div><div>       }</div><div> </div><div>       if (args.clearDirBeforeConvert) {</div><div style="background-color:MediumSpringGreen;">         logStringBuilder.append(&quot;clear out dirs before convert\n&quot;);</div><div style="background-color:MediumSpringGreen;">         for (IPlatformConverter converter : converters) {</div><div style="background-color:MediumSpringGreen;">           converter.clean(args);</div><div>         }</div><div>       }</div><div> </div><div>       if (args.enablePngCrush) {</div><div>         IPostProcessor postProcessor = new PngCrushProcessor();</div><div style="background-color:MediumSpringGreen;">         if (postProcessor.isSupported()) {</div><div style="background-color:MediumSpringGreen;">           logStringBuilder.append(&quot;add pngcrush postprocessor\n&quot;);</div><div style="background-color:MediumSpringGreen;">           postProcessors.add(postProcessor);</div><div>         } else {</div><div style="background-color:MediumSpringGreen;">           logStringBuilder.append(</div><div>               &quot;WARNING: Tool &#x27;pngcrush&#x27; cannot be accessed. Is it set in PATH?\n&quot;);</div><div>         }</div><div>       }</div><div>       if (args.postConvertWebp) {</div><div>         IPostProcessor postProcessor = new WebpProcessor();</div><div style="background-color:MediumSpringGreen;">         if (postProcessor.isSupported()) {</div><div style="background-color:MediumSpringGreen;">           logStringBuilder.append(&quot;add cwebp postprocessor\n&quot;);</div><div style="background-color:MediumSpringGreen;">           postProcessors.add(postProcessor);</div><div>         } else {</div><div style="background-color:MediumSpringGreen;">           logStringBuilder.append(&quot;WARNING: Tool &#x27;cwebp&#x27; cannot be accessed. Is it set in PATH?\n&quot;);</div><div>         }</div><div>       }</div><div>       if (args.enableMozJpeg) {</div><div>         IPostProcessor postProcessor = new MozJpegProcessor();</div><div style="background-color:MediumSpringGreen;">         if (postProcessor.isSupported()) {</div><div style="background-color:MediumSpringGreen;">           logStringBuilder.append(&quot;add mozJpeg postprocessor\n&quot;);</div><div style="background-color:MediumSpringGreen;">           postProcessors.add(postProcessor);</div><div>         } else {</div><div style="background-color:MediumSpringGreen;">           logStringBuilder.append(</div><div>               &quot;WARNING: Tool &#x27;jpegtran&#x27; cannot be accessed. Is it set in PATH?\n&quot;);</div><div>         }</div><div>       }</div><div> </div><div style="background-color:MediumSpringGreen;">       int convertJobs = args.filesToProcess.size() * converters.size();</div><div style="background-color:MediumSpringGreen;">       int postProcessorJobs = convertJobs * postProcessors.size();</div><div> </div><div style="background-color:MediumSpringGreen;">       final float convertPercentage = (float) convertJobs / (float) (convertJobs + postProcessorJobs);</div><div style="background-color:MediumSpringGreen;">       final float postProcessPercentage =</div><div>           (float) postProcessorJobs / (float) (convertJobs + postProcessorJobs);</div><div> </div><div>       mainLatch = new CountDownLatch(1);</div><div> </div><div style="background-color:MediumSpringGreen;">       for (File srcFile : args.filesToProcess) {</div><div style="background-color:MediumSpringGreen;">         logStringBuilder.append(&quot;add &quot;).append(srcFile).append(&quot; to processing queue\n&quot;);</div><div> </div><div>         if (!srcFile.exists() || !srcFile.isFile()) {</div><div style="background-color:MediumSpringGreen;">           throw new IllegalStateException(&quot;srcFile &quot; + srcFile + &quot; does not exist&quot;);</div><div>         }</div><div>       }</div><div> </div><div style="background-color:MediumSpringGreen;">       new WorkerHandler&lt;IPlatformConverter&gt;(</div><div>               converters,</div><div>               args,</div><div style="background-color:MediumSpringGreen;">               new WorkerHandler.Callback() {</div><div>                 @Override</div><div>                 public void onProgress(float percent) {</div><div style="background-color:MediumSpringGreen;">                   handlerCallback.onProgress(convertPercentage * percent);</div><div>                 }</div><div> </div><div>                 @Override</div><div>                 public void onFinished(</div><div>                     final int finishedJobsConverters,</div><div>                     List&lt;File&gt; outFiles,</div><div>                     final StringBuilder logConverters,</div><div>                     final List&lt;Exception&gt; exceptionsConverters,</div><div>                     final boolean haltedDuringProcessConverters) {</div><div style="background-color:MediumSpringGreen;">                   logStringBuilder.append(logConverters);</div><div>                   if (haltedDuringProcessConverters) {</div><div style="background-color:MediumSpringGreen;">                     informFinished(finishedJobsConverters, exceptionsConverters, true);</div><div>                   } else {</div><div style="background-color:MediumSpringGreen;">                     new WorkerHandler&lt;IPostProcessor&gt;(</div><div>                             postProcessors,</div><div>                             args,</div><div style="background-color:MediumSpringGreen;">                             new WorkerHandler.Callback() {</div><div>                               @Override</div><div>                               public void onProgress(float percent) {</div><div style="background-color:MediumSpringGreen;">                                 handlerCallback.onProgress(</div><div>                                     convertPercentage + (postProcessPercentage * percent));</div><div>                               }</div><div> </div><div>                               @Override</div><div>                               public void onFinished(</div><div>                                   int finishedJobsPostProcessors,</div><div>                                   List&lt;File&gt; outFiles,</div><div>                                   StringBuilder log,</div><div>                                   List&lt;Exception&gt; exceptions,</div><div>                                   boolean haltedDuringProcess) {</div><div style="background-color:MediumSpringGreen;">                                 exceptionsConverters.addAll(exceptions);</div><div style="background-color:MediumSpringGreen;">                                 logStringBuilder.append(log);</div><div style="background-color:MediumSpringGreen;">                                 informFinished(</div><div>                                     finishedJobsPostProcessors + finishedJobsConverters,</div><div>                                     exceptionsConverters,</div><div>                                     haltedDuringProcess);</div><div>                               }</div><div>                             })</div><div style="background-color:MediumSpringGreen;">                         .start(outFiles);</div><div>                   }</div><div>                 }</div><div>               })</div><div style="background-color:MediumSpringGreen;">           .start(args.filesToProcess);</div><div> </div><div>       if (blockingWaitForFinish) {</div><div>         try {</div><div style="background-color:MediumSpringGreen;">           mainLatch.await(60, TimeUnit.MINUTES);</div><div>         } catch (InterruptedException e) {</div><div>           e.printStackTrace();</div><div>         }</div><div>       }</div><div>     } else {</div><div style="background-color:MediumSpringGreen;">       logStringBuilder.append(&quot;no files to convert\n&quot;);</div><div style="background-color:MediumSpringGreen;">       informFinished(0, new ArrayList&lt;Exception&gt;(), false);</div><div>     }</div><div>   }</div><div> </div><div>   private void informFinished(</div><div>       int finishedJobs, List&lt;Exception&gt; exceptions, boolean haltedDuringProcess) {</div><div>     System.gc();</div><div>     printTrace();</div><div>     if (handlerCallback != null) {</div><div>       if (mainLatch != null) {</div><div style="background-color:MediumSpringGreen;">         mainLatch.countDown();</div><div>       }</div><div style="background-color:MediumSpringGreen;">       for (Exception exception : exceptions) {</div><div style="background-color:MediumSpringGreen;">         logStringBuilder.append(MiscUtil.getStackTrace(exception)).append(&quot;\n&quot;);</div><div>       }</div><div style="background-color:MediumSpringGreen;">       handlerCallback.onFinished(</div><div>           finishedJobs,</div><div>           exceptions,</div><div style="background-color:MediumSpringGreen;">           (System.currentTimeMillis() - beginMs),</div><div>           haltedDuringProcess,</div><div style="background-color:MediumSpringGreen;">           logStringBuilder.toString().trim());</div><div>     }</div><div>   }</div><div> </div><div>   private String getRegisteredImageReadersAndWriters() {</div><div>     String[] formats = new String[] {&quot;JPEG&quot;, &quot;PNG&quot;, &quot;TIFF&quot;, &quot;PSD&quot;, &quot;SVG&quot;, &quot;BMP&quot;};</div><div> </div><div>     StringBuilder sb = new StringBuilder();</div><div>     for (String format : formats) {</div><div style="background-color:MediumSpringGreen;">       Iterator&lt;ImageReader&gt; reader = ImageIO.getImageReadersByFormatName(format);</div><div>       while (reader.hasNext()) {</div><div style="background-color:MediumSpringGreen;">         ImageReader next = reader.next();</div><div style="background-color:MediumSpringGreen;">         sb.append(&quot;reader: &quot;).append(next).append(&quot;\n&quot;);</div><div>       }</div><div style="background-color:MediumSpringGreen;">       Iterator&lt;ImageWriter&gt; writer = ImageIO.getImageWritersByFormatName(format);</div><div>       while (writer.hasNext()) {</div><div style="background-color:MediumSpringGreen;">         ImageWriter next = writer.next();</div><div style="background-color:MediumSpringGreen;">         sb.append(&quot;writer: &quot;).append(next).append(&quot;\n&quot;);</div><div>       }</div><div>     }</div><div style="background-color:MediumSpringGreen;">     return sb.toString();</div><div>   }</div><div> </div><div>   private void printTrace() {</div><div>     if (ImageHandler.TEST_MODE) {</div><div>       for (Map.Entry&lt;ScaleAlgorithm, Long&gt; entry : ImageHandler.traceMap.entrySet()) {</div><div>         System.out.println(</div><div>             entry.getKey()</div><div>                 + &quot;: &quot;</div><div>                 + String.format(Locale.US, &quot;%.2f&quot;, (double) entry.getValue() / 1000000.0));</div><div>       }</div><div>     }</div><div>   }</div><div> </div><div>   public interface HandlerCallback {</div><div>     void onProgress(float progress);</div><div> </div><div>     void onFinished(</div><div>         int finishedJobs,</div><div>         List&lt;Exception&gt; exceptions,</div><div>         long time,</div><div>         boolean haltedDuringProcess,</div><div>         String log);</div><div>   }</div><div> }</div></code></pre></body></html>