<html><body style="font-size:16px;width:1000px;"><pre><code><div> /*</div><div>  *  Copyright 2016 Patrick Favre-Bulle</div><div>  *</div><div>  *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</div><div>  *  you may not use this file except in compliance with the License.</div><div>  *  You may obtain a copy of the License at</div><div>  *</div><div>  *      http://www.apache.org/licenses/LICENSE-2.0</div><div>  *</div><div>  * Unless required by applicable law or agreed to in writing, software</div><div>  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</div><div>  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div><div>  * See the License for the specific language governing permissions and</div><div>  * limitations under the License.</div><div>  */</div><div> </div><div> package at.favre.tools.dconvert.converters.scaling;</div><div> </div><div> import net.coobird.thumbnailator.makers.FixedSizeThumbnailMaker;</div><div> import net.coobird.thumbnailator.resizers.AbstractResizer;</div><div> </div><div> import java.awt.*;</div><div> import java.awt.image.BufferedImage;</div><div> import java.util.HashMap;</div><div> import java.util.Map;</div><div> </div><div> /** Algorithms from Thumbnailnator */</div><div> public class ThumbnailnatorProgressiveAlgorithm implements ScaleAlgorithm {</div><div> </div><div>   private final Object interpolationValue;</div><div> </div><div>   public ThumbnailnatorProgressiveAlgorithm(Object interpolationValue) {</div><div>     this.interpolationValue = interpolationValue;</div><div>   }</div><div> </div><div>   @Override</div><div>   public BufferedImage scale(BufferedImage imageToScale, int dWidth, int dHeight) {</div><div style="background-color:MediumSpringGreen;">     return new FixedSizeThumbnailMaker(dWidth, dHeight, false, true)</div><div>         .resizer(new ProgressiveResizer(interpolationValue))</div><div style="background-color:MediumSpringGreen;">         .make(imageToScale);</div><div>   }</div><div> </div><div>   @Override</div><div>   public String toString() {</div><div>     return &quot;ThumbnailnatorProgressiveAlgorithm{&quot; + &quot;interpolationValue=&quot; + interpolationValue + &#x27;}&#x27;;</div><div>   }</div><div> </div><div>   @Override</div><div>   public boolean equals(Object o) {</div><div>     if (this == o) return true;</div><div>     if (o == null || getClass() != o.getClass()) return false;</div><div> </div><div>     ThumbnailnatorProgressiveAlgorithm that = (ThumbnailnatorProgressiveAlgorithm) o;</div><div> </div><div>     return interpolationValue != null</div><div>         ? interpolationValue.equals(that.interpolationValue)</div><div>         : that.interpolationValue == null;</div><div>   }</div><div> </div><div>   @Override</div><div>   public int hashCode() {</div><div>     return interpolationValue != null ? interpolationValue.hashCode() : 0;</div><div>   }</div><div> </div><div>   public static class ProgressiveResizer extends AbstractResizer {</div><div>     public ProgressiveResizer(Object interpolationValue) {</div><div>       this(interpolationValue, new HashMap&lt;RenderingHints.Key, Object&gt;());</div><div>     }</div><div> </div><div>     public ProgressiveResizer(Object interpolationValue, Map&lt;RenderingHints.Key, Object&gt; hints) {</div><div>       super(interpolationValue, hints);</div><div>       checkArg(interpolationValue);</div><div>     }</div><div> </div><div>     private void checkArg(Object interpolationValue) {</div><div>       if (interpolationValue != RenderingHints.VALUE_INTERPOLATION_BICUBIC</div><div>           &amp;&amp; interpolationValue != RenderingHints.VALUE_INTERPOLATION_BILINEAR</div><div>           &amp;&amp; interpolationValue != RenderingHints.VALUE_INTERPOLATION_NEAREST_NEIGHBOR)</div><div>         throw new IllegalArgumentException(</div><div>             &quot;wrong argument passed muts be one of RenderingHints.VALUE_INTERPOLATION_BICUBIC, &quot;</div><div>                 + &quot;RenderingHints.VALUE_INTERPOLATION_BILINEAR or RenderingHints.VALUE_INTERPOLATION_NEAREST_NEIGHBOR&quot;);</div><div>     }</div><div> </div><div>     @Override</div><div>     public void resize(BufferedImage srcImage, BufferedImage destImage)</div><div>         throws NullPointerException {</div><div>       super.performChecks(srcImage, destImage);</div><div> </div><div>       int currentWidth = srcImage.getWidth();</div><div>       int currentHeight = srcImage.getHeight();</div><div> </div><div>       final int targetWidth = destImage.getWidth();</div><div>       final int targetHeight = destImage.getHeight();</div><div> </div><div>       // If multi-step downscaling is not required, perform one-step.</div><div>       if ((targetWidth * 2 &gt;= currentWidth) &amp;&amp; (targetHeight * 2 &gt;= currentHeight)) {</div><div>         super.resize(srcImage, destImage);</div><div>         return;</div><div>       }</div><div> </div><div>       // Temporary image used for in-place resizing of image.</div><div>       BufferedImage tempImage = new BufferedImage(currentWidth, currentHeight, destImage.getType());</div><div> </div><div>       Graphics2D g = tempImage.createGraphics();</div><div>       g.setRenderingHints(RENDERING_HINTS);</div><div>       g.setComposite(AlphaComposite.Src);</div><div> </div><div>       /*</div><div>        * Determine the size of the first resize step should be.</div><div>        * 1) Beginning from the target size</div><div>        * 2) Increase each dimension by 2</div><div>        * 3) Until reaching the original size</div><div>        */</div><div> </div><div>       int startWidth = targetWidth;</div><div>       int startHeight = targetHeight;</div><div> </div><div>       while (startWidth &lt; currentWidth &amp;&amp; startHeight &lt; currentHeight) {</div><div>         startWidth *= 2;</div><div>         startHeight *= 2;</div><div>       }</div><div> </div><div>       currentWidth = startWidth / 2;</div><div>       currentHeight = startHeight / 2;</div><div> </div><div>       // Perform first resize step.</div><div>       g.drawImage(srcImage, 0, 0, currentWidth, currentHeight, null);</div><div> </div><div>       // Perform an in-place progressive bilinear resize.</div><div>       while ((currentWidth &gt;= targetWidth * 2) &amp;&amp; (currentHeight &gt;= targetHeight * 2)) {</div><div>         currentWidth /= 2;</div><div>         currentHeight /= 2;</div><div> </div><div>         if (currentWidth &lt; targetWidth) {</div><div>           currentWidth = targetWidth;</div><div>         }</div><div>         if (currentHeight &lt; targetHeight) {</div><div>           currentHeight = targetHeight;</div><div>         }</div><div> </div><div>         g.drawImage(</div><div>             tempImage,</div><div>             0,</div><div>             0,</div><div>             currentWidth,</div><div>             currentHeight,</div><div>             0,</div><div>             0,</div><div>             currentWidth * 2,</div><div>             currentHeight * 2,</div><div>             null);</div><div>       }</div><div> </div><div>       g.dispose();</div><div> </div><div>       // Draw the resized image onto the destination image.</div><div>       Graphics2D destg = destImage.createGraphics();</div><div>       destg.drawImage(</div><div>           tempImage, 0, 0, targetWidth, targetHeight, 0, 0, currentWidth, currentHeight, null);</div><div>       destg.dispose();</div><div>     }</div><div>   }</div><div> }</div></code></pre></body></html>