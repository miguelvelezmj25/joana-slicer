<html><body style="font-size:16px;width:1000px;"><pre><code><div> /*</div><div>  * Copyright 2013, Morten Nobel-Joergensen</div><div>  *</div><div>  * License: The BSD 3-Clause License</div><div>  * http://opensource.org/licenses/BSD-3-Clause</div><div>  */</div><div> package com.mortennobel.imagescaling;</div><div> </div><div> import javax.imageio.IIOImage;</div><div> import javax.imageio.ImageIO;</div><div> import javax.imageio.ImageReader;</div><div> import javax.imageio.ImageWriter;</div><div> import javax.imageio.metadata.IIOMetadata;</div><div> import javax.imageio.stream.ImageInputStream;</div><div> import javax.imageio.stream.ImageOutputStream;</div><div> import javax.imageio.stream.MemoryCacheImageInputStream;</div><div> import javax.imageio.stream.MemoryCacheImageOutputStream;</div><div> import java.awt.*;</div><div> import java.awt.image.BufferedImage;</div><div> import java.awt.image.Raster;</div><div> import java.awt.image.WritableRaster;</div><div> import java.io.ByteArrayInputStream;</div><div> import java.io.ByteArrayOutputStream;</div><div> import java.io.IOException;</div><div> import java.io.InputStream;</div><div> import java.util.Iterator;</div><div> </div><div> /**</div><div>  * @author Heinz Doerr</div><div>  * @author Morten Nobel-Joergensen</div><div>  */</div><div> public class ImageUtils {</div><div> </div><div>   public static String imageTypeName(BufferedImage img) {</div><div>     switch (img.getType()) {</div><div>       case BufferedImage.TYPE_3BYTE_BGR:</div><div>         return &quot;TYPE_3BYTE_BGR&quot;;</div><div>       case BufferedImage.TYPE_4BYTE_ABGR:</div><div>         return &quot;TYPE_4BYTE_ABGR&quot;;</div><div>       case BufferedImage.TYPE_4BYTE_ABGR_PRE:</div><div>         return &quot;TYPE_4BYTE_ABGR_PRE&quot;;</div><div>       case BufferedImage.TYPE_BYTE_BINARY:</div><div>         return &quot;TYPE_BYTE_BINARY&quot;;</div><div>       case BufferedImage.TYPE_BYTE_GRAY:</div><div>         return &quot;TYPE_BYTE_GRAY&quot;;</div><div>       case BufferedImage.TYPE_BYTE_INDEXED:</div><div>         return &quot;TYPE_BYTE_INDEXED&quot;;</div><div>       case BufferedImage.TYPE_CUSTOM:</div><div>         return &quot;TYPE_CUSTOM&quot;;</div><div>       case BufferedImage.TYPE_INT_ARGB:</div><div>         return &quot;TYPE_INT_ARGB&quot;;</div><div>       case BufferedImage.TYPE_INT_ARGB_PRE:</div><div>         return &quot;TYPE_INT_ARGB_PRE&quot;;</div><div>       case BufferedImage.TYPE_INT_BGR:</div><div>         return &quot;TYPE_INT_BGR&quot;;</div><div>       case BufferedImage.TYPE_INT_RGB:</div><div>         return &quot;TYPE_INT_RGB&quot;;</div><div>       case BufferedImage.TYPE_USHORT_555_RGB:</div><div>         return &quot;TYPE_USHORT_555_RGB&quot;;</div><div>       case BufferedImage.TYPE_USHORT_565_RGB:</div><div>         return &quot;TYPE_USHORT_565_RGB&quot;;</div><div>       case BufferedImage.TYPE_USHORT_GRAY:</div><div>         return &quot;TYPE_USHORT_GRAY&quot;;</div><div>     }</div><div>     return &quot;unknown image type #&quot; + img.getType();</div><div>   }</div><div> </div><div>   public static int nrChannels(BufferedImage img) {</div><div style="background-color:MediumSpringGreen;">     switch (img.getType()) {</div><div>       case BufferedImage.TYPE_3BYTE_BGR:</div><div style="background-color:MediumSpringGreen;">         return 3;</div><div>       case BufferedImage.TYPE_4BYTE_ABGR:</div><div style="background-color:MediumSpringGreen;">         return 4;</div><div>       case BufferedImage.TYPE_BYTE_GRAY:</div><div style="background-color:MediumSpringGreen;">         return 1;</div><div>       case BufferedImage.TYPE_INT_BGR:</div><div style="background-color:MediumSpringGreen;">         return 3;</div><div>       case BufferedImage.TYPE_INT_ARGB:</div><div style="background-color:MediumSpringGreen;">         return 4;</div><div>       case BufferedImage.TYPE_INT_RGB:</div><div style="background-color:MediumSpringGreen;">         return 3;</div><div>       case BufferedImage.TYPE_CUSTOM:</div><div style="background-color:MediumSpringGreen;">         return 4;</div><div>       case BufferedImage.TYPE_4BYTE_ABGR_PRE:</div><div style="background-color:MediumSpringGreen;">         return 4;</div><div>       case BufferedImage.TYPE_INT_ARGB_PRE:</div><div style="background-color:MediumSpringGreen;">         return 4;</div><div>       case BufferedImage.TYPE_USHORT_555_RGB:</div><div style="background-color:MediumSpringGreen;">         return 3;</div><div>       case BufferedImage.TYPE_USHORT_565_RGB:</div><div style="background-color:MediumSpringGreen;">         return 3;</div><div>       case BufferedImage.TYPE_USHORT_GRAY:</div><div style="background-color:MediumSpringGreen;">         return 1;</div><div>     }</div><div style="background-color:MediumSpringGreen;">     return 0;</div><div>   }</div><div> </div><div>   /**</div><div>    * returns one row (height == 1) of byte packed image data in BGR or AGBR form</div><div>    *</div><div>    * @param img</div><div>    * @param y</div><div>    * @param w</div><div>    * @param array</div><div>    * @param temp must be either null or a array with length of w*h</div><div>    * @return</div><div>    */</div><div>   public static byte[] getPixelsBGR(BufferedImage img, int y, int w, byte[] array, int[] temp) {</div><div>     final int x = 0;</div><div>     final int h = 1;</div><div> </div><div>     assert array.length == temp.length * nrChannels(img);</div><div>     assert (temp.length == w);</div><div> </div><div>     int imageType = img.getType();</div><div>     Raster raster;</div><div>     switch (imageType) {</div><div>       case BufferedImage.TYPE_3BYTE_BGR:</div><div>       case BufferedImage.TYPE_4BYTE_ABGR:</div><div>       case BufferedImage.TYPE_4BYTE_ABGR_PRE:</div><div>       case BufferedImage.TYPE_BYTE_GRAY:</div><div>         raster = img.getRaster();</div><div>         // int ttype= raster.getTransferType();</div><div>         raster.getDataElements(x, y, w, h, array);</div><div>         break;</div><div>       case BufferedImage.TYPE_INT_BGR:</div><div>         raster = img.getRaster();</div><div>         raster.getDataElements(x, y, w, h, temp);</div><div>         ints2bytes(temp, array, 0, 1, 2); // bgr --&gt;  bgr</div><div>         break;</div><div>       case BufferedImage.TYPE_INT_RGB:</div><div>         raster = img.getRaster();</div><div>         raster.getDataElements(x, y, w, h, temp);</div><div>         ints2bytes(temp, array, 2, 1, 0); // rgb --&gt;  bgr</div><div>         break;</div><div>       case BufferedImage.TYPE_INT_ARGB:</div><div>       case BufferedImage.TYPE_INT_ARGB_PRE:</div><div>         raster = img.getRaster();</div><div>         raster.getDataElements(x, y, w, h, temp);</div><div>         ints2bytes(temp, array, 2, 1, 0, 3); // argb --&gt;  abgr</div><div>         break;</div><div>       case BufferedImage.TYPE_CUSTOM: // TODO: works for my icon image loader, but else ???</div><div>         img.getRGB(x, y, w, h, temp, 0, w);</div><div>         ints2bytes(temp, array, 2, 1, 0, 3); // argb --&gt;  abgr</div><div>         break;</div><div>       default:</div><div>         img.getRGB(x, y, w, h, temp, 0, w);</div><div>         ints2bytes(temp, array, 2, 1, 0); // rgb --&gt;  bgr</div><div>         break;</div><div>     }</div><div> </div><div>     return array;</div><div>   }</div><div> </div><div>   /**</div><div>    * converts and copies byte packed BGR or ABGR into the img buffer, the img type may vary (e.g.</div><div>    * RGB or BGR, int or byte packed) but the number of components (w/o alpha, w alpha, gray) must</div><div>    * match</div><div>    *</div><div>    * &lt;p&gt;does not unmange the image for all (A)RGN and (A)BGR and gray imaged</div><div>    */</div><div>   public static void setBGRPixels(byte[] bgrPixels, BufferedImage img, int x, int y, int w, int h) {</div><div>     int imageType = img.getType();</div><div>     WritableRaster raster = img.getRaster();</div><div>     // int ttype= raster.getTransferType();</div><div>     if (imageType == BufferedImage.TYPE_3BYTE_BGR</div><div>         || imageType == BufferedImage.TYPE_4BYTE_ABGR</div><div>         || imageType == BufferedImage.TYPE_4BYTE_ABGR_PRE</div><div>         || imageType == BufferedImage.TYPE_BYTE_GRAY) {</div><div>       raster.setDataElements(x, y, w, h, bgrPixels);</div><div>     } else {</div><div>       int[] pixels;</div><div>       if (imageType == BufferedImage.TYPE_INT_BGR) {</div><div>         pixels = bytes2int(bgrPixels, 2, 1, 0); // bgr --&gt;  bgr</div><div>       } else if (imageType == BufferedImage.TYPE_INT_ARGB</div><div>           || imageType == BufferedImage.TYPE_INT_ARGB_PRE) {</div><div>         pixels = bytes2int(bgrPixels, 3, 0, 1, 2); // abgr --&gt;  argb</div><div>       } else {</div><div>         pixels = bytes2int(bgrPixels, 0, 1, 2); // bgr --&gt;  rgb</div><div>       }</div><div>       if (w == 0 || h == 0) {</div><div>         return;</div><div>       } else if (pixels.length &lt; w * h) {</div><div>         throw new IllegalArgumentException(&quot;pixels array must have a length&quot; + &quot; &gt;= w*h&quot;);</div><div>       }</div><div>       if (imageType == BufferedImage.TYPE_INT_ARGB</div><div>           || imageType == BufferedImage.TYPE_INT_RGB</div><div>           || imageType == BufferedImage.TYPE_INT_ARGB_PRE</div><div>           || imageType == BufferedImage.TYPE_INT_BGR) {</div><div>         raster.setDataElements(x, y, w, h, pixels);</div><div>       } else {</div><div>         // Unmanages the image</div><div>         img.setRGB(x, y, w, h, pixels, 0, w);</div><div>       }</div><div>     }</div><div>   }</div><div> </div><div>   public static void ints2bytes(int[] in, byte[] out, int index1, int index2, int index3) {</div><div>     for (int i = 0; i &lt; in.length; i++) {</div><div>       int index = i * 3;</div><div>       int value = in[i];</div><div>       out[index + index1] = (byte) value;</div><div>       value = value &gt;&gt; 8;</div><div>       out[index + index2] = (byte) value;</div><div>       value = value &gt;&gt; 8;</div><div>       out[index + index3] = (byte) value;</div><div>     }</div><div>   }</div><div> </div><div>   public static void ints2bytes(</div><div>       int[] in, byte[] out, int index1, int index2, int index3, int index4) {</div><div>     for (int i = 0; i &lt; in.length; i++) {</div><div>       int index = i * 4;</div><div>       int value = in[i];</div><div>       out[index + index1] = (byte) value;</div><div>       value = value &gt;&gt; 8;</div><div>       out[index + index2] = (byte) value;</div><div>       value = value &gt;&gt; 8;</div><div>       out[index + index3] = (byte) value;</div><div>       value = value &gt;&gt; 8;</div><div>       out[index + index4] = (byte) value;</div><div>     }</div><div>   }</div><div> </div><div>   public static int[] bytes2int(byte[] in, int index1, int index2, int index3) {</div><div>     int[] out = new int[in.length / 3];</div><div>     for (int i = 0; i &lt; out.length; i++) {</div><div>       int index = i * 3;</div><div>       int b1 = (in[index + index1] &amp; 0xff) &lt;&lt; 16;</div><div>       int b2 = (in[index + index2] &amp; 0xff) &lt;&lt; 8;</div><div>       int b3 = in[index + index3] &amp; 0xff;</div><div>       out[i] = b1 | b2 | b3;</div><div>     }</div><div>     return out;</div><div>   }</div><div> </div><div>   public static int[] bytes2int(byte[] in, int index1, int index2, int index3, int index4) {</div><div>     int[] out = new int[in.length / 4];</div><div>     for (int i = 0; i &lt; out.length; i++) {</div><div>       int index = i * 4;</div><div>       int b1 = (in[index + index1] &amp; 0xff) &lt;&lt; 24;</div><div>       int b2 = (in[index + index2] &amp; 0xff) &lt;&lt; 16;</div><div>       int b3 = (in[index + index3] &amp; 0xff) &lt;&lt; 8;</div><div>       int b4 = in[index + index4] &amp; 0xff;</div><div>       out[i] = b1 | b2 | b3 | b4;</div><div>     }</div><div>     return out;</div><div>   }</div><div> </div><div>   public static BufferedImage convert(BufferedImage src, int bufImgType) {</div><div>     BufferedImage img = new BufferedImage(src.getWidth(), src.getHeight(), bufImgType);</div><div>     Graphics2D g2d = img.createGraphics();</div><div>     g2d.drawImage(src, 0, 0, null);</div><div>     g2d.dispose();</div><div>     return img;</div><div>   }</div><div> </div><div>   /**</div><div>    * Copy jpeg meta data (exif) from source to dest and save it to out.</div><div>    *</div><div>    * @param source</div><div>    * @param dest</div><div>    * @return result</div><div>    * @throws IOException</div><div>    */</div><div>   public static byte[] copyJpegMetaData(byte[] source, byte[] dest) throws IOException {</div><div>     ByteArrayOutputStream baos = new ByteArrayOutputStream();</div><div>     ImageOutputStream out = new MemoryCacheImageOutputStream(baos);</div><div>     copyJpegMetaData(new ByteArrayInputStream(source), new ByteArrayInputStream(dest), out);</div><div>     return baos.toByteArray();</div><div>   }</div><div> </div><div>   /**</div><div>    * Copy jpeg meta data (exif) from source to dest and save it to out</div><div>    *</div><div>    * @param source</div><div>    * @param dest</div><div>    * @param out</div><div>    * @throws IOException</div><div>    */</div><div>   public static void copyJpegMetaData(InputStream source, InputStream dest, ImageOutputStream out)</div><div>       throws IOException {</div><div>     // Read meta data from src image</div><div>     Iterator iter = ImageIO.getImageReadersByFormatName(&quot;jpeg&quot;);</div><div>     ImageReader reader = (ImageReader) iter.next();</div><div>     ImageInputStream iis = new MemoryCacheImageInputStream(source);</div><div>     reader.setInput(iis);</div><div>     IIOMetadata metadata = reader.getImageMetadata(0);</div><div>     iis.close();</div><div>     // Read dest image</div><div>     ImageInputStream outIis = new MemoryCacheImageInputStream(dest);</div><div>     reader.setInput(outIis);</div><div>     IIOImage image = reader.readAll(0, null);</div><div>     image.setMetadata(metadata);</div><div>     outIis.close();</div><div>     // write dest image</div><div>     iter = ImageIO.getImageWritersByFormatName(&quot;jpeg&quot;);</div><div>     ImageWriter writer = (ImageWriter) iter.next();</div><div>     writer.setOutput(out);</div><div>     writer.write(image);</div><div>   }</div><div> }</div></code></pre></body></html>