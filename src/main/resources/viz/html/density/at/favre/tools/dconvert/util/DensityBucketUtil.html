<html><body style="font-size:16px;width:1000px;"><pre><code><div> /*</div><div>  *  Copyright 2016 Patrick Favre-Bulle</div><div>  *</div><div>  *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</div><div>  *  you may not use this file except in compliance with the License.</div><div>  *  You may obtain a copy of the License at</div><div>  *</div><div>  *      http://www.apache.org/licenses/LICENSE-2.0</div><div>  *</div><div>  * Unless required by applicable law or agreed to in writing, software</div><div>  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</div><div>  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div><div>  * See the License for the specific language governing permissions and</div><div>  * limitations under the License.</div><div>  */</div><div> </div><div> package at.favre.tools.dconvert.util;</div><div> </div><div> import at.favre.tools.dconvert.arg.Arguments;</div><div> import at.favre.tools.dconvert.arg.EScaleMode;</div><div> import at.favre.tools.dconvert.converters.descriptors.DensityDescriptor;</div><div> </div><div> import java.awt.*;</div><div> import java.io.File;</div><div> import java.io.IOException;</div><div> import java.util.Map;</div><div> import java.util.TreeMap;</div><div> </div><div> /** Helps assembling needed densities to convert to */</div><div> public final class DensityBucketUtil {</div><div>   private static final float SVG_UPSCALE_FACTOR = 4;</div><div> </div><div>   private DensityBucketUtil() {}</div><div> </div><div>   public static &lt;T extends DensityDescriptor&gt; Map&lt;T, Dimension&gt; getDensityBuckets(</div><div>       java.util.List&lt;T&gt; densities,</div><div>       Dimension srcDimension,</div><div>       Arguments args,</div><div>       float scale,</div><div>       boolean isNinePatch)</div><div>       throws IOException {</div><div> </div><div style="background-color:MediumSpringGreen;">     if (isNinePatch) {</div><div style="background-color:MediumSpringGreen;">       srcDimension.setSize(srcDimension.getWidth() - 2, srcDimension.getHeight() - 2);</div><div>     }</div><div> </div><div style="background-color:MediumSpringGreen;">     switch (args.scaleMode) {</div><div>       case DP_WIDTH:</div><div style="background-color:MediumSpringGreen;">         return getDensityBucketsWithDpScale(densities, srcDimension, args, scale);</div><div>       case DP_HEIGHT:</div><div style="background-color:MediumSpringGreen;">         return getDensityBucketsHeightDpScale(densities, srcDimension, args, scale);</div><div>       default:</div><div>       case FACTOR:</div><div style="background-color:MediumSpringGreen;">         return getDensityBucketsWithFactorScale(densities, srcDimension, args, scale);</div><div>     }</div><div>   }</div><div> </div><div>   private static &lt;T extends DensityDescriptor&gt; Map&lt;T, Dimension&gt; getDensityBucketsWithDpScale(</div><div>       java.util.List&lt;T&gt; densities, Dimension srcDimension, Arguments args, float scale)</div><div>       throws IOException {</div><div style="background-color:MediumSpringGreen;">     float scaleFactor = scale / (float) srcDimension.width;</div><div> </div><div style="background-color:MediumSpringGreen;">     int baseWidth = (int) args.round(scale);</div><div style="background-color:MediumSpringGreen;">     int baseHeight = (int) args.round(scaleFactor * (float) srcDimension.height);</div><div> </div><div style="background-color:MediumSpringGreen;">     Map&lt;T, Dimension&gt; bucketMap = new TreeMap&lt;T, Dimension&gt;();</div><div style="background-color:MediumSpringGreen;">     for (T density : densities) {</div><div style="background-color:MediumSpringGreen;">       if (args.round(baseWidth * density.scale) &lt;= srcDimension.width || !args.skipUpscaling) {</div><div style="background-color:MediumSpringGreen;">         bucketMap.put(</div><div>             density,</div><div>             new Dimension(</div><div style="background-color:MediumSpringGreen;">                 (int) args.round(baseWidth * density.scale),</div><div style="background-color:MediumSpringGreen;">                 (int) args.round(baseHeight * density.scale)));</div><div>       }</div><div>     }</div><div>     //    densities.stream()</div><div>     //        .filter(</div><div>     //            density -&gt;</div><div>     //                (int) args.round(baseWidth * density.scale) &lt;= srcDimension.width</div><div>     //                    || !args.skipUpscaling)</div><div>     //        .forEach(</div><div>     //            density -&gt; {</div><div>     //              bucketMap.put(</div><div>     //                  density,</div><div>     //                  new Dimension(</div><div>     //                      (int) args.round(baseWidth * density.scale),</div><div>     //                      (int) args.round(baseHeight * density.scale)));</div><div>     //            });</div><div style="background-color:MediumSpringGreen;">     return bucketMap;</div><div>   }</div><div> </div><div>   private static &lt;T extends DensityDescriptor&gt; Map&lt;T, Dimension&gt; getDensityBucketsHeightDpScale(</div><div>       java.util.List&lt;T&gt; densities, Dimension srcDimension, Arguments args, float scale)</div><div>       throws IOException {</div><div style="background-color:MediumSpringGreen;">     float scaleFactor = scale / (float) srcDimension.height;</div><div> </div><div style="background-color:MediumSpringGreen;">     int baseWidth = (int) args.round(scaleFactor * (float) srcDimension.width);</div><div style="background-color:MediumSpringGreen;">     int baseHeight = (int) args.round(scale);</div><div> </div><div style="background-color:MediumSpringGreen;">     Map&lt;T, Dimension&gt; bucketMap = new TreeMap&lt;T, Dimension&gt;();</div><div style="background-color:MediumSpringGreen;">     for (T density : densities) {</div><div style="background-color:MediumSpringGreen;">       if (args.round(baseHeight * density.scale) &lt;= srcDimension.height || !args.skipUpscaling) {</div><div style="background-color:MediumSpringGreen;">         bucketMap.put(</div><div>             density,</div><div>             new Dimension(</div><div style="background-color:MediumSpringGreen;">                 (int) args.round(baseWidth * density.scale),</div><div style="background-color:MediumSpringGreen;">                 (int) args.round(baseHeight * density.scale)));</div><div>       }</div><div>     }</div><div>     //    densities.stream()</div><div>     //        .filter(</div><div>     //            density -&gt;</div><div>     //                (int) args.round(baseHeight * density.scale) &lt;= srcDimension.height</div><div>     //                    || !args.skipUpscaling)</div><div>     //        .forEach(</div><div>     //            density -&gt; {</div><div>     //              bucketMap.put(</div><div>     //                  density,</div><div>     //                  new Dimension(</div><div>     //                      (int) args.round(baseWidth * density.scale),</div><div>     //                      (int) args.round(baseHeight * density.scale)));</div><div>     //            });</div><div style="background-color:MediumSpringGreen;">     return bucketMap;</div><div>   }</div><div> </div><div>   private static &lt;T extends DensityDescriptor&gt; Map&lt;T, Dimension&gt; getDensityBucketsWithFactorScale(</div><div>       java.util.List&lt;T&gt; densities, Dimension srcDimension, Arguments args, float scale) {</div><div style="background-color:MediumSpringGreen;">     double baseWidth = (double) srcDimension.width / scale;</div><div style="background-color:MediumSpringGreen;">     double baseHeight = (double) srcDimension.height / scale;</div><div> </div><div style="background-color:MediumSpringGreen;">     Map&lt;T, Dimension&gt; bucketMap = new TreeMap&lt;T, Dimension&gt;();</div><div style="background-color:MediumSpringGreen;">     for (T density : densities) {</div><div style="background-color:MediumSpringGreen;">       if (scale &gt;= density.scale || !args.skipUpscaling) {</div><div style="background-color:MediumSpringGreen;">         bucketMap.put(</div><div>             density,</div><div>             new Dimension(</div><div style="background-color:MediumSpringGreen;">                 (int) args.round(baseWidth * density.scale),</div><div style="background-color:MediumSpringGreen;">                 (int) args.round(baseHeight * density.scale)));</div><div>       }</div><div>     }</div><div>     //    densities.stream()</div><div>     //        .filter(density -&gt; scale &gt;= density.scale || !args.skipUpscaling)</div><div>     //        .forEach(</div><div>     //            density -&gt; {</div><div>     //              bucketMap.put(</div><div>     //                  density,</div><div>     //                  new Dimension(</div><div>     //                      (int) args.round(baseWidth * density.scale),</div><div>     //                      (int) args.round(baseHeight * density.scale)));</div><div>     //            });</div><div style="background-color:MediumSpringGreen;">     return bucketMap;</div><div>   }</div><div> </div><div>   private static Dimension getHqDimension(File image, Arguments args) throws IOException {</div><div>     Dimension srcDimension = ImageUtil.getImageDimension(image);</div><div>     Dimension hqDimension;</div><div>     if (args.scaleMode == EScaleMode.FACTOR &amp;&amp; args.scale &lt; SVG_UPSCALE_FACTOR) {</div><div>       hqDimension =</div><div>           new Dimension(</div><div>               (int) args.round(SVG_UPSCALE_FACTOR / args.scale * (float) srcDimension.width),</div><div>               (int) args.round(SVG_UPSCALE_FACTOR / args.scale * (float) srcDimension.width));</div><div>     } else if (args.scaleMode == EScaleMode.DP_WIDTH</div><div>         &amp;&amp; (args.scale * SVG_UPSCALE_FACTOR &lt; srcDimension.width)) {</div><div>       float scaleFactor = args.scale / (float) srcDimension.width * SVG_UPSCALE_FACTOR;</div><div>       hqDimension =</div><div>           new Dimension(</div><div>               (int) args.round(scaleFactor * (float) srcDimension.width),</div><div>               (int) args.round(scaleFactor * (float) srcDimension.height));</div><div>     } else if (args.scaleMode == EScaleMode.DP_HEIGHT</div><div>         &amp;&amp; (args.scale * SVG_UPSCALE_FACTOR &lt; srcDimension.height)) {</div><div>       float scaleFactor = args.scale / (float) srcDimension.height * SVG_UPSCALE_FACTOR;</div><div>       hqDimension =</div><div>           new Dimension(</div><div>               (int) args.round(scaleFactor * (float) srcDimension.width),</div><div>               (int) args.round(scaleFactor * (float) srcDimension.height));</div><div>     } else {</div><div>       hqDimension = srcDimension;</div><div>     }</div><div>     return hqDimension;</div><div>   }</div><div> }</div></code></pre></body></html>