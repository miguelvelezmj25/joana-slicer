<html><body><pre><code><div>  /*</div><div>   *  Copyright 2016 Patrick Favre-Bulle</div><div>   *</div><div>   *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</div><div>   *  you may not use this file except in compliance with the License.</div><div>   *  You may obtain a copy of the License at</div><div>   *</div><div>   *      http://www.apache.org/licenses/LICENSE-2.0</div><div>   *</div><div>   * Unless required by applicable law or agreed to in writing, software</div><div>   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</div><div>   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div><div>   * See the License for the specific language governing permissions and</div><div>   * limitations under the License.</div><div>   */</div><div>  </div><div>  package at.favre.tools.dconvert.util;</div><div>  </div><div>  import at.favre.tools.dconvert.arg.Arguments;</div><div>  import at.favre.tools.dconvert.arg.ImageType;</div><div>  import com.twelvemonkeys.imageio.metadata.CompoundDirectory;</div><div>  import com.twelvemonkeys.imageio.metadata.exif.EXIFReader;</div><div>  import com.twelvemonkeys.imageio.metadata.jpeg.JPEG;</div><div>  import com.twelvemonkeys.imageio.metadata.jpeg.JPEGSegment;</div><div>  import com.twelvemonkeys.imageio.metadata.jpeg.JPEGSegmentUtil;</div><div>  </div><div>  import javax.imageio.IIOException;</div><div>  import javax.imageio.ImageIO;</div><div>  import javax.imageio.ImageReadParam;</div><div>  import javax.imageio.ImageReader;</div><div>  import javax.imageio.metadata.IIOMetadata;</div><div>  import javax.imageio.stream.FileImageInputStream;</div><div>  import javax.imageio.stream.ImageInputStream;</div><div>  import java.awt.*;</div><div>  import java.awt.image.BufferedImage;</div><div>  import java.io.File;</div><div>  import java.io.IOException;</div><div>  import java.io.InputStream;</div><div>  import java.util.Iterator;</div><div>  import java.util.List;</div><div>  </div><div>  /** Convert Util class containing all */</div><div>  public final class ImageUtil {</div><div>  </div><div>    private ImageUtil() {}</div><div>  </div><div>    public static LoadedImage loadImage(File input) throws Exception {</div><div>*     if (input == null) {</div><div>*       throw new IllegalArgumentException(&quot;input == null!&quot;);</div><div>      }</div><div>*     if (!input.canRead()) {</div><div>*       throw new IIOException(&quot;Can&#x27;t read input file!&quot;);</div><div>      }</div><div>  </div><div>*     ImageInputStream stream = ImageIO.createImageInputStream(input);</div><div>*     if (stream == null) {</div><div>*       throw new IIOException(&quot;Can&#x27;t create an ImageInputStream!&quot;);</div><div>      }</div><div>*     LoadedImage image = read(stream, Arguments.getImageType(input));</div><div>      if (image.getImage() == null) {</div><div>        stream.close();</div><div>      }</div><div>*     return new LoadedImage(input, image.getImage(), image.getMetadata(), readExif(input));</div><div>    }</div><div>  </div><div>    private static CompoundDirectory readExif(File input) throws IOException {</div><div>*     if (Arguments.getImageType(input) == ImageType.JPG) {</div><div>        try {</div><div>*         ImageInputStream stream = ImageIO.createImageInputStream(input);</div><div>*         List&lt;JPEGSegment&gt; exifSegment = JPEGSegmentUtil.readSegments(stream, JPEG.APP1, &quot;Exif&quot;);</div><div>*         if (!exifSegment.isEmpty()) {</div><div>*           InputStream exifData = exifSegment.get(0).data();</div><div>            exifData.read(); // Skip 0-pad for Exif in JFIF</div><div>*           ImageInputStream exifStream = ImageIO.createImageInputStream(exifData);</div><div>            return (CompoundDirectory) new EXIFReader().read(exifStream);</div><div>          }</div><div>        } catch (Exception e) {</div><div>          System.err.println(&quot;could not read exif&quot;);</div><div>          e.printStackTrace();</div><div>          return null;</div><div>        }</div><div>      }</div><div>      return null;</div><div>    }</div><div>  </div><div>    private static LoadedImage read(ImageInputStream stream, ImageType imageType) throws IOException {</div><div>*     if (stream == null) {</div><div>*       throw new IllegalArgumentException(&quot;stream == null!&quot;);</div><div>      }</div><div>  </div><div>*     Iterator iter = ImageIO.getImageReaders(stream);</div><div>*     if (!iter.hasNext()) {</div><div>*       return null;</div><div>      }</div><div>  </div><div>*     ImageReader reader = (ImageReader) iter.next();</div><div>*     ImageReadParam param = reader.getDefaultReadParam();</div><div>      reader.setInput(stream, true, true);</div><div>      BufferedImage bi;</div><div>      IIOMetadata metadata;</div><div>      try {</div><div>        metadata = reader.getImageMetadata(0);</div><div>*       bi = reader.read(0, param);</div><div>      } finally {</div><div>        reader.dispose();</div><div>        stream.close();</div><div>      }</div><div>  </div><div>*     return new LoadedImage(null, bi, metadata, null);</div><div>    }</div><div>  </div><div>    @Deprecated</div><div>    public static BufferedImage readSvg(File file, Dimension sourceDimension) throws Exception {</div><div>      throw new UnsupportedOperationException(&quot;Java 1.6&quot;);</div><div>      //    try (ImageInputStream input = ImageIO.createImageInputStream(file)) {</div><div>      //      Iterator&lt;ImageReader&gt; readers = ImageIO.getImageReaders(input);</div><div>      //      if (!readers.hasNext()) {</div><div>      //        throw new IllegalArgumentException(&quot;No reader for: &quot; + file);</div><div>      //      }</div><div>      //</div><div>      //      ImageReader reader = readers.next();</div><div>      //      try {</div><div>      //        reader.setInput(input);</div><div>      //        ImageReadParam param = reader.getDefaultReadParam();</div><div>      //        param.setSourceRenderSize(sourceDimension);</div><div>      //        return reader.read(0, param);</div><div>      //      } finally {</div><div>      //        reader.dispose();</div><div>      //      }</div><div>      //    }</div><div>    }</div><div>  </div><div>    /**</div><div>     * Gets image dimensions for given file</div><div>     *</div><div>     * @param imgFile image file</div><div>     * @return dimensions of image</div><div>     * @throws IOException if the file is not a known image</div><div>     */</div><div>    public static Dimension getImageDimension(File imgFile) throws IOException {</div><div>      int pos = imgFile.getName().lastIndexOf(&quot;.&quot;);</div><div>      if (pos == -1) throw new IOException(&quot;No extension for file: &quot; + imgFile.getAbsolutePath());</div><div>      String suffix = imgFile.getName().substring(pos + 1);</div><div>      Iterator&lt;ImageReader&gt; iter = ImageIO.getImageReadersBySuffix(suffix);</div><div>      if (iter.hasNext()) {</div><div>        ImageReader reader = iter.next();</div><div>        try {</div><div>          ImageInputStream stream = new FileImageInputStream(imgFile);</div><div>          reader.setInput(stream);</div><div>          int width = reader.getWidth(reader.getMinIndex());</div><div>          int height = reader.getHeight(reader.getMinIndex());</div><div>          return new Dimension(width, height);</div><div>        } finally {</div><div>          reader.dispose();</div><div>        }</div><div>      }</div><div>  </div><div>      throw new IOException(&quot;Not a known image file: &quot; + imgFile.getAbsolutePath());</div><div>    }</div><div>  }</div></code></pre></body></html>