<html><body><pre><code><div>  /*</div><div>   *  Copyright 2016 Patrick Favre-Bulle</div><div>   *</div><div>   *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</div><div>   *  you may not use this file except in compliance with the License.</div><div>   *  You may obtain a copy of the License at</div><div>   *</div><div>   *      http://www.apache.org/licenses/LICENSE-2.0</div><div>   *</div><div>   * Unless required by applicable law or agreed to in writing, software</div><div>   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</div><div>   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div><div>   * See the License for the specific language governing permissions and</div><div>   * limitations under the License.</div><div>   */</div><div>  </div><div>  package at.favre.tools.dconvert.util;</div><div>  </div><div>  import at.favre.tools.dconvert.arg.ImageType;</div><div>  import at.favre.tools.dconvert.converters.Result;</div><div>  </div><div>  import java.io.BufferedReader;</div><div>  import java.io.File;</div><div>  import java.io.IOException;</div><div>  import java.io.InputStreamReader;</div><div>  import java.util.concurrent.locks.ReentrantLock;</div><div>  </div><div>  /** Util for post processors */</div><div>  public final class PostProcessorUtil {</div><div>    private static final ReentrantLock lock = new ReentrantLock();</div><div>  </div><div>    private PostProcessorUtil() {}</div><div>  </div><div>    public static Result runImageOptimizer(</div><div>        File rawFile, ImageType processedType, String[] args, boolean keepOriginal)</div><div>        throws IOException {</div><div>*     return runImageOptimizer(</div><div>          rawFile, processedType, args, keepOriginal, MiscUtil.getFileExtension(rawFile));</div><div>    }</div><div>  </div><div>    public static Result runImageOptimizer(</div><div>        File rawFile,</div><div>        ImageType processedType,</div><div>        String[] args,</div><div>        boolean keepOriginal,</div><div>        String outExtension)</div><div>        throws IOException {</div><div>      throw new UnsupportedOperationException(&quot;Java 1.6&quot;);</div><div>      //    if (Arguments.getImageType(rawFile) == processedType &amp;&amp; rawFile.exists() &amp;&amp;</div><div>      // rawFile.isFile()) {</div><div>      //      String id = UUID.randomUUID().toString().substring(0, 8);</div><div>      //</div><div>      //      File outFile = getFileWithPostFix(rawFile, &quot;_optimized_&quot; + id, outExtension);</div><div>      //      File copy = getFileWithPostFix(rawFile, &quot;_copy_&quot; + id, outExtension);</div><div>      //</div><div>      //      Files.copy(</div><div>      //          rawFile.toPath(),</div><div>      //          copy.toPath(),</div><div>      //          StandardCopyOption.COPY_ATTRIBUTES,</div><div>      //          StandardCopyOption.REPLACE_EXISTING);</div><div>      //</div><div>      //      for (int i = 0; i &lt; args.length; i++) {</div><div>      //        if (args[i].equals(&quot;%%outFilePath%%&quot;)) {</div><div>      //          args[i] = &quot;\&quot;&quot; + outFile.getAbsolutePath() + &quot;\&quot;&quot;;</div><div>      //        }</div><div>      //</div><div>      //        if (args[i].equals(&quot;%%sourceFilePath%%&quot;)) {</div><div>      //          args[i] = &quot;\&quot;&quot; + copy.getAbsolutePath() + &quot;\&quot;&quot;;</div><div>      //        }</div><div>      //      }</div><div>      //</div><div>      //      Result result = runCmd(args);</div><div>      //</div><div>      //      copy.delete();</div><div>      //</div><div>      //      boolean r1 = true, r2 = true, r3 = true;</div><div>      //      if (outFile.exists() &amp;&amp; outFile.isFile()) {</div><div>      //        if (keepOriginal) {</div><div>      //          File origFile =</div><div>      //              getFileWithPostFix(</div><div>      //                  rawFile, IPostProcessor.ORIG_POSTFIX, MiscUtil.getFileExtension(rawFile));</div><div>      //</div><div>      //          if (origFile.exists()) {</div><div>      //            origFile.delete();</div><div>      //          }</div><div>      //</div><div>      //          r1 = rawFile.renameTo(origFile);</div><div>      //</div><div>      //          File outFileNew = getFileWithPostFix(rawFile, &quot;&quot;, outExtension);</div><div>      //</div><div>      //          if (outFileNew.exists()) {</div><div>      //            outFileNew.delete();</div><div>      //          }</div><div>      //</div><div>      //          r2 = outFile.renameTo(outFileNew);</div><div>      //        } else {</div><div>      //          if (rawFile.delete()) {</div><div>      //            File outFileNew = getFileWithPostFix(rawFile, &quot;&quot;, outExtension);</div><div>      //</div><div>      //            if (outFileNew.exists()) {</div><div>      //              outFileNew.delete();</div><div>      //            }</div><div>      //</div><div>      //            r3 = outFile.renameTo(outFileNew);</div><div>      //          }</div><div>      //        }</div><div>      //      }</div><div>      //      String log = result.log;</div><div>      //      if (!r1 || !r2 || !r3) {</div><div>      //        log += &quot;Could not rename all files correctly\n&quot;;</div><div>      //      }</div><div>      //</div><div>      //      return new Result(log, result.exception, Collections.singletonList(rawFile));</div><div>      //    }</div><div>      //    return null;</div><div>    }</div><div>  </div><div>    private static File getFileWithPostFix(File src, String postfix, String extension) {</div><div>      return new File(</div><div>          src.getParentFile(), MiscUtil.getFileNameWithoutExtension(src) + postfix + &quot;.&quot; + extension);</div><div>    }</div><div>  </div><div>    private static Result runCmd(String[] cmdArray) {</div><div>      throw new UnsupportedOperationException(&quot;Java 1.6&quot;);</div><div>      //    StringBuilder logStringBuilder = new StringBuilder();</div><div>      //    Exception exception = null;</div><div>      //    try {</div><div>      //      logStringBuilder.append(&quot;execute: &quot;).append(Arrays.toString(cmdArray)).append(&quot;\n&quot;);</div><div>      //      ProcessBuilder pb = new ProcessBuilder(cmdArray);</div><div>      //      pb.redirectErrorStream(true);</div><div>      //      Process process = pb.start();</div><div>      //      try (BufferedReader inStreamReader =</div><div>      //          new BufferedReader(new InputStreamReader(process.getInputStream()))) {</div><div>      //        String s;</div><div>      //        while ((s = inStreamReader.readLine()) != null) {</div><div>      //          if (!s.isEmpty()) logStringBuilder.append(&quot;\t&quot;).append(s).append(&quot;\n&quot;);</div><div>      //        }</div><div>      //      }</div><div>      //      process.waitFor();</div><div>      //    } catch (Exception e) {</div><div>      //      exception = e;</div><div>      //      logStringBuilder</div><div>      //          .append(&quot;error: could not run command - &quot;)</div><div>      //          .append(Arrays.toString(cmdArray))</div><div>      //          .append(&quot; - &quot;)</div><div>      //          .append(e.getMessage())</div><div>      //          .append(&quot; - is it set in PATH?\n&quot;);</div><div>      //    }</div><div>      //    return new Result(logStringBuilder.toString(), exception, Collections.emptyList());</div><div>    }</div><div>  </div><div>    public static boolean canRunCmd(String[] cmdArray) {</div><div>      try {</div><div>*       ProcessBuilder pb = new ProcessBuilder(cmdArray);</div><div>*       pb.redirectErrorStream(true);</div><div>*       Process process = pb.start();</div><div>*       BufferedReader inStreamReader =</div><div>*           new BufferedReader(new InputStreamReader(process.getInputStream()));</div><div>*       while ((inStreamReader.readLine()) != null) {}</div><div>        process.waitFor();</div><div>      } catch (Exception e) {</div><div>        return false;</div><div>      }</div><div>*     return true;</div><div>    }</div><div>  }</div></code></pre></body></html>