<html><body><pre><code><div>  /*</div><div>   *  Copyright 2016 Patrick Favre-Bulle</div><div>   *</div><div>   *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</div><div>   *  you may not use this file except in compliance with the License.</div><div>   *  You may obtain a copy of the License at</div><div>   *</div><div>   *      http://www.apache.org/licenses/LICENSE-2.0</div><div>   *</div><div>   * Unless required by applicable law or agreed to in writing, software</div><div>   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</div><div>   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div><div>   * See the License for the specific language governing permissions and</div><div>   * limitations under the License.</div><div>   */</div><div>  </div><div>  package at.favre.tools.dconvert.converters;</div><div>  </div><div>  import at.favre.tools.dconvert.arg.Arguments;</div><div>  import at.favre.tools.dconvert.arg.EScaleMode;</div><div>  import at.favre.tools.dconvert.arg.ImageType;</div><div>  import at.favre.tools.dconvert.converters.descriptors.DensityDescriptor;</div><div>  import at.favre.tools.dconvert.converters.scaling.ImageHandler;</div><div>  import at.favre.tools.dconvert.util.DensityBucketUtil;</div><div>  import at.favre.tools.dconvert.util.ImageUtil;</div><div>  import at.favre.tools.dconvert.util.LoadedImage;</div><div>  import at.favre.tools.dconvert.util.MiscUtil;</div><div>  </div><div>  import java.awt.*;</div><div>  import java.io.File;</div><div>  import java.util.List;</div><div>  import java.util.*;</div><div>  </div><div>  /** The main logic of all platform converters */</div><div>  public abstract class APlatformConverter&lt;T extends DensityDescriptor&gt;</div><div>      implements IPlatformConverter {</div><div>  </div><div>    @Override</div><div>    public Result convert(File srcImage, Arguments args) {</div><div>      try {</div><div>*       File destinationFolder = args.dst;</div><div>*       LoadedImage imageData = ImageUtil.loadImage(srcImage);</div><div>*       String targetImageFileName = MiscUtil.getFileNameWithoutExtension(srcImage);</div><div>*       ImageType imageType = Arguments.getImageType(srcImage);</div><div>        boolean isNinePatch =</div><div>*           AndroidConverter.isNinePatch(srcImage) &amp;&amp; getClass() == AndroidConverter.class;</div><div>*       boolean outputLargerDef = args.scale &lt; Arguments.DEFAULT_SCALE;</div><div>  </div><div>*       StringBuilder log = new StringBuilder();</div><div>*       log.append(getConverterName())</div><div>*           .append(&quot;: &quot;)</div><div>*           .append(targetImageFileName)</div><div>*           .append(&quot; &quot;)</div><div>*           .append(imageData.getImage().getWidth())</div><div>*           .append(&quot;x&quot;)</div><div>*           .append(imageData.getImage().getHeight())</div><div>*           .append(&quot; (&quot;)</div><div>*           .append(args.scale)</div><div>*           .append(args.scaleMode == EScaleMode.FACTOR ? &quot;x&quot; : &quot;dp&quot;)</div><div>*           .append(&quot;)\n&quot;);</div><div>  </div><div>        Map&lt;T, Dimension&gt; densityMap =</div><div>*           DensityBucketUtil.getDensityBuckets(</div><div>*               usedOutputDensities(args),</div><div>*               new Dimension(imageData.getImage().getWidth(), imageData.getImage().getHeight()),</div><div>                args,</div><div>                args.scale,</div><div>                isNinePatch);</div><div>  </div><div>*       File mainSubFolder = createMainSubFolder(destinationFolder, targetImageFileName, args);</div><div>  </div><div>*       onPreExecute(mainSubFolder, targetImageFileName, usedOutputDensities(args), imageType, args);</div><div>  </div><div>*       List&lt;File&gt; allResultingFiles = new ArrayList&lt;File&gt;();</div><div>  </div><div>*       for (Map.Entry&lt;T, Dimension&gt; entry : densityMap.entrySet()) {</div><div>          File dstFolder =</div><div>*             createFolderForOutputFile(</div><div>*                 mainSubFolder, entry.getKey(), entry.getValue(), targetImageFileName, args);</div><div>  </div><div>*         if ((dstFolder.isDirectory() &amp;&amp; dstFolder.exists()) || args.dryRun) {</div><div>*           File imageFile =</div><div>                new File(</div><div>                    dstFolder,</div><div>*                   createDestinationFileNameWithoutExtension(</div><div>*                       entry.getKey(), entry.getValue(), targetImageFileName, args));</div><div>  </div><div>*           log.append(&quot;process &quot;)</div><div>*               .append(imageFile)</div><div>*               .append(&quot; with &quot;)</div><div>*               .append(entry.getValue().width)</div><div>*               .append(&quot;x&quot;)</div><div>*               .append(entry.getValue().height)</div><div>*               .append(&quot; (x&quot;)</div><div>*               .append(entry.getKey().scale)</div><div>*               .append(&quot;) &quot;)</div><div>*               .append(isNinePatch ? &quot;(9-patch)&quot; : &quot;&quot;)</div><div>*               .append(&quot;\n&quot;);</div><div>  </div><div>*           if (!args.dryRun) {</div><div>*             convertImage(</div><div>*                 args, imageData, isNinePatch, log, allResultingFiles, entry.getValue(), imageFile);</div><div>            }</div><div>          } else {</div><div>*           throw new IllegalStateException(&quot;could not create &quot; + dstFolder);</div><div>          }</div><div>        }</div><div>  </div><div>*       if (!args.dryRun &amp;&amp; outputLargerDef) {</div><div>*         outputLargerDef(args, imageData, targetImageFileName, isNinePatch, log, mainSubFolder);</div><div>        }</div><div>  </div><div>        onPostExecute(args);</div><div>  </div><div>        imageData.getImage().flush();</div><div>  </div><div>*       return new Result(log.toString(), allResultingFiles);</div><div>      } catch (Exception e) {</div><div>*       e.printStackTrace();</div><div>*       return new Result(null, e, new ArrayList&lt;File&gt;());</div><div>      }</div><div>    }</div><div>  </div><div>    private void outputLargerDef(</div><div>        Arguments args,</div><div>        LoadedImage imageData,</div><div>        String targetImageFileName,</div><div>        boolean isNinePatch,</div><div>        StringBuilder log,</div><div>        File mainSubFolder)</div><div>        throws Exception {</div><div>*     T descriptor = this.originalOutputDensities();</div><div>      Dimension dimension =</div><div>          new Dimension(imageData.getImage().getWidth(), imageData.getImage().getHeight());</div><div>  </div><div>      File dstFolder =</div><div>*         createFolderForOutputFile(mainSubFolder, descriptor, dimension, targetImageFileName, args);</div><div>*     if ((dstFolder.isDirectory() &amp;&amp; dstFolder.exists()) || args.dryRun) {</div><div>*       File imageFile = new File(dstFolder, imageData.getSourceFile().getName());</div><div>  </div><div>*       log.append(&quot;process &quot;)</div><div>*           .append(imageFile)</div><div>*           .append(&quot; with &quot;)</div><div>*           .append(imageData.getImage().getWidth())</div><div>*           .append(&quot;x&quot;)</div><div>*           .append(imageData.getImage().getHeight())</div><div>*           .append(&quot; (x&quot;)</div><div>*           .append(descriptor.scale)</div><div>*           .append(&quot;) &quot;)</div><div>*           .append(isNinePatch ? &quot;(9-patch)&quot; : &quot;&quot;)</div><div>*           .append(&quot;\n&quot;);</div><div>  </div><div>*       new ImageHandler(args)</div><div>*           .compressJpeg(imageData.getImage(), null, args.compressionQuality, imageFile);</div><div>  </div><div>*       log.append(&quot;compressed to disk: &quot;)</div><div>*           .append(imageFile)</div><div>*           .append(&quot; (&quot;)</div><div>*           .append(String.format(Locale.US, &quot;%.2f&quot;, (float) imageFile.length() / 1024f))</div><div>*           .append(&quot;kB)\n&quot;);</div><div>      } else {</div><div>*       throw new IllegalStateException(&quot;could not create &quot; + dstFolder);</div><div>      }</div><div>    }</div><div>  </div><div>    private void convertImage(</div><div>        Arguments args,</div><div>        LoadedImage imageData,</div><div>        boolean isNinePatch,</div><div>        StringBuilder log,</div><div>        List&lt;File&gt; allResultingFiles,</div><div>        Dimension dimension,</div><div>        File imageFile)</div><div>        throws Exception {</div><div>*     List&lt;File&gt; files =</div><div>*         new ImageHandler(args).saveToFile(imageFile, imageData, dimension, isNinePatch);</div><div>  </div><div>*     allResultingFiles.addAll(files);</div><div>  </div><div>*     for (File file : files) {</div><div>*       log.append(&quot;compressed to disk: &quot;)</div><div>*           .append(file)</div><div>*           .append(&quot; (&quot;)</div><div>*           .append(String.format(Locale.US, &quot;%.2f&quot;, (float) file.length() / 1024f))</div><div>*           .append(&quot;kB)\n&quot;);</div><div>      }</div><div>  </div><div>*     if (files.isEmpty()) {</div><div>*       log.append(&quot;files skipped\n&quot;);</div><div>      }</div><div>    }</div><div>  </div><div>    public abstract List&lt;T&gt; usedOutputDensities(Arguments arguments);</div><div>  </div><div>    public abstract T originalOutputDensities();</div><div>  </div><div>    public abstract String getConverterName();</div><div>  </div><div>    public abstract File createMainSubFolder(</div><div>        File destinationFolder, String targetImageFileName, Arguments arguments);</div><div>  </div><div>    public abstract File createFolderForOutputFile(</div><div>        File mainSubFolder,</div><div>        T density,</div><div>        Dimension dimension,</div><div>        String targetFileName,</div><div>        Arguments arguments);</div><div>  </div><div>    public abstract String createDestinationFileNameWithoutExtension(</div><div>        T density, Dimension dimension, String targetFileName, Arguments arguments);</div><div>  </div><div>    public abstract void onPreExecute(</div><div>        File dstFolder,</div><div>        String targetFileName,</div><div>        List&lt;T&gt; densityDescriptions,</div><div>        ImageType imageType,</div><div>        Arguments arguments)</div><div>        throws Exception;</div><div>  </div><div>    public abstract void onPostExecute(Arguments arguments);</div><div>  }</div></code></pre></body></html>