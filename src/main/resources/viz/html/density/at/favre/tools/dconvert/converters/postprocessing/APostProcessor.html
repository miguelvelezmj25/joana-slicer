<html><body><pre><code><div>  /*</div><div>   *  Copyright 2016 Patrick Favre-Bulle</div><div>   *</div><div>   *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</div><div>   *  you may not use this file except in compliance with the License.</div><div>   *  You may obtain a copy of the License at</div><div>   *</div><div>   *      http://www.apache.org/licenses/LICENSE-2.0</div><div>   *</div><div>   * Unless required by applicable law or agreed to in writing, software</div><div>   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</div><div>   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div><div>   * See the License for the specific language governing permissions and</div><div>   * limitations under the License.</div><div>   */</div><div>  </div><div>  package at.favre.tools.dconvert.converters.postprocessing;</div><div>  </div><div>  import at.favre.tools.dconvert.converters.Result;</div><div>  </div><div>  import java.io.File;</div><div>  import java.util.Map;</div><div>  import java.util.concurrent.ConcurrentHashMap;</div><div>  import java.util.concurrent.locks.ReentrantLock;</div><div>  </div><div>  /**</div><div>   * Shared code among {@link IPostProcessor}.</div><div>   *</div><div>   * &lt;p&gt;This helps to synchronize processors: will create a lock for each input file, so that only 1</div><div>   * processor can process a file at a time</div><div>   */</div><div>  public abstract class APostProcessor implements IPostProcessor {</div><div>    private static final Map&lt;File, ReentrantLock&gt; lockMap = new ConcurrentHashMap&lt;File, ReentrantLock&gt;();</div><div>    private static final ReentrantLock administrationLock = new ReentrantLock(true);</div><div>  </div><div>    @Override</div><div>    public Result process(File rawFile, boolean keepOriginal) {</div><div>      try {</div><div>  </div><div>*       administrationLock.lock();</div><div>*       if (!lockMap.containsKey(rawFile)) {</div><div>*         lockMap.put(rawFile, new ReentrantLock(true));</div><div>        }</div><div>  </div><div>*       administrationLock.unlock();</div><div>  </div><div>*       lockMap.get(rawFile).lock();</div><div>  </div><div>*       return synchronizedProcess(rawFile, keepOriginal);</div><div>      } finally {</div><div>*       lockMap.get(rawFile).unlock();</div><div>      }</div><div>    }</div><div>  </div><div>    /**</div><div>     * This is the thread safe version of {@link #process(File, boolean)}</div><div>     *</div><div>     * @param rawFile</div><div>     * @param keepOriginal</div><div>     * @return</div><div>     */</div><div>    protected abstract Result synchronizedProcess(File rawFile, boolean keepOriginal);</div><div>  }</div></code></pre></body></html>