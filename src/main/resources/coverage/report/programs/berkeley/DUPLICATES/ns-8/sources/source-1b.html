


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > Environment</title>
  <style type="text/css">
    @import "../../.css/coverage.css";
    @import "../../.css/highlight-idea.css";
  </style>
  <script type="text/javascript" src="../../.js/highlight.pack.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.sleepycat.je</a>
</div>

<h1>Coverage Summary for Class: Environment (com.sleepycat.je)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">Environment</td>
<td class="coverageStat">
  <span class="percent">
    37.7%
  </span>
  <span class="absValue">
    (23/61)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    25.8%
  </span>
  <span class="absValue">
    (131/508)
  </span>
</td>
</tr>
  <tr>
    <td class="name">Environment$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Environment$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Environment$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Environment$DbNameOperation</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/25)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    31.1%
  </span>
  <span class="absValue">
    (23/74)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    23.9%
  </span>
  <span class="absValue">
    (131/548)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<div class="sourceCode" id="sourceCode"><i class="no-highlight">1</i>&nbsp;/*-
<i class="no-highlight">2</i>&nbsp; * Copyright (C) 2002, 2017, Oracle and/or its affiliates. All rights reserved.
<i class="no-highlight">3</i>&nbsp; *
<i class="no-highlight">4</i>&nbsp; * This file was distributed by Oracle as part of a version of Oracle Berkeley
<i class="no-highlight">5</i>&nbsp; * DB Java Edition made available at:
<i class="no-highlight">6</i>&nbsp; *
<i class="no-highlight">7</i>&nbsp; * http://www.oracle.com/technetwork/database/database-technologies/berkeleydb/downloads/index.html
<i class="no-highlight">8</i>&nbsp; *
<i class="no-highlight">9</i>&nbsp; * Please see the LICENSE file included in the top-level directory of the
<i class="no-highlight">10</i>&nbsp; * appropriate version of Oracle Berkeley DB Java Edition for a copy of the
<i class="no-highlight">11</i>&nbsp; * license and additional information.
<i class="no-highlight">12</i>&nbsp; */
<i class="no-highlight">13</i>&nbsp;
<i class="no-highlight">14</i>&nbsp;package com.sleepycat.je;
<i class="no-highlight">15</i>&nbsp;
<i class="no-highlight">16</i>&nbsp;import java.io.Closeable;
<i class="no-highlight">17</i>&nbsp;import java.io.File;
<i class="no-highlight">18</i>&nbsp;import java.io.PrintStream;
<i class="no-highlight">19</i>&nbsp;import java.util.List;
<i class="no-highlight">20</i>&nbsp;import java.util.Map;
<i class="no-highlight">21</i>&nbsp;import java.util.concurrent.ConcurrentHashMap;
<i class="no-highlight">22</i>&nbsp;import java.util.concurrent.atomic.AtomicReference;
<i class="no-highlight">23</i>&nbsp;import java.util.logging.Level;
<i class="no-highlight">24</i>&nbsp;import javax.transaction.xa.Xid;
<i class="no-highlight">25</i>&nbsp;
<i class="no-highlight">26</i>&nbsp;import com.sleepycat.je.Durability.ReplicaAckPolicy;
<i class="no-highlight">27</i>&nbsp;import com.sleepycat.je.dbi.DatabaseImpl;
<i class="no-highlight">28</i>&nbsp;import com.sleepycat.je.dbi.DbConfigManager;
<i class="no-highlight">29</i>&nbsp;import com.sleepycat.je.dbi.DbEnvPool;
<i class="no-highlight">30</i>&nbsp;import com.sleepycat.je.dbi.DbTree;
<i class="no-highlight">31</i>&nbsp;import com.sleepycat.je.dbi.DbTree.TruncateDbResult;
<i class="no-highlight">32</i>&nbsp;import com.sleepycat.je.dbi.EnvironmentImpl;
<i class="no-highlight">33</i>&nbsp;import com.sleepycat.je.dbi.RepConfigProxy;
<i class="no-highlight">34</i>&nbsp;import com.sleepycat.je.dbi.StartupTracker.Phase;
<i class="no-highlight">35</i>&nbsp;import com.sleepycat.je.dbi.TriggerManager;
<i class="no-highlight">36</i>&nbsp;import com.sleepycat.je.txn.HandleLocker;
<i class="no-highlight">37</i>&nbsp;import com.sleepycat.je.txn.Locker;
<i class="no-highlight">38</i>&nbsp;import com.sleepycat.je.txn.LockerFactory;
<i class="no-highlight">39</i>&nbsp;import com.sleepycat.je.txn.Txn;
<i class="no-highlight">40</i>&nbsp;import com.sleepycat.je.utilint.DatabaseUtil;
<i class="no-highlight">41</i>&nbsp;import com.sleepycat.je.utilint.LoggerUtils;
<i class="no-highlight">42</i>&nbsp;import com.sleepycat.je.utilint.Pair;
<i class="no-highlight">43</i>&nbsp;
<i class="no-highlight">44</i>&nbsp;/**
<i class="no-highlight">45</i>&nbsp; * A database environment.  Environments include support for some or all of
<i class="no-highlight">46</i>&nbsp; * caching, locking, logging and transactions.
<i class="no-highlight">47</i>&nbsp; *
<i class="no-highlight">48</i>&nbsp; * &lt;p&gt;To open an existing environment with default attributes the application
<i class="no-highlight">49</i>&nbsp; * may use a default environment configuration object or null:
<i class="no-highlight">50</i>&nbsp; * &lt;blockquote&gt;
<i class="no-highlight">51</i>&nbsp; *     &lt;pre&gt;
<i class="no-highlight">52</i>&nbsp; *      // Open an environment handle with default attributes.
<i class="no-highlight">53</i>&nbsp; *     Environment env = new Environment(home, new EnvironmentConfig());
<i class="no-highlight">54</i>&nbsp; *     &lt;/pre&gt;
<i class="no-highlight">55</i>&nbsp; * &lt;/blockquote&gt;
<i class="no-highlight">56</i>&nbsp; * or
<i class="no-highlight">57</i>&nbsp; * &lt;blockquote&gt;&lt;pre&gt;
<i class="no-highlight">58</i>&nbsp; *     Environment env = new Environment(home, null);
<i class="no-highlight">59</i>&nbsp; * &lt;/pre&gt;&lt;/blockquote&gt;
<i class="no-highlight">60</i>&nbsp; * &lt;p&gt;Note that many Environment objects may access a single environment.&lt;/p&gt;
<i class="no-highlight">61</i>&nbsp; * &lt;p&gt;To create an environment or customize attributes, the application should
<i class="no-highlight">62</i>&nbsp; * customize the configuration class. For example:&lt;/p&gt;
<i class="no-highlight">63</i>&nbsp; * &lt;blockquote&gt;&lt;pre&gt;
<i class="no-highlight">64</i>&nbsp; *     EnvironmentConfig envConfig = new EnvironmentConfig();
<i class="no-highlight">65</i>&nbsp; *     envConfig.setTransactional(true);
<i class="no-highlight">66</i>&nbsp; *     envConfig.setAllowCreate(true);
<i class="no-highlight">67</i>&nbsp; *     envConfig.setCacheSize(1000000);
<i class="no-highlight">68</i>&nbsp; *     Environment newlyCreatedEnv = new Environment(home, envConfig);
<i class="no-highlight">69</i>&nbsp; * &lt;/pre&gt;&lt;/blockquote&gt;
<i class="no-highlight">70</i>&nbsp; *
<i class="no-highlight">71</i>&nbsp; * &lt;p&gt;Note that environment configuration parameters can also be set through
<i class="no-highlight">72</i>&nbsp; * the &amp;lt;environment home&amp;gt;/je.properties file. This file takes precedence
<i class="no-highlight">73</i>&nbsp; * over any programmatically specified configuration parameters so that
<i class="no-highlight">74</i>&nbsp; * configuration changes can be made without recompiling. Environment
<i class="no-highlight">75</i>&nbsp; * configuration follows this order of precedence:&lt;/p&gt;
<i class="no-highlight">76</i>&nbsp; *
<i class="no-highlight">77</i>&nbsp; * &lt;ol&gt;
<i class="no-highlight">78</i>&nbsp; * &lt;li&gt;Configuration parameters specified in
<i class="no-highlight">79</i>&nbsp; * &amp;lt;environment home&amp;gt;/je.properties take first precedence.
<i class="no-highlight">80</i>&nbsp; * &lt;li&gt; Configuration parameters set in the EnvironmentConfig object used at
<i class="no-highlight">81</i>&nbsp; * Environment construction e   tameters not set by the application are set to
<i class="no-highlight">82</i>&nbsp; * system defaults, described along with the parameter name String constants
<i class="no-highlight">83</i>&nbsp; * in the EnvironmentConfig class.
<i class="no-highlight">84</i>&nbsp; * &lt;/ol&gt;
<i class="no-highlight">85</i>&nbsp; *
<i class="no-highlight">86</i>&nbsp; * &lt;p&gt;An &lt;em&gt;environment handle&lt;/em&gt; is an Environment instance.  More than one
<i class="no-highlight">87</i>&nbsp; * Environment instance may be created for the same physical directory, which
<i class="no-highlight">88</i>&nbsp; * is the same as saying that more than one Environment handle may be open at
<i class="no-highlight">89</i>&nbsp; * one time for a given environment.&lt;/p&gt;
<i class="no-highlight">90</i>&nbsp; *
<i class="no-highlight">91</i>&nbsp; * The Environment handle should not be closed while any other handle remains
<i class="no-highlight">92</i>&nbsp; * open that is using it as a reference (for example, {@link
<i class="no-highlight">93</i>&nbsp; * Database Database} or {@link com.sleepycat.je.Transaction
<i class="no-highlight">94</i>&nbsp; * Transaction}.  Once {@link Environment#close
<i class="no-highlight">95</i>&nbsp; * Environment.close} is called, this object may not be accessed again.
<i class="no-highlight">96</i>&nbsp; */
<b class="fc"><i class="no-highlight">97</i>&nbsp;public class Environment implements Closeable {</b>
<i class="no-highlight">98</i>&nbsp;
<i class="no-highlight">99</i>&nbsp;    /**
<i class="no-highlight">100</i>&nbsp;     * envImpl is a reference to the shared underlying environment.
<i class="no-highlight">101</i>&nbsp;     *
<i class="no-highlight">102</i>&nbsp;     * The envImpl field is set to null during close to avoid OOME. It
<i class="no-highlight">103</i>&nbsp;     * should normally only be accessed via the checkOpen and
<i class="no-highlight">104</i>&nbsp;     * getNonNullEnvImpl methods. During close, while synchronized, it is safe
<i class="no-highlight">105</i>&nbsp;     * to access it directly.
<i class="no-highlight">106</i>&nbsp;     */
<i class="no-highlight">107</i>&nbsp;    private volatile EnvironmentImpl environmentImpl;
<i class="no-highlight">108</i>&nbsp;
<i class="no-highlight">109</i>&nbsp;    /*
<i class="no-highlight">110</i>&nbsp;     * If the env was invalided (even if the env is now closed) this contains
<i class="no-highlight">111</i>&nbsp;     * the first EFE that invalidated it. Contains null if the env was not
<i class="no-highlight">112</i>&nbsp;     * invalidated.
<i class="no-highlight">113</i>&nbsp;     *
<i class="no-highlight">114</i>&nbsp;     * This reference is shared with EnvironmentImpl, to allow the invalidating
<i class="no-highlight">115</i>&nbsp;     * exception to be returned after close, when environmentImpl is null.
<i class="no-highlight">116</i>&nbsp;     * The EFE does not reference the EnvironmentImpl, so GC is not effected.
<i class="no-highlight">117</i>&nbsp;     *
<i class="no-highlight">118</i>&nbsp;     * This field cannot be declared as final because it is initialized by
<i class="no-highlight">119</i>&nbsp;     * methods called by the ctor. However, after construction it is non-null
<i class="no-highlight">120</i>&nbsp;     * and should be treated as final.
<i class="no-highlight">121</i>&nbsp;     */
<i class="no-highlight">122</i>&nbsp;    private AtomicReference&lt;EnvironmentFailureException&gt; invalidatingEFE;
<i class="no-highlight">123</i>&nbsp;
<i class="no-highlight">124</i>&nbsp;    private TransactionConfig defaultTxnConfig;
<i class="no-highlight">125</i>&nbsp;    private EnvironmentMutableConfig handleConfig;
<i class="no-highlight">126</i>&nbsp;    private final EnvironmentConfig appliedFinalConfig;
<i class="no-highlight">127</i>&nbsp;
<i class="no-highlight">128</i>&nbsp;    private final Map&lt;Database, Database&gt; referringDbs;
<i class="no-highlight">129</i>&nbsp;    private final Map&lt;Transaction, Transaction&gt; referringDbTxns;
<i class="no-highlight">130</i>&nbsp;
<i class="no-highlight">131</i>&nbsp;    /**
<i class="no-highlight">132</i>&nbsp;     * @hidden
<i class="no-highlight">133</i>&nbsp;     * The name of the cleaner daemon thread.  This constant is passed to an
<i class="no-highlight">134</i>&nbsp;     * ExceptionEvent&#39;s threadName argument when an exception is thrown in the
<i class="no-highlight">135</i>&nbsp;     * cleaner daemon thread.
<i class="no-highlight">136</i>&nbsp;     */
<i class="no-highlight">137</i>&nbsp;    public static final String CLEANER_NAME = &quot;Cleaner&quot;;
<i class="no-highlight">138</i>&nbsp;
<i class="no-highlight">139</i>&nbsp;    /**
<i class="no-highlight">140</i>&nbsp;     * @hidden
<i class="no-highlight">141</i>&nbsp;     * The name of the IN Compressor daemon thread.  This constant is passed to
<i class="no-highlight">142</i>&nbsp;     * an ExceptionEvent&#39;s threadName argument when an exception is thrown in
<i class="no-highlight">143</i>&nbsp;     * the IN Compressor daemon thread.
<i class="no-highlight">144</i>&nbsp;     */
<i class="no-highlight">145</i>&nbsp;    public static final String INCOMP_NAME = &quot;INCompressor&quot;;
<i class="no-highlight">146</i>&nbsp;
<i class="no-highlight">147</i>&nbsp;    /**
<i class="no-highlight">148</i>&nbsp;     * @hidden
<i class="no-highlight">149</i>&nbsp;     * The name of the Checkpointer daemon thread.  This constant is passed to
<i class="no-highlight">150</i>&nbsp;     * an ExceptionEvent&#39;s threadName argument when an exception is thrown in
<i class="no-highlight">151</i>&nbsp;     * the Checkpointer daemon thread.
<i class="no-highlight">152</i>&nbsp;     */
<i class="no-highlight">153</i>&nbsp;    public static final String CHECKPOINTER_NAME = &quot;Checkpointer&quot;;
<i class="no-highlight">154</i>&nbsp;
<i class="no-highlight">155</i>&nbsp;    /**
<i class="no-highlight">156</i>&nbsp;     * @hidden
<i class="no-highlight">157</i>&nbsp;     * The name of the StatCapture daemon thread.  This constant is passed to
<i class="no-highlight">158</i>&nbsp;     * an ExceptionEvent&#39;s threadName argument when an exception is thrown in
<i class="no-highlight">159</i>&nbsp;     * the StatCapture daemon thread.
<i class="no-highlight">160</i>&nbsp;     */
<i class="no-highlight">161</i>&nbsp;    public static final String STATCAPTURE_NAME = &quot;StatCapture&quot;;
<i class="no-highlight">162</i>&nbsp;
<i class="no-highlight">163</i>&nbsp;    /**
<i class="no-highlight">164</i>&nbsp;     * @hidden
<i class="no-highlight">165</i>&nbsp;     * The name of the log flusher daemon thread.
<i class="no-highlight">166</i>&nbsp;     */
<i class="no-highlight">167</i>&nbsp;    public static final String LOG_FLUSHER_NAME = &quot;LogFlusher&quot;;
<i class="no-highlight">168</i>&nbsp;
<i class="no-highlight">169</i>&nbsp;    /**
<i class="no-highlight">170</i>&nbsp;     * @hidden
<i class="no-highlight">171</i>&nbsp;     * The name of the deletion detector daemon thread.
<i class="no-highlight">172</i>&nbsp;     */
<i class="no-highlight">173</i>&nbsp;    public static final String FILE_DELETION_DETECTOR_NAME =
<i class="no-highlight">174</i>&nbsp;        &quot;FileDeletionDetector&quot;;
<i class="no-highlight">175</i>&nbsp;
<i class="no-highlight">176</i>&nbsp;    /**
<i class="no-highlight">177</i>&nbsp;     * @hidden
<i class="no-highlight">178</i>&nbsp;     * The name of the data corruption verifier daemon thread.
<i class="no-highlight">179</i>&nbsp;     */
<i class="no-highlight">180</i>&nbsp;    public static final String DATA_CORRUPTION_VERIFIER_NAME =
<i class="no-highlight">181</i>&nbsp;        &quot;DataCorruptionVerifier&quot;;
<i class="no-highlight">182</i>&nbsp;
<i class="no-highlight">183</i>&nbsp;    /**
<i class="no-highlight">184</i>&nbsp;     * Creates a database environment handle.
<i class="no-highlight">185</i>&nbsp;     *
<i class="no-highlight">186</i>&nbsp;     * @param envHome The database environment&#39;s home directory.
<i class="no-highlight">187</i>&nbsp;     *
<i class="no-highlight">188</i>&nbsp;     * @param configuration The database environment attributes.  If null,
<i class="no-highlight">189</i>&nbsp;     * default attributes are used.
<i class="no-highlight">190</i>&nbsp;     *
<i class="no-highlight">191</i>&nbsp;     * @throws EnvironmentNotFoundException if the environment does not exist
<i class="no-highlight">192</i>&nbsp;     * (does not contain at least one log file) and the {@code
<i class="no-highlight">193</i>&nbsp;     * EnvironmentConfig AllowCreate} parameter is false.
<i class="no-highlight">194</i>&nbsp;     *
<i class="no-highlight">195</i>&nbsp;     * @throws EnvironmentLockedException when an environment cannot be opened
<i class="no-highlight">196</i>&nbsp;     * for write access because another process has the same environment open
<i class="no-highlight">197</i>&nbsp;     * for write access.  &lt;strong&gt;Warning:&lt;/strong&gt; This exception should be
<i class="no-highlight">198</i>&nbsp;     * handled when an environment is opened by more than one process.
<i class="no-highlight">199</i>&nbsp;     *
<i class="no-highlight">200</i>&nbsp;     * @throws VersionMismatchException when the existing log is not compatible
<i class="no-highlight">201</i>&nbsp;     * with the version of JE that is running.  This occurs when a later
<i class="no-highlight">202</i>&nbsp;     * version of JE was used to create the log.  &lt;strong&gt;Warning:&lt;/strong&gt;
<i class="no-highlight">203</i>&nbsp;     * This exception should be handled when more than one version of JE may be
<i class="no-highlight">204</i>&nbsp;     * used to access an environment.
<i class="no-highlight">205</i>&nbsp;     *
<i class="no-highlight">206</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">207</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">208</i>&nbsp;     *
<i class="no-highlight">209</i>&nbsp;     * @throws UnsupportedOperationException if this environment was previously
<i class="no-highlight">210</i>&nbsp;     * opened for replication and is not being opened read-only.
<i class="no-highlight">211</i>&nbsp;     *
<i class="no-highlight">212</i>&nbsp;     * @throws IllegalArgumentException if an invalid parameter is specified,
<i class="no-highlight">213</i>&nbsp;     * for example, an invalid {@code EnvironmentConfig} parameter.
<i class="no-highlight">214</i>&nbsp;     */
<i class="no-highlight">215</i>&nbsp;    public Environment(File envHome, EnvironmentConfig configuration)
<i class="no-highlight">216</i>&nbsp;        throws EnvironmentNotFoundException,
<i class="no-highlight">217</i>&nbsp;               EnvironmentLockedException,
<i class="no-highlight">218</i>&nbsp;               VersionMismatchException,
<i class="no-highlight">219</i>&nbsp;               DatabaseException,
<i class="no-highlight">220</i>&nbsp;               IllegalArgumentException {
<i class="no-highlight">221</i>&nbsp;
<b class="fc"><i class="no-highlight">222</i>&nbsp;        this(envHome, configuration, null /*repConfigProxy*/,</b>
<i class="no-highlight">223</i>&nbsp;             null /*envImplParam*/);
<b class="fc"><i class="no-highlight">224</i>&nbsp;    }</b>
<i class="no-highlight">225</i>&nbsp;
<i class="no-highlight">226</i>&nbsp;    /**
<i class="no-highlight">227</i>&nbsp;     * @hidden
<i class="no-highlight">228</i>&nbsp;     * Internal common constructor.
<i class="no-highlight">229</i>&nbsp;     *
<i class="no-highlight">230</i>&nbsp;     * @param envImpl is non-null only when used by EnvironmentImpl to
<i class="no-highlight">231</i>&nbsp;     * create an InternalEnvironment.
<i class="no-highlight">232</i>&nbsp;     */
<i class="no-highlight">233</i>&nbsp;    protected Environment(File envHome,
<i class="no-highlight">234</i>&nbsp;                          EnvironmentConfig envConfig,
<i class="no-highlight">235</i>&nbsp;                          RepConfigProxy repConfigProxy,
<b class="fc"><i class="no-highlight">236</i>&nbsp;                          EnvironmentImpl envImpl) {</b>
<i class="no-highlight">237</i>&nbsp;
<b class="fc"><i class="no-highlight">238</i>&nbsp;        referringDbs = new ConcurrentHashMap&lt;Database, Database&gt;();</b>
<b class="fc"><i class="no-highlight">239</i>&nbsp;        referringDbTxns = new ConcurrentHashMap&lt;Transaction, Transaction&gt;();</b>
<i class="no-highlight">240</i>&nbsp;
<b class="fc"><i class="no-highlight">241</i>&nbsp;        DatabaseUtil.checkForNullParam(envHome, &quot;envHome&quot;);</b>
<i class="no-highlight">242</i>&nbsp;
<b class="fc"><i class="no-highlight">243</i>&nbsp;        appliedFinalConfig =</b>
<b class="fc"><i class="no-highlight">244</i>&nbsp;            setupHandleConfig(envHome, envConfig, repConfigProxy);</b>
<i class="no-highlight">245</i>&nbsp;
<b class="fc"><i class="no-highlight">246</i>&nbsp;        if (envImpl != null) {</b>
<i class="no-highlight">247</i>&nbsp;            /* We&#39;re creating an InternalEnvironment in EnvironmentImpl. */
<b class="fc"><i class="no-highlight">248</i>&nbsp;            environmentImpl = envImpl;</b>
<i class="no-highlight">249</i>&nbsp;        } else {
<i class="no-highlight">250</i>&nbsp;            /* Open a new or existing environment in the shared pool. */
<b class="fc"><i class="no-highlight">251</i>&nbsp;            environmentImpl =</b>
<b class="fc"><i class="no-highlight">252</i>&nbsp;                makeEnvironmentImpl(envHome, envConfig, repConfigProxy);</b>
<i class="no-highlight">253</i>&nbsp;        }
<b class="fc"><i class="no-highlight">254</i>&nbsp;    }</b>
<i class="no-highlight">255</i>&nbsp;
<i class="no-highlight">256</i>&nbsp;    /**
<i class="no-highlight">257</i>&nbsp;     * @hidden
<i class="no-highlight">258</i>&nbsp;     * makeEnvironmentImpl() is called both by the Environment constructor and
<i class="no-highlight">259</i>&nbsp;     * by the ReplicatedEnvironment constructor when recreating the environment
<i class="no-highlight">260</i>&nbsp;     * for a hard recovery.
<i class="no-highlight">261</i>&nbsp;     */
<i class="no-highlight">262</i>&nbsp;    protected EnvironmentImpl makeEnvironmentImpl(
<i class="no-highlight">263</i>&nbsp;        File envHome,
<i class="no-highlight">264</i>&nbsp;        EnvironmentConfig envConfig,
<i class="no-highlight">265</i>&nbsp;        RepConfigProxy repConfigProxy) {
<i class="no-highlight">266</i>&nbsp;
<b class="fc"><i class="no-highlight">267</i>&nbsp;        environmentImpl = DbEnvPool.getInstance().getEnvironment(</b>
<i class="no-highlight">268</i>&nbsp;            envHome,
<i class="no-highlight">269</i>&nbsp;            appliedFinalConfig,
<i class="no-highlight">270</i>&nbsp;            envConfig != null /*checkImmutableParams*/,
<b class="fc"><i class="no-highlight">271</i>&nbsp;            setupRepConfig(envHome, repConfigProxy, envConfig));</b>
<i class="no-highlight">272</i>&nbsp;
<b class="fc"><i class="no-highlight">273</i>&nbsp;        environmentImpl.registerMBean(this);</b>
<i class="no-highlight">274</i>&nbsp;
<b class="fc"><i class="no-highlight">275</i>&nbsp;        invalidatingEFE = environmentImpl.getInvalidatingExceptionReference();</b>
<i class="no-highlight">276</i>&nbsp;
<b class="fc"><i class="no-highlight">277</i>&nbsp;        return environmentImpl;</b>
<i class="no-highlight">278</i>&nbsp;    }
<i class="no-highlight">279</i>&nbsp;
<i class="no-highlight">280</i>&nbsp;    /**
<i class="no-highlight">281</i>&nbsp;     * Validate the parameters specified in the environment config.  Applies
<i class="no-highlight">282</i>&nbsp;     * the configurations specified in the je.properties file to override any
<i class="no-highlight">283</i>&nbsp;     * programmatically set configurations.  Create a copy to save in this
<i class="no-highlight">284</i>&nbsp;     * handle. The main reason to return a config instead of using the
<i class="no-highlight">285</i>&nbsp;     * handleConfig field is to return an EnvironmentConfig instead of a
<i class="no-highlight">286</i>&nbsp;     * EnvironmentMutableConfig.
<i class="no-highlight">287</i>&nbsp;     */
<i class="no-highlight">288</i>&nbsp;    private EnvironmentConfig setupHandleConfig(File envHome,
<i class="no-highlight">289</i>&nbsp;                                                EnvironmentConfig envConfig,
<i class="no-highlight">290</i>&nbsp;                                                RepConfigProxy repConfig)
<i class="no-highlight">291</i>&nbsp;        throws IllegalArgumentException {
<i class="no-highlight">292</i>&nbsp;
<i class="no-highlight">293</i>&nbsp;        /* If the user specified a null object, use the default */
<b class="fc"><i class="no-highlight">294</i>&nbsp;        EnvironmentConfig baseConfig = (envConfig == null) ?</b>
<i class="no-highlight">295</i>&nbsp;            EnvironmentConfig.DEFAULT : envConfig;
<i class="no-highlight">296</i>&nbsp;
<i class="no-highlight">297</i>&nbsp;        /* Make a copy, apply je.properties, and init the handle config. */
<b class="fc"><i class="no-highlight">298</i>&nbsp;        EnvironmentConfig useConfig = baseConfig.clone();</b>
<i class="no-highlight">299</i>&nbsp;
<i class="no-highlight">300</i>&nbsp;        /* Apply the je.properties file. */
<b class="fc"><i class="no-highlight">301</i>&nbsp;        if (useConfig.getLoadPropertyFile()) {</b>
<b class="fc"><i class="no-highlight">302</i>&nbsp;            DbConfigManager.applyFileConfig(envHome,</b>
<b class="fc"><i class="no-highlight">303</i>&nbsp;                                            DbInternal.getProps(useConfig),</b>
<i class="no-highlight">304</i>&nbsp;                                            false);       // forReplication
<i class="no-highlight">305</i>&nbsp;        }
<b class="fc"><i class="no-highlight">306</i>&nbsp;        copyToHandleConfig(useConfig, useConfig, repConfig);</b>
<b class="fc"><i class="no-highlight">307</i>&nbsp;        return useConfig;</b>
<i class="no-highlight">308</i>&nbsp;    }
<i class="no-highlight">309</i>&nbsp;
<i class="no-highlight">310</i>&nbsp;    /**
<i class="no-highlight">311</i>&nbsp;     * @hidden
<i class="no-highlight">312</i>&nbsp;     * Obtain a validated replication configuration. In a non-HA environment,
<i class="no-highlight">313</i>&nbsp;     * return null.
<i class="no-highlight">314</i>&nbsp;     */
<i class="no-highlight">315</i>&nbsp;    protected RepConfigProxy
<i class="no-highlight">316</i>&nbsp;        setupRepConfig(final File envHome,
<i class="no-highlight">317</i>&nbsp;                       final RepConfigProxy repConfigProxy,
<i class="no-highlight">318</i>&nbsp;                       final EnvironmentConfig envConfig) {
<i class="no-highlight">319</i>&nbsp;
<b class="fc"><i class="no-highlight">320</i>&nbsp;        return null;</b>
<i class="no-highlight">321</i>&nbsp;    }
<i class="no-highlight">322</i>&nbsp;
<i class="no-highlight">323</i>&nbsp;    /**
<i class="no-highlight">324</i>&nbsp;     * The Environment.close method closes the Berkeley DB environment.
<i class="no-highlight">325</i>&nbsp;     *
<i class="no-highlight">326</i>&nbsp;     * &lt;p&gt;When the last environment handle is closed, allocated resources are
<i class="no-highlight">327</i>&nbsp;     * freed, and daemon threads are stopped, even if they are performing work.
<i class="no-highlight">328</i>&nbsp;     * For example, if the cleaner is still cleaning the log, it will be
<i class="no-highlight">329</i>&nbsp;     * stopped at the next reasonable opportunity and perform no more cleaning
<i class="no-highlight">330</i>&nbsp;     * operations. After stopping background threads, a final checkpoint is
<i class="no-highlight">331</i>&nbsp;     * performed by this method, in order to reduce the time to recover the
<i class="no-highlight">332</i>&nbsp;     * next time the environment is opened.&lt;/p&gt;
<i class="no-highlight">333</i>&nbsp;     *
<i class="no-highlight">334</i>&nbsp;     * &lt;p&gt;When minimizing recovery time is desired, it is often useful to stop
<i class="no-highlight">335</i>&nbsp;     * all application activity and perform an additional checkpoint prior to
<i class="no-highlight">336</i>&nbsp;     * calling {@code close}. This additional checkpoint will write most of
<i class="no-highlight">337</i>&nbsp;     * dirty Btree information, so that that the final checkpoint is very
<i class="no-highlight">338</i>&nbsp;     * small (and recovery is fast). To ensure that recovery time is minimized,
<i class="no-highlight">339</i>&nbsp;     * the log cleaner threads should also be stopped prior to the extra
<i class="no-highlight">340</i>&nbsp;     * checkpoint. This prevents log cleaning from dirtying the Btree, which
<i class="no-highlight">341</i>&nbsp;     * can make the final checkpoint larger (and recovery time longer). The
<i class="no-highlight">342</i>&nbsp;     * recommended procedure for minimizing recovery time is:&lt;/p&gt;
<i class="no-highlight">343</i>&nbsp;     *
<i class="no-highlight">344</i>&nbsp;     * &lt;pre&gt;
<i class="no-highlight">345</i>&nbsp;     *     // Stop/finish all application operations that are using JE.
<i class="no-highlight">346</i>&nbsp;     *     ...
<i class="no-highlight">347</i>&nbsp;     *
<i class="no-highlight">348</i>&nbsp;     *     // Stop the cleaner daemon threads.
<i class="no-highlight">349</i>&nbsp;     *     EnvironmentMutableConfig config = env.getMutableConfig();
<i class="no-highlight">350</i>&nbsp;     *     config.setConfigParam(EnvironmentConfig.ENV_RUN_CLEANER, &quot;false&quot;);
<i class="no-highlight">351</i>&nbsp;     *     env.setMutableConfig(config);
<i class="no-highlight">352</i>&nbsp;     *
<i class="no-highlight">353</i>&nbsp;     *     // Perform an extra checkpoint
<i class="no-highlight">354</i>&nbsp;     *     env.checkpoint(new CheckpointConfig().setForce(true));
<i class="no-highlight">355</i>&nbsp;     *
<i class="no-highlight">356</i>&nbsp;     *     // Finally, close the environment.
<i class="no-highlight">357</i>&nbsp;     *     env.close();
<i class="no-highlight">358</i>&nbsp;     * &lt;/pre&gt;
<i class="no-highlight">359</i>&nbsp;     *
<i class="no-highlight">360</i>&nbsp;     * &lt;p&gt;The Environment handle should not be closed while any other handle
<i class="no-highlight">361</i>&nbsp;     * that refers to it is not yet closed; for example, database environment
<i class="no-highlight">362</i>&nbsp;     * handles must not be closed while database handles remain open, or
<i class="no-highlight">363</i>&nbsp;     * transactions in the environment have not yet committed or aborted.
<i class="no-highlight">364</i>&nbsp;     * Specifically, this includes {@link Database Database},
<i class="no-highlight">365</i>&nbsp;     * and {@link com.sleepycat.je.Transaction Transaction} handles.&lt;/p&gt;
<i class="no-highlight">366</i>&nbsp;     *
<i class="no-highlight">367</i>&nbsp;     * &lt;p&gt;If this handle has already been closed, this method does nothing and
<i class="no-highlight">368</i>&nbsp;     * returns without throwing an exception.&lt;/p&gt;
<i class="no-highlight">369</i>&nbsp;     *
<i class="no-highlight">370</i>&nbsp;     * &lt;p&gt;In multithreaded applications, only a single thread should call
<i class="no-highlight">371</i>&nbsp;     * Environment.close.&lt;/p&gt;
<i class="no-highlight">372</i>&nbsp;     *
<i class="no-highlight">373</i>&nbsp;     * &lt;p&gt;The environment handle may not be used again after this method has
<i class="no-highlight">374</i>&nbsp;     * been called, regardless of the method&#39;s success or failure, with one
<i class="no-highlight">375</i>&nbsp;     * exception:  the {@code close} method itself may be called any number of
<i class="no-highlight">376</i>&nbsp;     * times.&lt;/p&gt;
<i class="no-highlight">377</i>&nbsp;     *
<i class="no-highlight">378</i>&nbsp;     * &lt;p&gt;WARNING: To guard against memory leaks, the application should
<i class="no-highlight">379</i>&nbsp;     * discard all references to the closed handle.  While BDB makes an effort
<i class="no-highlight">380</i>&nbsp;     * to discard references from closed objects to the allocated memory for an
<i class="no-highlight">381</i>&nbsp;     * environment, this behavior is not guaranteed.  The safe course of action
<i class="no-highlight">382</i>&nbsp;     * for an application is to discard all references to closed BDB
<i class="no-highlight">383</i>&nbsp;     * objects.&lt;/p&gt;
<i class="no-highlight">384</i>&nbsp;     *
<i class="no-highlight">385</i>&nbsp;     * @throws EnvironmentWedgedException when the current process must be
<i class="no-highlight">386</i>&nbsp;     * shut down and restarted before re-opening the Environment.
<i class="no-highlight">387</i>&nbsp;     *
<i class="no-highlight">388</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">389</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">390</i>&nbsp;     *
<i class="no-highlight">391</i>&nbsp;     * @throws DiskLimitException if the final checkpoint cannot be performed
<i class="no-highlight">392</i>&nbsp;     * because a disk limit has been violated. The Environment will be closed,
<i class="no-highlight">393</i>&nbsp;     * but this exception will be thrown so that the application is aware that
<i class="no-highlight">394</i>&nbsp;     * a checkpoint was not performed.
<i class="no-highlight">395</i>&nbsp;     *
<i class="no-highlight">396</i>&nbsp;     * @throws IllegalStateException if any open databases or transactions
<i class="no-highlight">397</i>&nbsp;     * refer to this handle. The Environment will be closed, but this exception
<i class="no-highlight">398</i>&nbsp;     * will be thrown so that the application is aware that not all databases
<i class="no-highlight">399</i>&nbsp;     * and transactions were closed.
<i class="no-highlight">400</i>&nbsp;     */
<i class="no-highlight">401</i>&nbsp;    public synchronized void close()
<i class="no-highlight">402</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">403</i>&nbsp;
<b class="fc"><i class="no-highlight">404</i>&nbsp;        if (environmentImpl == null) {</b>
<b class="nc"><i class="no-highlight">405</i>&nbsp;            return;</b>
<i class="no-highlight">406</i>&nbsp;        }
<i class="no-highlight">407</i>&nbsp;
<b class="fc"><i class="no-highlight">408</i>&nbsp;        if (!environmentImpl.isValid()) {</b>
<i class="no-highlight">409</i>&nbsp;
<i class="no-highlight">410</i>&nbsp;            /*
<i class="no-highlight">411</i>&nbsp;             * We&#39;re trying to close on an environment that has seen a fatal
<i class="no-highlight">412</i>&nbsp;             * exception. Try to do the minimum, such as closing file
<i class="no-highlight">413</i>&nbsp;             * descriptors, to support re-opening the environment in the same
<i class="no-highlight">414</i>&nbsp;             * JVM.
<i class="no-highlight">415</i>&nbsp;             */
<i class="no-highlight">416</i>&nbsp;            try {
<b class="nc"><i class="no-highlight">417</i>&nbsp;                environmentImpl.closeAfterInvalid();</b>
<i class="no-highlight">418</i>&nbsp;            } finally {
<b class="nc"><i class="no-highlight">419</i>&nbsp;                clearEnvImpl();</b>
<i class="no-highlight">420</i>&nbsp;
<b class="nc"><i class="no-highlight">421</i>&nbsp;                for (Database db : referringDbs.keySet()) {</b>
<b class="nc"><i class="no-highlight">422</i>&nbsp;                    db.minimalClose(Database.DbState.CLOSED, null);</b>
<b class="nc"><i class="no-highlight">423</i>&nbsp;                }</b>
<b class="nc"><i class="no-highlight">424</i>&nbsp;            }</b>
<b class="nc"><i class="no-highlight">425</i>&nbsp;            return;</b>
<i class="no-highlight">426</i>&nbsp;        }
<i class="no-highlight">427</i>&nbsp;
<b class="fc"><i class="no-highlight">428</i>&nbsp;        final StringBuilder errors = new StringBuilder();</b>
<i class="no-highlight">429</i>&nbsp;        try {
<b class="fc"><i class="no-highlight">430</i>&nbsp;            checkForCloseErrors(errors);</b>
<i class="no-highlight">431</i>&nbsp;
<i class="no-highlight">432</i>&nbsp;            try {
<b class="fc"><i class="no-highlight">433</i>&nbsp;                environmentImpl.close();</b>
<b class="nc"><i class="no-highlight">434</i>&nbsp;            } catch (DatabaseException e) {</b>
<b class="nc"><i class="no-highlight">435</i>&nbsp;                e.addErrorMessage(errors.toString());</b>
<b class="nc"><i class="no-highlight">436</i>&nbsp;                throw e;</b>
<b class="nc"><i class="no-highlight">437</i>&nbsp;            } catch (RuntimeException e) {</b>
<b class="nc"><i class="no-highlight">438</i>&nbsp;                if (errors.length() &gt; 0) {</b>
<b class="nc"><i class="no-highlight">439</i>&nbsp;                    throw new IllegalStateException(errors.toString(), e);</b>
<i class="no-highlight">440</i>&nbsp;                }
<b class="nc"><i class="no-highlight">441</i>&nbsp;                throw e;</b>
<b class="fc"><i class="no-highlight">442</i>&nbsp;            }</b>
<i class="no-highlight">443</i>&nbsp;
<b class="fc"><i class="no-highlight">444</i>&nbsp;            if (errors.length() &gt; 0) {</b>
<b class="nc"><i class="no-highlight">445</i>&nbsp;                throw new IllegalStateException(errors.toString());</b>
<i class="no-highlight">446</i>&nbsp;            }
<i class="no-highlight">447</i>&nbsp;        } finally {
<b class="fc"><i class="no-highlight">448</i>&nbsp;            clearEnvImpl();</b>
<b class="fc"><i class="no-highlight">449</i>&nbsp;        }</b>
<b class="fc"><i class="no-highlight">450</i>&nbsp;    }</b>
<i class="no-highlight">451</i>&nbsp;
<i class="no-highlight">452</i>&nbsp;    /**
<i class="no-highlight">453</i>&nbsp;     * Set environmentImpl to null during close, to allow GC when the app may
<i class="no-highlight">454</i>&nbsp;     * hold on to a reference to the Environment handle for some time period.
<i class="no-highlight">455</i>&nbsp;     */
<i class="no-highlight">456</i>&nbsp;    void clearEnvImpl() {
<b class="fc"><i class="no-highlight">457</i>&nbsp;        environmentImpl = null;</b>
<b class="fc"><i class="no-highlight">458</i>&nbsp;    }</b>
<i class="no-highlight">459</i>&nbsp;
<i class="no-highlight">460</i>&nbsp;    /**
<i class="no-highlight">461</i>&nbsp;     * Close an InternalEnvironment handle.  We do not call
<i class="no-highlight">462</i>&nbsp;     * EnvironmentImpl.close here, since an InternalEnvironment is not
<i class="no-highlight">463</i>&nbsp;     * registered like a non-internal handle.  However, we must call
<i class="no-highlight">464</i>&nbsp;     * checkForCloseErrors to auto-close internal databases, as well as check
<i class="no-highlight">465</i>&nbsp;     * for errors.
<i class="no-highlight">466</i>&nbsp;     */
<i class="no-highlight">467</i>&nbsp;    synchronized void closeInternalHandle() {
<b class="fc"><i class="no-highlight">468</i>&nbsp;        final StringBuilder errors = new StringBuilder();</b>
<b class="fc"><i class="no-highlight">469</i>&nbsp;        checkForCloseErrors(errors);</b>
<b class="fc"><i class="no-highlight">470</i>&nbsp;        if (errors.length() &gt; 0) {</b>
<b class="nc"><i class="no-highlight">471</i>&nbsp;            throw new IllegalStateException(errors.toString());</b>
<i class="no-highlight">472</i>&nbsp;        }
<b class="fc"><i class="no-highlight">473</i>&nbsp;    }</b>
<i class="no-highlight">474</i>&nbsp;
<i class="no-highlight">475</i>&nbsp;    private void checkForCloseErrors(StringBuilder errors) {
<i class="no-highlight">476</i>&nbsp;
<b class="fc"><i class="no-highlight">477</i>&nbsp;        checkOpenDbs(errors);</b>
<i class="no-highlight">478</i>&nbsp;
<b class="fc"><i class="no-highlight">479</i>&nbsp;        checkOpenTxns(errors);</b>
<i class="no-highlight">480</i>&nbsp;
<b class="fc"><i class="no-highlight">481</i>&nbsp;        if (!isInternalHandle()) {</b>
<i class="no-highlight">482</i>&nbsp;
<i class="no-highlight">483</i>&nbsp;            /*
<i class="no-highlight">484</i>&nbsp;             * Only check for open XA transactions against user created
<i class="no-highlight">485</i>&nbsp;             * environment handles.
<i class="no-highlight">486</i>&nbsp;             */
<b class="fc"><i class="no-highlight">487</i>&nbsp;            checkOpenXATransactions(errors);</b>
<i class="no-highlight">488</i>&nbsp;        }
<b class="fc"><i class="no-highlight">489</i>&nbsp;    }</b>
<i class="no-highlight">490</i>&nbsp;
<i class="no-highlight">491</i>&nbsp;    /**
<i class="no-highlight">492</i>&nbsp;     * Appends error messages to the errors argument if there are
<i class="no-highlight">493</i>&nbsp;     * open XA transactions associated with the underlying EnvironmentImpl.
<i class="no-highlight">494</i>&nbsp;     */
<i class="no-highlight">495</i>&nbsp;    private void checkOpenXATransactions(final StringBuilder errors) {
<b class="fc"><i class="no-highlight">496</i>&nbsp;        Xid[] openXids = getNonNullEnvImpl().getTxnManager().XARecover();</b>
<b class="fc"><i class="no-highlight">497</i>&nbsp;        if (openXids != null &amp;&amp; openXids.length &gt; 0) {</b>
<b class="nc"><i class="no-highlight">498</i>&nbsp;            errors.append(&quot;There &quot;);</b>
<b class="nc"><i class="no-highlight">499</i>&nbsp;            int nXATxns = openXids.length;</b>
<b class="nc"><i class="no-highlight">500</i>&nbsp;            if (nXATxns == 1) {</b>
<b class="nc"><i class="no-highlight">501</i>&nbsp;                errors.append(&quot;is 1 existing XA transaction opened&quot;);</b>
<b class="nc"><i class="no-highlight">502</i>&nbsp;                errors.append(&quot; in the Environment.\n&quot;);</b>
<b class="nc"><i class="no-highlight">503</i>&nbsp;                errors.append(&quot;It&quot;);</b>
<i class="no-highlight">504</i>&nbsp;            } else {
<b class="nc"><i class="no-highlight">505</i>&nbsp;                errors.append(&quot;are &quot;);</b>
<b class="nc"><i class="no-highlight">506</i>&nbsp;                errors.append(nXATxns);</b>
<b class="nc"><i class="no-highlight">507</i>&nbsp;                errors.append(&quot; existing transactions opened in&quot;);</b>
<b class="nc"><i class="no-highlight">508</i>&nbsp;                errors.append(&quot; the Environment.\n&quot;);</b>
<b class="nc"><i class="no-highlight">509</i>&nbsp;                errors.append(&quot;They&quot;);</b>
<i class="no-highlight">510</i>&nbsp;            }
<b class="nc"><i class="no-highlight">511</i>&nbsp;            errors.append(&quot; will be left open ...\n&quot;);</b>
<i class="no-highlight">512</i>&nbsp;        }
<b class="fc"><i class="no-highlight">513</i>&nbsp;    }</b>
<i class="no-highlight">514</i>&nbsp;
<i class="no-highlight">515</i>&nbsp;    /**
<i class="no-highlight">516</i>&nbsp;     * Appends error messages to the errors argument if there are open
<i class="no-highlight">517</i>&nbsp;     * transactions associated with the environment.
<i class="no-highlight">518</i>&nbsp;     */
<i class="no-highlight">519</i>&nbsp;    private void checkOpenTxns(final StringBuilder errors) {
<b class="fc"><i class="no-highlight">520</i>&nbsp;        int nTxns = (referringDbTxns == null) ? 0 : referringDbTxns.size();</b>
<b class="fc"><i class="no-highlight">521</i>&nbsp;        if (nTxns == 0) {</b>
<b class="fc"><i class="no-highlight">522</i>&nbsp;            return;</b>
<i class="no-highlight">523</i>&nbsp;        }
<i class="no-highlight">524</i>&nbsp;
<b class="nc"><i class="no-highlight">525</i>&nbsp;        errors.append(&quot;There &quot;);</b>
<b class="nc"><i class="no-highlight">526</i>&nbsp;        if (nTxns == 1) {</b>
<b class="nc"><i class="no-highlight">527</i>&nbsp;            errors.append(&quot;is 1 existing transaction opened&quot;);</b>
<b class="nc"><i class="no-highlight">528</i>&nbsp;            errors.append(&quot; against the Environment.\n&quot;);</b>
<i class="no-highlight">529</i>&nbsp;        } else {
<b class="nc"><i class="no-highlight">530</i>&nbsp;            errors.append(&quot;are &quot;);</b>
<b class="nc"><i class="no-highlight">531</i>&nbsp;            errors.append(nTxns);</b>
<b class="nc"><i class="no-highlight">532</i>&nbsp;            errors.append(&quot; existing transactions opened against&quot;);</b>
<b class="nc"><i class="no-highlight">533</i>&nbsp;            errors.append(&quot; the Environment.\n&quot;);</b>
<i class="no-highlight">534</i>&nbsp;        }
<b class="nc"><i class="no-highlight">535</i>&nbsp;        errors.append(&quot;Aborting open transactions ...\n&quot;);</b>
<i class="no-highlight">536</i>&nbsp;
<b class="nc"><i class="no-highlight">537</i>&nbsp;       for (Transaction txn : referringDbTxns.keySet()) {</b>
<i class="no-highlight">538</i>&nbsp;            try {
<b class="nc"><i class="no-highlight">539</i>&nbsp;                errors.append(&quot;aborting &quot; + txn);</b>
<b class="nc"><i class="no-highlight">540</i>&nbsp;                txn.abort();</b>
<b class="nc"><i class="no-highlight">541</i>&nbsp;            } catch (RuntimeException e) {</b>
<b class="nc"><i class="no-highlight">542</i>&nbsp;                if (!environmentImpl.isValid()) {</b>
<i class="no-highlight">543</i>&nbsp;                    /* Propagate if env is invalidated. */
<b class="nc"><i class="no-highlight">544</i>&nbsp;                    throw e;</b>
<i class="no-highlight">545</i>&nbsp;                }
<b class="nc"><i class="no-highlight">546</i>&nbsp;                errors.append(&quot;\nWhile aborting transaction &quot;);</b>
<b class="nc"><i class="no-highlight">547</i>&nbsp;                errors.append(txn.getId());</b>
<b class="nc"><i class="no-highlight">548</i>&nbsp;                errors.append(&quot; encountered exception: &quot;);</b>
<b class="nc"><i class="no-highlight">549</i>&nbsp;                errors.append(e).append(&quot;\n&quot;);</b>
<b class="nc"><i class="no-highlight">550</i>&nbsp;            }</b>
<b class="nc"><i class="no-highlight">551</i>&nbsp;        }</b>
<b class="nc"><i class="no-highlight">552</i>&nbsp;    }</b>
<i class="no-highlight">553</i>&nbsp;
<i class="no-highlight">554</i>&nbsp;    /**
<i class="no-highlight">555</i>&nbsp;     * Appends error messages to the errors argument if there are open database
<i class="no-highlight">556</i>&nbsp;     * handles associated with the environment.
<i class="no-highlight">557</i>&nbsp;     */
<i class="no-highlight">558</i>&nbsp;    private void checkOpenDbs(final StringBuilder errors) {
<i class="no-highlight">559</i>&nbsp;
<b class="fc"><i class="no-highlight">560</i>&nbsp;        if (referringDbs.isEmpty()) {</b>
<b class="fc"><i class="no-highlight">561</i>&nbsp;            return;</b>
<i class="no-highlight">562</i>&nbsp;        }
<i class="no-highlight">563</i>&nbsp;
<b class="nc"><i class="no-highlight">564</i>&nbsp;        int nOpenUserDbs = 0;</b>
<i class="no-highlight">565</i>&nbsp;
<b class="nc"><i class="no-highlight">566</i>&nbsp;        for (Database db : referringDbs.keySet()) {</b>
<b class="nc"><i class="no-highlight">567</i>&nbsp;            String dbName = &quot;&quot;;</b>
<i class="no-highlight">568</i>&nbsp;            try {
<i class="no-highlight">569</i>&nbsp;
<i class="no-highlight">570</i>&nbsp;                /*
<i class="no-highlight">571</i>&nbsp;                 * Save the db name before we attempt the close, it&#39;s
<i class="no-highlight">572</i>&nbsp;                 * unavailable after the close.
<i class="no-highlight">573</i>&nbsp;                 */
<b class="nc"><i class="no-highlight">574</i>&nbsp;                dbName = db.getDebugName();</b>
<i class="no-highlight">575</i>&nbsp;
<b class="nc"><i class="no-highlight">576</i>&nbsp;                if (!db.getDbImpl().isInternalDb()) {</b>
<b class="nc"><i class="no-highlight">577</i>&nbsp;                    nOpenUserDbs += 1;</b>
<b class="nc"><i class="no-highlight">578</i>&nbsp;                    errors.append(&quot;Unclosed Database: &quot;);</b>
<b class="nc"><i class="no-highlight">579</i>&nbsp;                    errors.append(dbName).append(&quot;\n&quot;);</b>
<i class="no-highlight">580</i>&nbsp;                }
<b class="nc"><i class="no-highlight">581</i>&nbsp;                db.close();</b>
<b class="nc"><i class="no-highlight">582</i>&nbsp;            } catch (RuntimeException e) {</b>
<b class="nc"><i class="no-highlight">583</i>&nbsp;                if (!environmentImpl.isValid()) {</b>
<i class="no-highlight">584</i>&nbsp;                    /* Propagate if env is invalidated. */
<b class="nc"><i class="no-highlight">585</i>&nbsp;                    throw e;</b>
<i class="no-highlight">586</i>&nbsp;                }
<b class="nc"><i class="no-highlight">587</i>&nbsp;                errors.append(&quot;\nWhile closing Database &quot;);</b>
<b class="nc"><i class="no-highlight">588</i>&nbsp;                errors.append(dbName);</b>
<b class="nc"><i class="no-highlight">589</i>&nbsp;                errors.append(&quot; encountered exception: &quot;);</b>
<b class="nc"><i class="no-highlight">590</i>&nbsp;                errors.append(LoggerUtils.getStackTrace(e)).append(&quot;\n&quot;);</b>
<b class="nc"><i class="no-highlight">591</i>&nbsp;            }</b>
<b class="nc"><i class="no-highlight">592</i>&nbsp;        }</b>
<i class="no-highlight">593</i>&nbsp;
<b class="nc"><i class="no-highlight">594</i>&nbsp;        if (nOpenUserDbs &gt; 0) {</b>
<b class="nc"><i class="no-highlight">595</i>&nbsp;            errors.append(&quot;Databases left open: &quot;);</b>
<b class="nc"><i class="no-highlight">596</i>&nbsp;            errors.append(nOpenUserDbs).append(&quot;\n&quot;);</b>
<i class="no-highlight">597</i>&nbsp;        }
<b class="nc"><i class="no-highlight">598</i>&nbsp;    }</b>
<i class="no-highlight">599</i>&nbsp;
<i class="no-highlight">600</i>&nbsp;    /**
<i class="no-highlight">601</i>&nbsp;     * Opens, and optionally creates, a &lt;code&gt;Database&lt;/code&gt;.
<i class="no-highlight">602</i>&nbsp;     *
<i class="no-highlight">603</i>&nbsp;     * @param txn For a transactional database, an explicit transaction may be
<i class="no-highlight">604</i>&nbsp;     * specified, or null may be specified to use auto-commit.  For a
<i class="no-highlight">605</i>&nbsp;     * non-transactional database, null must be specified.
<i class="no-highlight">606</i>&nbsp;     *
<i class="no-highlight">607</i>&nbsp;     * @param databaseName The name of the database.
<i class="no-highlight">608</i>&nbsp;     *
<i class="no-highlight">609</i>&nbsp;     * @param dbConfig The database attributes.  If null, default attributes
<i class="no-highlight">610</i>&nbsp;     * are used.
<i class="no-highlight">611</i>&nbsp;     *
<i class="no-highlight">612</i>&nbsp;     * @return Database handle.
<i class="no-highlight">613</i>&nbsp;     *
<i class="no-highlight">614</i>&nbsp;     * @throws DatabaseExistsException if the database already exists and the
<i class="no-highlight">615</i>&nbsp;     * {@code DatabaseConfig ExclusiveCreate} parameter is true.
<i class="no-highlight">616</i>&nbsp;     *
<i class="no-highlight">617</i>&nbsp;     * @throws DatabaseNotFoundException if the database does not exist and the
<i class="no-highlight">618</i>&nbsp;     * {@code DatabaseConfig AllowCreate} parameter is false.
<i class="no-highlight">619</i>&nbsp;     *
<i class="no-highlight">620</i>&nbsp;     * @throws OperationFailureException if one of the &lt;a
<i class="no-highlight">621</i>&nbsp;     * href=&quot;../je/OperationFailureException.html#readFailures&quot;&gt;Read Operation
<i class="no-highlight">622</i>&nbsp;     * Failures&lt;/a&gt; occurs. If the database does not exist and the {@link
<i class="no-highlight">623</i>&nbsp;     * DatabaseConfig#setAllowCreate AllowCreate} parameter is true, then one
<i class="no-highlight">624</i>&nbsp;     * of the &lt;a
<i class="no-highlight">625</i>&nbsp;     * href=&quot;../je/OperationFailureException.html#writeFailures&quot;&gt;Write
<i class="no-highlight">626</i>&nbsp;     * Operation Failures&lt;/a&gt; may also occur.
<i class="no-highlight">627</i>&nbsp;     *
<i class="no-highlight">628</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">629</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">630</i>&nbsp;     *
<i class="no-highlight">631</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">632</i>&nbsp;     * environment has been closed.
<i class="no-highlight">633</i>&nbsp;     *
<i class="no-highlight">634</i>&nbsp;     * @throws IllegalArgumentException if an invalid parameter is specified,
<i class="no-highlight">635</i>&nbsp;     * for example, an invalid {@code DatabaseConfig} property.
<i class="no-highlight">636</i>&nbsp;     *
<i class="no-highlight">637</i>&nbsp;     * @throws IllegalStateException if DatabaseConfig properties are changed
<i class="no-highlight">638</i>&nbsp;     * and there are other open handles for this database.
<i class="no-highlight">639</i>&nbsp;     */
<i class="no-highlight">640</i>&nbsp;    public synchronized Database openDatabase(Transaction txn,
<i class="no-highlight">641</i>&nbsp;                                              String databaseName,
<i class="no-highlight">642</i>&nbsp;                                              DatabaseConfig dbConfig)
<i class="no-highlight">643</i>&nbsp;        throws DatabaseNotFoundException,
<i class="no-highlight">644</i>&nbsp;               DatabaseExistsException,
<i class="no-highlight">645</i>&nbsp;               IllegalArgumentException,
<i class="no-highlight">646</i>&nbsp;               IllegalStateException {
<i class="no-highlight">647</i>&nbsp;
<b class="fc"><i class="no-highlight">648</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">649</i>&nbsp;
<b class="fc"><i class="no-highlight">650</i>&nbsp;        if (dbConfig == null) {</b>
<b class="nc"><i class="no-highlight">651</i>&nbsp;            dbConfig = DatabaseConfig.DEFAULT;</b>
<i class="no-highlight">652</i>&nbsp;        }
<i class="no-highlight">653</i>&nbsp;
<i class="no-highlight">654</i>&nbsp;        try {
<b class="fc"><i class="no-highlight">655</i>&nbsp;            final Database db = new Database(this);</b>
<i class="no-highlight">656</i>&nbsp;
<b class="fc"><i class="no-highlight">657</i>&nbsp;            setupDatabase(</b>
<i class="no-highlight">658</i>&nbsp;                envImpl, txn, db, databaseName, dbConfig,
<i class="no-highlight">659</i>&nbsp;                false  /*isInternalDb*/);
<i class="no-highlight">660</i>&nbsp;
<b class="fc"><i class="no-highlight">661</i>&nbsp;            return db;</b>
<b class="nc"><i class="no-highlight">662</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">663</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">664</i>&nbsp;            throw E;</b>
<i class="no-highlight">665</i>&nbsp;        }
<i class="no-highlight">666</i>&nbsp;    }
<i class="no-highlight">667</i>&nbsp;
<i class="no-highlight">668</i>&nbsp;    /**
<i class="no-highlight">669</i>&nbsp;     * Opens and optionally creates a &lt;code&gt;SecondaryDatabase&lt;/code&gt;.
<i class="no-highlight">670</i>&nbsp;     *
<i class="no-highlight">671</i>&nbsp;     * &lt;p&gt;Note that the associations between primary and secondary databases
<i class="no-highlight">672</i>&nbsp;     * are not stored persistently.  Whenever a primary database is opened for
<i class="no-highlight">673</i>&nbsp;     * write access by the application, the appropriate associated secondary
<i class="no-highlight">674</i>&nbsp;     * databases should also be opened by the application.  This is necessary
<i class="no-highlight">675</i>&nbsp;     * to ensure data integrity when changes are made to the primary
<i class="no-highlight">676</i>&nbsp;     * database.&lt;/p&gt;
<i class="no-highlight">677</i>&nbsp;     *
<i class="no-highlight">678</i>&nbsp;     * @param txn For a transactional database, an explicit transaction may be
<i class="no-highlight">679</i>&nbsp;     * specified, or null may be specified to use auto-commit.  For a
<i class="no-highlight">680</i>&nbsp;     * non-transactional database, null must be specified.
<i class="no-highlight">681</i>&nbsp;     *
<i class="no-highlight">682</i>&nbsp;     * @param databaseName The name of the database.
<i class="no-highlight">683</i>&nbsp;     *
<i class="no-highlight">684</i>&nbsp;     * @param primaryDatabase the primary database with which the secondary
<i class="no-highlight">685</i>&nbsp;     * database will be associated.  The primary database must not be
<i class="no-highlight">686</i>&nbsp;     * configured for duplicates.
<i class="no-highlight">687</i>&nbsp;     *
<i class="no-highlight">688</i>&nbsp;     * @param dbConfig The secondary database attributes.  If null, default
<i class="no-highlight">689</i>&nbsp;     * attributes are used.
<i class="no-highlight">690</i>&nbsp;     *
<i class="no-highlight">691</i>&nbsp;     * @return Database handle.
<i class="no-highlight">692</i>&nbsp;     *
<i class="no-highlight">693</i>&nbsp;     * @throws DatabaseExistsException if the database already exists and the
<i class="no-highlight">694</i>&nbsp;     * {@code DatabaseConfig ExclusiveCreate} parameter is true.
<i class="no-highlight">695</i>&nbsp;     *
<i class="no-highlight">696</i>&nbsp;     * @throws DatabaseNotFoundException if the database does not exist and the
<i class="no-highlight">697</i>&nbsp;     * {@code DatabaseConfig AllowCreate} parameter is false.
<i class="no-highlight">698</i>&nbsp;     *
<i class="no-highlight">699</i>&nbsp;     * @throws OperationFailureException if one of the &lt;a
<i class="no-highlight">700</i>&nbsp;     * href=&quot;../je/OperationFailureException.html#readFailures&quot;&gt;Read Operation
<i class="no-highlight">701</i>&nbsp;     * Failures&lt;/a&gt; occurs. If the database does not exist and the {@link
<i class="no-highlight">702</i>&nbsp;     * DatabaseConfig#setAllowCreate AllowCreate} parameter is true, then one
<i class="no-highlight">703</i>&nbsp;     * of the &lt;a
<i class="no-highlight">704</i>&nbsp;     * href=&quot;../je/OperationFailureException.html#writeFailures&quot;&gt;Write
<i class="no-highlight">705</i>&nbsp;     * Operation Failures&lt;/a&gt; may also occur.
<i class="no-highlight">706</i>&nbsp;     *
<i class="no-highlight">707</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">708</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">709</i>&nbsp;     *
<i class="no-highlight">710</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">711</i>&nbsp;     * environment has been closed.
<i class="no-highlight">712</i>&nbsp;     *
<i class="no-highlight">713</i>&nbsp;     * @throws IllegalArgumentException if an invalid parameter is specified,
<i class="no-highlight">714</i>&nbsp;     * for example, an invalid {@code SecondaryConfig} property.
<i class="no-highlight">715</i>&nbsp;     *
<i class="no-highlight">716</i>&nbsp;     * @throws IllegalStateException if DatabaseConfig properties are changed
<i class="no-highlight">717</i>&nbsp;     * and there are other open handles for this database.
<i class="no-highlight">718</i>&nbsp;     */
<i class="no-highlight">719</i>&nbsp;    public synchronized SecondaryDatabase openSecondaryDatabase(
<i class="no-highlight">720</i>&nbsp;        Transaction txn,
<i class="no-highlight">721</i>&nbsp;        String databaseName,
<i class="no-highlight">722</i>&nbsp;        Database primaryDatabase,
<i class="no-highlight">723</i>&nbsp;        SecondaryConfig dbConfig)
<i class="no-highlight">724</i>&nbsp;        throws DatabaseNotFoundException,
<i class="no-highlight">725</i>&nbsp;               DatabaseExistsException,
<i class="no-highlight">726</i>&nbsp;               DatabaseException,
<i class="no-highlight">727</i>&nbsp;               IllegalArgumentException,
<i class="no-highlight">728</i>&nbsp;               IllegalStateException {
<i class="no-highlight">729</i>&nbsp;
<b class="nc"><i class="no-highlight">730</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">731</i>&nbsp;
<i class="no-highlight">732</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">733</i>&nbsp;            envImpl.getSecondaryAssociationLock().</b>
<b class="nc"><i class="no-highlight">734</i>&nbsp;                writeLock().lockInterruptibly();</b>
<b class="nc"><i class="no-highlight">735</i>&nbsp;        } catch (InterruptedException e) {</b>
<b class="nc"><i class="no-highlight">736</i>&nbsp;            throw new ThreadInterruptedException(envImpl, e);</b>
<b class="nc"><i class="no-highlight">737</i>&nbsp;        }</b>
<i class="no-highlight">738</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">739</i>&nbsp;            if (dbConfig == null) {</b>
<b class="nc"><i class="no-highlight">740</i>&nbsp;                dbConfig = SecondaryConfig.DEFAULT;</b>
<i class="no-highlight">741</i>&nbsp;            }
<b class="nc"><i class="no-highlight">742</i>&nbsp;            final SecondaryDatabase db =</b>
<i class="no-highlight">743</i>&nbsp;                new SecondaryDatabase(this, dbConfig, primaryDatabase);
<i class="no-highlight">744</i>&nbsp;
<b class="nc"><i class="no-highlight">745</i>&nbsp;            setupDatabase(</b>
<i class="no-highlight">746</i>&nbsp;                envImpl, txn, db, databaseName, dbConfig,
<i class="no-highlight">747</i>&nbsp;                false  /*isInternalDb*/);
<i class="no-highlight">748</i>&nbsp;
<b class="nc"><i class="no-highlight">749</i>&nbsp;            return db;</b>
<b class="nc"><i class="no-highlight">750</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">751</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">752</i>&nbsp;            throw E;</b>
<i class="no-highlight">753</i>&nbsp;        } finally {
<b class="nc"><i class="no-highlight">754</i>&nbsp;            envImpl.getSecondaryAssociationLock().writeLock().unlock();</b>
<b class="nc"><i class="no-highlight">755</i>&nbsp;        }</b>
<i class="no-highlight">756</i>&nbsp;    }
<i class="no-highlight">757</i>&nbsp;
<i class="no-highlight">758</i>&nbsp;    /**
<i class="no-highlight">759</i>&nbsp;     * The meat of open database processing.
<i class="no-highlight">760</i>&nbsp;     *
<i class="no-highlight">761</i>&nbsp;     * Currently, only external DBs are opened via this method, but we may
<i class="no-highlight">762</i>&nbsp;     * allow internal DB opens in the future.
<i class="no-highlight">763</i>&nbsp;     *
<i class="no-highlight">764</i>&nbsp;     * @param txn may be null
<i class="no-highlight">765</i>&nbsp;     * @param newDb is the Database handle which houses this database
<i class="no-highlight">766</i>&nbsp;     *
<i class="no-highlight">767</i>&nbsp;     * @throws IllegalArgumentException via openDatabase and
<i class="no-highlight">768</i>&nbsp;     * openSecondaryDatabase
<i class="no-highlight">769</i>&nbsp;     *
<i class="no-highlight">770</i>&nbsp;     * @see HandleLocker
<i class="no-highlight">771</i>&nbsp;     */
<i class="no-highlight">772</i>&nbsp;    private void setupDatabase(EnvironmentImpl envImpl,
<i class="no-highlight">773</i>&nbsp;                               Transaction txn,
<i class="no-highlight">774</i>&nbsp;                               Database newDb,
<i class="no-highlight">775</i>&nbsp;                               String databaseName,
<i class="no-highlight">776</i>&nbsp;                               DatabaseConfig dbConfig,
<i class="no-highlight">777</i>&nbsp;                               boolean isInternalDb)
<i class="no-highlight">778</i>&nbsp;        throws DatabaseNotFoundException, DatabaseExistsException {
<i class="no-highlight">779</i>&nbsp;
<b class="fc"><i class="no-highlight">780</i>&nbsp;        DatabaseUtil.checkForNullParam(databaseName, &quot;databaseName&quot;);</b>
<i class="no-highlight">781</i>&nbsp;
<b class="fc"><i class="no-highlight">782</i>&nbsp;        LoggerUtils.envLogMsg(Level.FINEST, envImpl,</b>
<i class="no-highlight">783</i>&nbsp;                              &quot;Environment.open: &quot; + &quot; name=&quot; + databaseName +
<i class="no-highlight">784</i>&nbsp;                              &quot; dbConfig=&quot; + dbConfig);
<i class="no-highlight">785</i>&nbsp;
<b class="fc"><i class="no-highlight">786</i>&nbsp;        final boolean autoTxnIsReplicated =</b>
<b class="fc"><i class="no-highlight">787</i>&nbsp;            dbConfig.getReplicated() &amp;&amp; envImpl.isReplicated();</b>
<i class="no-highlight">788</i>&nbsp;
<i class="no-highlight">789</i>&nbsp;        /*
<i class="no-highlight">790</i>&nbsp;         * Check that the open configuration is valid and doesn&#39;t conflict with
<i class="no-highlight">791</i>&nbsp;         * the envImpl configuration.
<i class="no-highlight">792</i>&nbsp;         */
<b class="fc"><i class="no-highlight">793</i>&nbsp;        dbConfig.validateOnDbOpen(databaseName, autoTxnIsReplicated);</b>
<i class="no-highlight">794</i>&nbsp;
<b class="fc"><i class="no-highlight">795</i>&nbsp;        validateDbConfigAgainstEnv(</b>
<i class="no-highlight">796</i>&nbsp;            envImpl, dbConfig, databaseName, isInternalDb);
<i class="no-highlight">797</i>&nbsp;
<i class="no-highlight">798</i>&nbsp;        /* Perform eviction before each operation that allocates memory. */
<b class="fc"><i class="no-highlight">799</i>&nbsp;        envImpl.criticalEviction(false /*backgroundIO*/);</b>
<i class="no-highlight">800</i>&nbsp;
<b class="fc"><i class="no-highlight">801</i>&nbsp;        DatabaseImpl database = null;</b>
<b class="fc"><i class="no-highlight">802</i>&nbsp;        boolean operationOk = false;</b>
<b class="fc"><i class="no-highlight">803</i>&nbsp;        HandleLocker handleLocker = null;</b>
<b class="fc"><i class="no-highlight">804</i>&nbsp;        final Locker locker = LockerFactory.getWritableLocker</b>
<b class="fc"><i class="no-highlight">805</i>&nbsp;            (this, txn, isInternalDb, dbConfig.getTransactional(),</b>
<i class="no-highlight">806</i>&nbsp;             autoTxnIsReplicated, null);
<i class="no-highlight">807</i>&nbsp;        try {
<i class="no-highlight">808</i>&nbsp;
<i class="no-highlight">809</i>&nbsp;            /*
<i class="no-highlight">810</i>&nbsp;             * Create the handle locker and lock the NameLN of an existing
<i class="no-highlight">811</i>&nbsp;             * database.  A read lock on the NameLN is acquired for both locker
<i class="no-highlight">812</i>&nbsp;             * and handleLocker.  Note: getDb may return a deleted database.
<i class="no-highlight">813</i>&nbsp;             */
<b class="fc"><i class="no-highlight">814</i>&nbsp;            handleLocker = newDb.initHandleLocker(envImpl, locker);</b>
<b class="fc"><i class="no-highlight">815</i>&nbsp;            database = envImpl.getDbTree().getDb(locker, databaseName,</b>
<i class="no-highlight">816</i>&nbsp;                                                 handleLocker, false);
<i class="no-highlight">817</i>&nbsp;
<b class="fc"><i class="no-highlight">818</i>&nbsp;            boolean dbCreated = false;</b>
<b class="fc"><i class="no-highlight">819</i>&nbsp;            final boolean databaseExists =</b>
<b class="nc"><i class="no-highlight">820</i>&nbsp;                (database != null) &amp;&amp; !database.isDeleted();</b>
<i class="no-highlight">821</i>&nbsp;
<b class="fc"><i class="no-highlight">822</i>&nbsp;            if (databaseExists) {</b>
<b class="nc"><i class="no-highlight">823</i>&nbsp;                if (dbConfig.getAllowCreate() &amp;&amp;</b>
<b class="nc"><i class="no-highlight">824</i>&nbsp;                    dbConfig.getExclusiveCreate()) {</b>
<b class="nc"><i class="no-highlight">825</i>&nbsp;                    throw new DatabaseExistsException</b>
<i class="no-highlight">826</i>&nbsp;                        (&quot;Database &quot; + databaseName + &quot; already exists&quot;);
<i class="no-highlight">827</i>&nbsp;                }
<i class="no-highlight">828</i>&nbsp;
<b class="nc"><i class="no-highlight">829</i>&nbsp;                newDb.initExisting(this, locker, database, databaseName,</b>
<i class="no-highlight">830</i>&nbsp;                                   dbConfig);
<i class="no-highlight">831</i>&nbsp;            } else {
<i class="no-highlight">832</i>&nbsp;                /* Release deleted DB. [#13415] */
<b class="fc"><i class="no-highlight">833</i>&nbsp;                envImpl.getDbTree().releaseDb(database);</b>
<b class="fc"><i class="no-highlight">834</i>&nbsp;                database = null;</b>
<i class="no-highlight">835</i>&nbsp;
<b class="fc"><i class="no-highlight">836</i>&nbsp;                if (!isInternalDb &amp;&amp;</b>
<b class="fc"><i class="no-highlight">837</i>&nbsp;                    DbTree.isReservedDbName(databaseName)) {</b>
<b class="nc"><i class="no-highlight">838</i>&nbsp;                    throw new IllegalArgumentException</b>
<i class="no-highlight">839</i>&nbsp;                        (databaseName + &quot; is a reserved database name.&quot;);
<i class="no-highlight">840</i>&nbsp;                }
<i class="no-highlight">841</i>&nbsp;
<b class="fc"><i class="no-highlight">842</i>&nbsp;                if (!dbConfig.getAllowCreate()) {</b>
<b class="nc"><i class="no-highlight">843</i>&nbsp;                    throw new DatabaseNotFoundException(&quot;Database &quot; +</b>
<i class="no-highlight">844</i>&nbsp;                                                        databaseName +
<i class="no-highlight">845</i>&nbsp;                                                        &quot; not found.&quot;);
<i class="no-highlight">846</i>&nbsp;                }
<i class="no-highlight">847</i>&nbsp;
<i class="no-highlight">848</i>&nbsp;                /*
<i class="no-highlight">849</i>&nbsp;                 * Init a new DB. This calls DbTree.createDb and the new
<i class="no-highlight">850</i>&nbsp;                 * database is returned.  A write lock on the NameLN is
<i class="no-highlight">851</i>&nbsp;                 * acquired by locker and a read lock by the handleLocker.
<i class="no-highlight">852</i>&nbsp;                 */
<b class="fc"><i class="no-highlight">853</i>&nbsp;                database = newDb.initNew(this, locker, databaseName, dbConfig);</b>
<b class="fc"><i class="no-highlight">854</i>&nbsp;                dbCreated = true;</b>
<i class="no-highlight">855</i>&nbsp;            }
<i class="no-highlight">856</i>&nbsp;
<i class="no-highlight">857</i>&nbsp;            /*
<i class="no-highlight">858</i>&nbsp;             * The open is successful.  We add the opened database handle to
<i class="no-highlight">859</i>&nbsp;             * this environment to track open handles in general, and to the
<i class="no-highlight">860</i>&nbsp;             * locker so that it can be invalidated by a user txn abort.
<i class="no-highlight">861</i>&nbsp;             */
<b class="fc"><i class="no-highlight">862</i>&nbsp;            operationOk = true;</b>
<b class="fc"><i class="no-highlight">863</i>&nbsp;            addReferringHandle(newDb);</b>
<b class="fc"><i class="no-highlight">864</i>&nbsp;            locker.addOpenedDatabase(newDb);</b>
<i class="no-highlight">865</i>&nbsp;
<i class="no-highlight">866</i>&nbsp;            /* Run triggers before any subsequent auto commits. */
<b class="fc"><i class="no-highlight">867</i>&nbsp;            final boolean firstWriteHandle =</b>
<b class="fc"><i class="no-highlight">868</i>&nbsp;                newDb.isWritable() &amp;&amp;</b>
<b class="fc"><i class="no-highlight">869</i>&nbsp;                (newDb.getDbImpl().noteWriteHandleOpen() == 1);</b>
<i class="no-highlight">870</i>&nbsp;
<b class="fc"><i class="no-highlight">871</i>&nbsp;            if (dbCreated || firstWriteHandle) {</b>
<b class="fc"><i class="no-highlight">872</i>&nbsp;                TriggerManager.runOpenTriggers(locker, newDb, dbCreated);</b>
<i class="no-highlight">873</i>&nbsp;            }
<i class="no-highlight">874</i>&nbsp;        } finally {
<i class="no-highlight">875</i>&nbsp;
<i class="no-highlight">876</i>&nbsp;            /*
<i class="no-highlight">877</i>&nbsp;             * If the open fails, decrement the DB usage count, release
<i class="no-highlight">878</i>&nbsp;             * handle locks and remove references from other objects.  In other
<i class="no-highlight">879</i>&nbsp;             * cases this is done by Database.close() or invalidate(), the
<i class="no-highlight">880</i>&nbsp;             * latter in the case of a user txn abort.
<i class="no-highlight">881</i>&nbsp;             */
<b class="fc"><i class="no-highlight">882</i>&nbsp;            if (!operationOk) {</b>
<b class="nc"><i class="no-highlight">883</i>&nbsp;                envImpl.getDbTree().releaseDb(database);</b>
<b class="nc"><i class="no-highlight">884</i>&nbsp;                if (handleLocker != null) {</b>
<b class="nc"><i class="no-highlight">885</i>&nbsp;                    handleLocker.operationEnd(false);</b>
<i class="no-highlight">886</i>&nbsp;                }
<b class="nc"><i class="no-highlight">887</i>&nbsp;                newDb.removeReferringAssociations();</b>
<i class="no-highlight">888</i>&nbsp;            }
<i class="no-highlight">889</i>&nbsp;
<i class="no-highlight">890</i>&nbsp;            /*
<i class="no-highlight">891</i>&nbsp;             * Tell the locker that this operation is over. Some types of
<i class="no-highlight">892</i>&nbsp;             * lockers (BasicLocker and auto Txn) will actually finish.
<i class="no-highlight">893</i>&nbsp;             */
<b class="fc"><i class="no-highlight">894</i>&nbsp;            locker.operationEnd(operationOk);</b>
<b class="fc"><i class="no-highlight">895</i>&nbsp;        }</b>
<b class="fc"><i class="no-highlight">896</i>&nbsp;    }</b>
<i class="no-highlight">897</i>&nbsp;
<i class="no-highlight">898</i>&nbsp;    /**
<i class="no-highlight">899</i>&nbsp;     * @throws IllegalArgumentException via openDatabase and
<i class="no-highlight">900</i>&nbsp;     * openSecondaryDatabase
<i class="no-highlight">901</i>&nbsp;     */
<i class="no-highlight">902</i>&nbsp;    private void validateDbConfigAgainstEnv(EnvironmentImpl envImpl,
<i class="no-highlight">903</i>&nbsp;                                            DatabaseConfig dbConfig,
<i class="no-highlight">904</i>&nbsp;                                            String databaseName,
<i class="no-highlight">905</i>&nbsp;                                            boolean isInternalDb)
<i class="no-highlight">906</i>&nbsp;        throws IllegalArgumentException {
<i class="no-highlight">907</i>&nbsp;
<i class="no-highlight">908</i>&nbsp;        /*
<i class="no-highlight">909</i>&nbsp;         * R/W database handles on a replicated database must be transactional,
<i class="no-highlight">910</i>&nbsp;         * for now. In the future we may support non-transactional database
<i class="no-highlight">911</i>&nbsp;         * handles.
<i class="no-highlight">912</i>&nbsp;         */
<b class="fc"><i class="no-highlight">913</i>&nbsp;        if (envImpl.isReplicated() &amp;&amp;</b>
<b class="nc"><i class="no-highlight">914</i>&nbsp;            dbConfig.getReplicated() &amp;&amp;</b>
<b class="nc"><i class="no-highlight">915</i>&nbsp;            !dbConfig.getReadOnly()) {</b>
<b class="nc"><i class="no-highlight">916</i>&nbsp;            if (!dbConfig.getTransactional()) {</b>
<b class="nc"><i class="no-highlight">917</i>&nbsp;                throw new IllegalArgumentException</b>
<i class="no-highlight">918</i>&nbsp;                (&quot;Read/Write Database instances for replicated &quot; +
<i class="no-highlight">919</i>&nbsp;                 &quot;database &quot; + databaseName + &quot; must be transactional.&quot;);
<i class="no-highlight">920</i>&nbsp;            }
<i class="no-highlight">921</i>&nbsp;        }
<i class="no-highlight">922</i>&nbsp;
<i class="no-highlight">923</i>&nbsp;        /* Check operation&#39;s transactional status against the Environment */
<b class="fc"><i class="no-highlight">924</i>&nbsp;        if (!isInternalDb &amp;&amp;</b>
<b class="fc"><i class="no-highlight">925</i>&nbsp;            dbConfig.getTransactional() &amp;&amp;</b>
<b class="nc"><i class="no-highlight">926</i>&nbsp;            !(envImpl.isTransactional())) {</b>
<b class="nc"><i class="no-highlight">927</i>&nbsp;            throw new IllegalArgumentException</b>
<i class="no-highlight">928</i>&nbsp;                (&quot;Attempted to open Database &quot; + databaseName +
<i class="no-highlight">929</i>&nbsp;                 &quot; transactionally, but parent Environment is&quot; +
<i class="no-highlight">930</i>&nbsp;                 &quot; not transactional&quot;);
<i class="no-highlight">931</i>&nbsp;        }
<i class="no-highlight">932</i>&nbsp;
<i class="no-highlight">933</i>&nbsp;        /* Check read/write status */
<b class="fc"><i class="no-highlight">934</i>&nbsp;        if (envImpl.isReadOnly() &amp;&amp; (!dbConfig.getReadOnly())) {</b>
<b class="nc"><i class="no-highlight">935</i>&nbsp;            throw new IllegalArgumentException</b>
<i class="no-highlight">936</i>&nbsp;                (&quot;Attempted to open Database &quot; + databaseName +
<i class="no-highlight">937</i>&nbsp;                 &quot; as writable but parent Environment is read only &quot;);
<i class="no-highlight">938</i>&nbsp;        }
<b class="fc"><i class="no-highlight">939</i>&nbsp;    }</b>
<i class="no-highlight">940</i>&nbsp;
<i class="no-highlight">941</i>&nbsp;    /**
<i class="no-highlight">942</i>&nbsp;     * Removes a database from the environment, discarding all records in the
<i class="no-highlight">943</i>&nbsp;     * database and removing the database name itself.
<i class="no-highlight">944</i>&nbsp;     *
<i class="no-highlight">945</i>&nbsp;     * &lt;p&gt;Compared to deleting all the records in a database individually,
<i class="no-highlight">946</i>&nbsp;     * {@code removeDatabase} is a very efficient operation.  Some internal
<i class="no-highlight">947</i>&nbsp;     * housekeeping information is updated, but the database records are not
<i class="no-highlight">948</i>&nbsp;     * read or written, and very little I/O is needed.&lt;/p&gt;
<i class="no-highlight">949</i>&nbsp;     *
<i class="no-highlight">950</i>&nbsp;     * &lt;p&gt;When called on a database configured with secondary indices, the
<i class="no-highlight">951</i>&nbsp;     * application is responsible for also removing all associated secondary
<i class="no-highlight">952</i>&nbsp;     * indices.  To guarantee integrity, a primary database and all of its
<i class="no-highlight">953</i>&nbsp;     * secondary databases should be removed atomically using a single
<i class="no-highlight">954</i>&nbsp;     * transaction.&lt;/p&gt;
<i class="no-highlight">955</i>&nbsp;     *
<i class="no-highlight">956</i>&nbsp;     * &lt;p&gt;Applications should not remove a database with open {@link Database
<i class="no-highlight">957</i>&nbsp;     * Database} handles.  If the database is open with the same transaction as
<i class="no-highlight">958</i>&nbsp;     * passed in the {@code txn} parameter, {@link IllegalStateException} is
<i class="no-highlight">959</i>&nbsp;     * thrown by this method.  If the database is open using a different
<i class="no-highlight">960</i>&nbsp;     * transaction, this method will block until all database handles are
<i class="no-highlight">961</i>&nbsp;     * closed, or until the conflict is resolved by throwing {@link
<i class="no-highlight">962</i>&nbsp;     * LockConflictException}.&lt;/p&gt;
<i class="no-highlight">963</i>&nbsp;     *
<i class="no-highlight">964</i>&nbsp;     * @param txn For a transactional environment, an explicit transaction
<i class="no-highlight">965</i>&nbsp;     * may be specified or null may be specified to use auto-commit.  For a
<i class="no-highlight">966</i>&nbsp;     * non-transactional environment, null must be specified.
<i class="no-highlight">967</i>&nbsp;     *
<i class="no-highlight">968</i>&nbsp;     * @param databaseName The database to be removed.
<i class="no-highlight">969</i>&nbsp;     *
<i class="no-highlight">970</i>&nbsp;     * @throws DatabaseNotFoundException if the database does not exist.
<i class="no-highlight">971</i>&nbsp;     *
<i class="no-highlight">972</i>&nbsp;     * @throws OperationFailureException if one of the &lt;a
<i class="no-highlight">973</i>&nbsp;     * href=&quot;../je/OperationFailureException.html#writeFailures&quot;&gt;Write
<i class="no-highlight">974</i>&nbsp;     * Operation Failures&lt;/a&gt; occurs.
<i class="no-highlight">975</i>&nbsp;     *
<i class="no-highlight">976</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">977</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">978</i>&nbsp;     *
<i class="no-highlight">979</i>&nbsp;     * @throws UnsupportedOperationException if this is a read-only
<i class="no-highlight">980</i>&nbsp;     * environment.
<i class="no-highlight">981</i>&nbsp;     *
<i class="no-highlight">982</i>&nbsp;     * @throws IllegalStateException if the database is currently open using
<i class="no-highlight">983</i>&nbsp;     * the transaction passed in the {@code txn} parameter, or if this handle
<i class="no-highlight">984</i>&nbsp;     * or the underlying environment has been closed.
<i class="no-highlight">985</i>&nbsp;     *
<i class="no-highlight">986</i>&nbsp;     * @throws IllegalArgumentException if an invalid parameter is specified.
<i class="no-highlight">987</i>&nbsp;     */
<i class="no-highlight">988</i>&nbsp;    public void removeDatabase(final Transaction txn,
<i class="no-highlight">989</i>&nbsp;                               final String databaseName)
<i class="no-highlight">990</i>&nbsp;        throws DatabaseNotFoundException {
<i class="no-highlight">991</i>&nbsp;
<b class="nc"><i class="no-highlight">992</i>&nbsp;        DatabaseUtil.checkForNullParam(databaseName, &quot;databaseName&quot;);</b>
<i class="no-highlight">993</i>&nbsp;
<b class="nc"><i class="no-highlight">994</i>&nbsp;        new DbNameOperation&lt;Void&gt;(txn) {</b>
<i class="no-highlight">995</i>&nbsp;
<i class="no-highlight">996</i>&nbsp;            Pair&lt;DatabaseImpl, Void&gt; runWork(final Locker locker)
<i class="no-highlight">997</i>&nbsp;                throws DatabaseNotFoundException,
<i class="no-highlight">998</i>&nbsp;                       DbTree.NeedRepLockerException {
<i class="no-highlight">999</i>&nbsp;
<b class="nc"><i class="no-highlight">1000</i>&nbsp;                final DatabaseImpl dbImpl =</b>
<b class="nc"><i class="no-highlight">1001</i>&nbsp;                    dbTree.dbRemove(locker, databaseName, null /*checkId*/);</b>
<i class="no-highlight">1002</i>&nbsp;
<b class="nc"><i class="no-highlight">1003</i>&nbsp;                return new Pair&lt;&gt;(dbImpl, null);</b>
<i class="no-highlight">1004</i>&nbsp;            }
<i class="no-highlight">1005</i>&nbsp;
<i class="no-highlight">1006</i>&nbsp;            void runTriggers(final Locker locker, final DatabaseImpl dbImpl) {
<b class="nc"><i class="no-highlight">1007</i>&nbsp;                TriggerManager.runRemoveTriggers(locker, dbImpl);</b>
<i class="no-highlight">1008</i>&nbsp;            }
<b class="nc"><i class="no-highlight">1009</i>&nbsp;        }.run();</b>
<b class="nc"><i class="no-highlight">1010</i>&nbsp;    }</b>
<i class="no-highlight">1011</i>&nbsp;
<i class="no-highlight">1012</i>&nbsp;    /**
<i class="no-highlight">1013</i>&nbsp;     * Renames a database, without removing the records it contains.
<i class="no-highlight">1014</i>&nbsp;     *
<i class="no-highlight">1015</i>&nbsp;     * &lt;p&gt;Applications should not rename a database with open {@link Database
<i class="no-highlight">1016</i>&nbsp;     * Database} handles.  If the database is open with the same transaction as
<i class="no-highlight">1017</i>&nbsp;     * passed in the {@code txn} parameter, {@link IllegalStateException} is
<i class="no-highlight">1018</i>&nbsp;     * thrown by this method.  If the database is open using a different
<i class="no-highlight">1019</i>&nbsp;     * transaction, this method will block until all database handles are
<i class="no-highlight">1020</i>&nbsp;     * closed, or until the conflict is resolved by throwing {@link
<i class="no-highlight">1021</i>&nbsp;     * LockConflictException}.&lt;/p&gt;
<i class="no-highlight">1022</i>&nbsp;     *
<i class="no-highlight">1023</i>&nbsp;     * @param txn For a transactional environment, an explicit transaction
<i class="no-highlight">1024</i>&nbsp;     * may be specified or null may be specified to use auto-commit.  For a
<i class="no-highlight">1025</i>&nbsp;     * non-transactional environment, null must be specified.
<i class="no-highlight">1026</i>&nbsp;     *
<i class="no-highlight">1027</i>&nbsp;     * @param databaseName The new name of the database.
<i class="no-highlight">1028</i>&nbsp;     *
<i class="no-highlight">1029</i>&nbsp;     * @throws DatabaseNotFoundException if the database does not exist.
<i class="no-highlight">1030</i>&nbsp;     *
<i class="no-highlight">1031</i>&nbsp;     * @throws OperationFailureException if one of the &lt;a
<i class="no-highlight">1032</i>&nbsp;     * href=&quot;../je/OperationFailureException.html#writeFailures&quot;&gt;Write
<i class="no-highlight">1033</i>&nbsp;     * Operation Failures&lt;/a&gt; occurs.
<i class="no-highlight">1034</i>&nbsp;     *
<i class="no-highlight">1035</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">1036</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">1037</i>&nbsp;     *
<i class="no-highlight">1038</i>&nbsp;     * @throws UnsupportedOperationException if this is a read-only
<i class="no-highlight">1039</i>&nbsp;     * environment.
<i class="no-highlight">1040</i>&nbsp;     *
<i class="no-highlight">1041</i>&nbsp;     * @throws IllegalStateException if the database is currently open using
<i class="no-highlight">1042</i>&nbsp;     * the transaction passed in the {@code txn} parameter, or if this handle
<i class="no-highlight">1043</i>&nbsp;     * or the underlying environment has been closed.
<i class="no-highlight">1044</i>&nbsp;     *
<i class="no-highlight">1045</i>&nbsp;     * @throws IllegalArgumentException if an invalid parameter is specified.
<i class="no-highlight">1046</i>&nbsp;     */
<i class="no-highlight">1047</i>&nbsp;    public void renameDatabase(final Transaction txn,
<i class="no-highlight">1048</i>&nbsp;                               final String databaseName,
<i class="no-highlight">1049</i>&nbsp;                               final String newName)
<i class="no-highlight">1050</i>&nbsp;        throws DatabaseNotFoundException {
<i class="no-highlight">1051</i>&nbsp;
<b class="nc"><i class="no-highlight">1052</i>&nbsp;        DatabaseUtil.checkForNullParam(databaseName, &quot;databaseName&quot;);</b>
<b class="nc"><i class="no-highlight">1053</i>&nbsp;        DatabaseUtil.checkForNullParam(newName, &quot;newName&quot;);</b>
<i class="no-highlight">1054</i>&nbsp;
<b class="nc"><i class="no-highlight">1055</i>&nbsp;        new DbNameOperation&lt;Void&gt;(txn) {</b>
<i class="no-highlight">1056</i>&nbsp;
<i class="no-highlight">1057</i>&nbsp;            Pair&lt;DatabaseImpl, Void&gt; runWork(final Locker locker)
<i class="no-highlight">1058</i>&nbsp;                throws DatabaseNotFoundException,
<i class="no-highlight">1059</i>&nbsp;                       DbTree.NeedRepLockerException {
<i class="no-highlight">1060</i>&nbsp;
<b class="nc"><i class="no-highlight">1061</i>&nbsp;                final DatabaseImpl dbImpl =</b>
<b class="nc"><i class="no-highlight">1062</i>&nbsp;                    dbTree.dbRename(locker, databaseName, newName);</b>
<i class="no-highlight">1063</i>&nbsp;
<b class="nc"><i class="no-highlight">1064</i>&nbsp;                return new Pair&lt;&gt;(dbImpl, null);</b>
<i class="no-highlight">1065</i>&nbsp;            }
<i class="no-highlight">1066</i>&nbsp;
<i class="no-highlight">1067</i>&nbsp;            void runTriggers(final Locker locker, final DatabaseImpl dbImpl) {
<b class="nc"><i class="no-highlight">1068</i>&nbsp;                TriggerManager.runRenameTriggers(locker, dbImpl, newName);</b>
<i class="no-highlight">1069</i>&nbsp;            }
<b class="nc"><i class="no-highlight">1070</i>&nbsp;        }.run();</b>
<b class="nc"><i class="no-highlight">1071</i>&nbsp;    }</b>
<i class="no-highlight">1072</i>&nbsp;
<i class="no-highlight">1073</i>&nbsp;    /**
<i class="no-highlight">1074</i>&nbsp;     * Empties the database, discarding all the records it contains, without
<i class="no-highlight">1075</i>&nbsp;     * removing the database name.
<i class="no-highlight">1076</i>&nbsp;     *
<i class="no-highlight">1077</i>&nbsp;     * &lt;p&gt;Compared to deleting all the records in a database individually,
<i class="no-highlight">1078</i>&nbsp;     * {@code truncateDatabase} is a very efficient operation.  Some internal
<i class="no-highlight">1079</i>&nbsp;     * housekeeping information is updated, but the database records are not
<i class="no-highlight">1080</i>&nbsp;     * read or written, and very little I/O is needed.&lt;/p&gt;
<i class="no-highlight">1081</i>&nbsp;     *
<i class="no-highlight">1082</i>&nbsp;     * &lt;p&gt;When called on a database configured with secondary indices, the
<i class="no-highlight">1083</i>&nbsp;     * application is responsible for also truncating all associated secondary
<i class="no-highlight">1084</i>&nbsp;     * indices.  To guarantee integrity, a primary database and all of its
<i class="no-highlight">1085</i>&nbsp;     * secondary databases should be truncated atomically using a single
<i class="no-highlight">1086</i>&nbsp;     * transaction.&lt;/p&gt;
<i class="no-highlight">1087</i>&nbsp;     *
<i class="no-highlight">1088</i>&nbsp;     * &lt;p&gt;Applications should not truncate a database with open {@link Database
<i class="no-highlight">1089</i>&nbsp;     * Database} handles.  If the database is open with the same transaction as
<i class="no-highlight">1090</i>&nbsp;     * passed in the {@code txn} parameter, {@link IllegalStateException} is
<i class="no-highlight">1091</i>&nbsp;     * thrown by this method.  If the database is open using a different
<i class="no-highlight">1092</i>&nbsp;     * transaction, this method will block until all database handles are
<i class="no-highlight">1093</i>&nbsp;     * closed, or until the conflict is resolved by throwing {@link
<i class="no-highlight">1094</i>&nbsp;     * LockConflictException}.&lt;/p&gt;
<i class="no-highlight">1095</i>&nbsp;     *
<i class="no-highlight">1096</i>&nbsp;     * @param txn For a transactional environment, an explicit transaction may
<i class="no-highlight">1097</i>&nbsp;     * be specified or null may be specified to use auto-commit.  For a
<i class="no-highlight">1098</i>&nbsp;     * non-transactional environment, null must be specified.
<i class="no-highlight">1099</i>&nbsp;     *
<i class="no-highlight">1100</i>&nbsp;     * @param databaseName The database to be truncated.
<i class="no-highlight">1101</i>&nbsp;     *
<i class="no-highlight">1102</i>&nbsp;     * @param returnCount If true, count and return the number of records
<i class="no-highlight">1103</i>&nbsp;     * discarded.
<i class="no-highlight">1104</i>&nbsp;     *
<i class="no-highlight">1105</i>&nbsp;     * @return The number of records discarded, or -1 if returnCount is false.
<i class="no-highlight">1106</i>&nbsp;     *
<i class="no-highlight">1107</i>&nbsp;     * @throws DatabaseNotFoundException if the database does not exist.
<i class="no-highlight">1108</i>&nbsp;     *
<i class="no-highlight">1109</i>&nbsp;     * @throws OperationFailureException if one of the &lt;a
<i class="no-highlight">1110</i>&nbsp;     * href=&quot;../je/OperationFailureException.html#writeFailures&quot;&gt;Write
<i class="no-highlight">1111</i>&nbsp;     * Operation Failures&lt;/a&gt; occurs.
<i class="no-highlight">1112</i>&nbsp;     *
<i class="no-highlight">1113</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">1114</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">1115</i>&nbsp;     *
<i class="no-highlight">1116</i>&nbsp;     * @throws UnsupportedOperationException if this is a read-only
<i class="no-highlight">1117</i>&nbsp;     * environment.
<i class="no-highlight">1118</i>&nbsp;     *
<i class="no-highlight">1119</i>&nbsp;     * @throws IllegalStateException if the database is currently open using
<i class="no-highlight">1120</i>&nbsp;     * the transaction passed in the {@code txn} parameter, or if this handle
<i class="no-highlight">1121</i>&nbsp;     * or the underlying environment has been closed.
<i class="no-highlight">1122</i>&nbsp;     *
<i class="no-highlight">1123</i>&nbsp;     * @throws IllegalArgumentException if an invalid parameter is specified.
<i class="no-highlight">1124</i>&nbsp;     */
<i class="no-highlight">1125</i>&nbsp;    public long truncateDatabase(final Transaction txn,
<i class="no-highlight">1126</i>&nbsp;                                 final String databaseName,
<i class="no-highlight">1127</i>&nbsp;                                 final boolean returnCount)
<i class="no-highlight">1128</i>&nbsp;        throws DatabaseNotFoundException {
<i class="no-highlight">1129</i>&nbsp;
<b class="nc"><i class="no-highlight">1130</i>&nbsp;        DatabaseUtil.checkForNullParam(databaseName, &quot;databaseName&quot;);</b>
<i class="no-highlight">1131</i>&nbsp;
<b class="nc"><i class="no-highlight">1132</i>&nbsp;        return (new DbNameOperation&lt;Long&gt;(txn) {</b>
<i class="no-highlight">1133</i>&nbsp;
<i class="no-highlight">1134</i>&nbsp;            Pair&lt;DatabaseImpl, Long&gt; runWork(final Locker locker)
<i class="no-highlight">1135</i>&nbsp;                throws DatabaseNotFoundException,
<i class="no-highlight">1136</i>&nbsp;                       DbTree.NeedRepLockerException {
<i class="no-highlight">1137</i>&nbsp;
<b class="nc"><i class="no-highlight">1138</i>&nbsp;                final TruncateDbResult result =</b>
<b class="nc"><i class="no-highlight">1139</i>&nbsp;                    dbTree.truncate(locker, databaseName, returnCount);</b>
<i class="no-highlight">1140</i>&nbsp;
<b class="nc"><i class="no-highlight">1141</i>&nbsp;                return new Pair&lt;&gt;(result.newDb, result.recordCount);</b>
<i class="no-highlight">1142</i>&nbsp;            }
<i class="no-highlight">1143</i>&nbsp;
<i class="no-highlight">1144</i>&nbsp;            void runTriggers(final Locker locker, final DatabaseImpl dbImpl) {
<b class="nc"><i class="no-highlight">1145</i>&nbsp;                TriggerManager.runTruncateTriggers(locker, dbImpl);</b>
<i class="no-highlight">1146</i>&nbsp;            }
<b class="nc"><i class="no-highlight">1147</i>&nbsp;        }).run();</b>
<i class="no-highlight">1148</i>&nbsp;    }
<i class="no-highlight">1149</i>&nbsp;
<i class="no-highlight">1150</i>&nbsp;    /**
<i class="no-highlight">1151</i>&nbsp;     * Runs a DB naming operation: remove, truncate or rename.  The common code
<i class="no-highlight">1152</i>&nbsp;     * is factored out here. In particular this class handles non-replicated
<i class="no-highlight">1153</i>&nbsp;     * DBs in a replicated environment, when auto-commit is used.
<i class="no-highlight">1154</i>&nbsp;     * &lt;p&gt;
<i class="no-highlight">1155</i>&nbsp;     * For a non-replicated DB, an auto-commit txn must be created by calling
<i class="no-highlight">1156</i>&nbsp;     * LockerFactory.getWritableLocker with the autoTxnIsReplicated param set
<i class="no-highlight">1157</i>&nbsp;     * to false.  If autoTxnIsReplicated is set to true in a replicated
<i class="no-highlight">1158</i>&nbsp;     * environment, HA consistency checks will be made when the txn is begun
<i class="no-highlight">1159</i>&nbsp;     * and acks will be enforced at commit.  For example, for an HA node in an
<i class="no-highlight">1160</i>&nbsp;     * unknown state, the consistency checks would fail and prevent performing
<i class="no-highlight">1161</i>&nbsp;     * the operation on the local/non-replicated DB.
<i class="no-highlight">1162</i>&nbsp;     * &lt;p&gt;
<i class="no-highlight">1163</i>&nbsp;     * Unfortunately, we need to create a txn/locker in order to query the DB
<i class="no-highlight">1164</i>&nbsp;     * metadata, to determine whether it is replicated.  Therefore, we always
<i class="no-highlight">1165</i>&nbsp;     * attempt the operation initially with autoTxnIsReplicated set to false.
<i class="no-highlight">1166</i>&nbsp;     * The DbTree name operation methods (see DbTree.lockNameLN) will throw an
<i class="no-highlight">1167</i>&nbsp;     * internal exception (NeedRepLockerException) if a non-replicated
<i class="no-highlight">1168</i>&nbsp;     * auto-commit txn is used on a replicated DB.  That signals this class to
<i class="no-highlight">1169</i>&nbsp;     * retry the operation with autoTxnIsReplicated set to true.
<i class="no-highlight">1170</i>&nbsp;     * &lt;p&gt;
<i class="no-highlight">1171</i>&nbsp;     * Via an unlikely series of DB renaming it is possible that on the 2nd try
<i class="no-highlight">1172</i>&nbsp;     * with a replicated txn, we find that the DB is non-replicated.  However,
<i class="no-highlight">1173</i>&nbsp;     * there is little harm in proceeding, since the consistency check is
<i class="no-highlight">1174</i>&nbsp;     * already done.
<i class="no-highlight">1175</i>&nbsp;     */
<i class="no-highlight">1176</i>&nbsp;    private abstract class DbNameOperation&lt;R&gt; {
<i class="no-highlight">1177</i>&nbsp;
<i class="no-highlight">1178</i>&nbsp;        private final EnvironmentImpl envImpl;
<i class="no-highlight">1179</i>&nbsp;        private final Transaction txn;
<i class="no-highlight">1180</i>&nbsp;        final DbTree dbTree;
<i class="no-highlight">1181</i>&nbsp;
<b class="nc"><i class="no-highlight">1182</i>&nbsp;        DbNameOperation(final Transaction txn) {</b>
<b class="nc"><i class="no-highlight">1183</i>&nbsp;            this.txn = txn;</b>
<b class="nc"><i class="no-highlight">1184</i>&nbsp;            this.envImpl = checkOpen();</b>
<b class="nc"><i class="no-highlight">1185</i>&nbsp;            checkWritable(envImpl);</b>
<i class="no-highlight">1186</i>&nbsp;
<b class="nc"><i class="no-highlight">1187</i>&nbsp;            dbTree = envImpl.getDbTree();</b>
<i class="no-highlight">1188</i>&nbsp;        }
<i class="no-highlight">1189</i>&nbsp;
<i class="no-highlight">1190</i>&nbsp;        /** Run the DB name operation. */
<i class="no-highlight">1191</i>&nbsp;        abstract Pair&lt;DatabaseImpl, R&gt; runWork(final Locker locker)
<i class="no-highlight">1192</i>&nbsp;            throws DatabaseNotFoundException, DbTree.NeedRepLockerException;
<i class="no-highlight">1193</i>&nbsp;
<i class="no-highlight">1194</i>&nbsp;        /** Run triggers after a successful DB name operation. */
<i class="no-highlight">1195</i>&nbsp;        abstract void runTriggers(final Locker locker,
<i class="no-highlight">1196</i>&nbsp;                                  final DatabaseImpl dbImpl);
<i class="no-highlight">1197</i>&nbsp;        
<i class="no-highlight">1198</i>&nbsp;        /**
<i class="no-highlight">1199</i>&nbsp;         * Try the operation with autoTxnIsReplicated=false, and then again
<i class="no-highlight">1200</i>&nbsp;         * with autoTxnIsReplicated=true if NeedRepLockerException is thrown.
<i class="no-highlight">1201</i>&nbsp;         */
<i class="no-highlight">1202</i>&nbsp;        R run() throws DatabaseNotFoundException {
<i class="no-highlight">1203</i>&nbsp;            try {
<b class="nc"><i class="no-highlight">1204</i>&nbsp;                return runOnce(getWritableLocker(false));</b>
<b class="nc"><i class="no-highlight">1205</i>&nbsp;            } catch (DbTree.NeedRepLockerException e) {</b>
<i class="no-highlight">1206</i>&nbsp;                try {
<b class="nc"><i class="no-highlight">1207</i>&nbsp;                    return runOnce(getWritableLocker(true));</b>
<b class="nc"><i class="no-highlight">1208</i>&nbsp;                } catch (DbTree.NeedRepLockerException e2) {</b>
<i class="no-highlight">1209</i>&nbsp;                    /* Should never happen. */
<b class="nc"><i class="no-highlight">1210</i>&nbsp;                    throw EnvironmentFailureException.unexpectedException(</b>
<i class="no-highlight">1211</i>&nbsp;                        envImpl, e);
<i class="no-highlight">1212</i>&nbsp;                }
<i class="no-highlight">1213</i>&nbsp;            }
<i class="no-highlight">1214</i>&nbsp;        }
<i class="no-highlight">1215</i>&nbsp;        
<i class="no-highlight">1216</i>&nbsp;        private R runOnce(final Locker locker)
<i class="no-highlight">1217</i>&nbsp;            throws DatabaseNotFoundException, DbTree.NeedRepLockerException {
<i class="no-highlight">1218</i>&nbsp;
<b class="nc"><i class="no-highlight">1219</i>&nbsp;            boolean success = false;</b>
<i class="no-highlight">1220</i>&nbsp;            try {
<b class="nc"><i class="no-highlight">1221</i>&nbsp;                final Pair&lt;DatabaseImpl, R&gt; results = runWork(locker);</b>
<b class="nc"><i class="no-highlight">1222</i>&nbsp;                final DatabaseImpl dbImpl = results.first();</b>
<b class="nc"><i class="no-highlight">1223</i>&nbsp;                if (dbImpl == null) {</b>
<i class="no-highlight">1224</i>&nbsp;                    /* Should never happen. */
<b class="nc"><i class="no-highlight">1225</i>&nbsp;                    throw EnvironmentFailureException.unexpectedState(envImpl);</b>
<i class="no-highlight">1226</i>&nbsp;                }
<b class="nc"><i class="no-highlight">1227</i>&nbsp;                success = true;</b>
<b class="nc"><i class="no-highlight">1228</i>&nbsp;                runTriggers(locker, dbImpl);</b>
<b class="nc"><i class="no-highlight">1229</i>&nbsp;                return results.second();</b>
<b class="nc"><i class="no-highlight">1230</i>&nbsp;            } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">1231</i>&nbsp;                envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">1232</i>&nbsp;                throw E;</b>
<i class="no-highlight">1233</i>&nbsp;            } finally {
<b class="nc"><i class="no-highlight">1234</i>&nbsp;                locker.operationEnd(success);</b>
<b class="nc"><i class="no-highlight">1235</i>&nbsp;            }</b>
<i class="no-highlight">1236</i>&nbsp;        }
<i class="no-highlight">1237</i>&nbsp;
<i class="no-highlight">1238</i>&nbsp;        private Locker getWritableLocker(boolean autoTxnIsReplicated) {
<b class="nc"><i class="no-highlight">1239</i>&nbsp;            return LockerFactory.getWritableLocker(</b>
<i class="no-highlight">1240</i>&nbsp;                Environment.this, txn, false /*isInternalDb*/,
<b class="nc"><i class="no-highlight">1241</i>&nbsp;                envImpl.isTransactional(), autoTxnIsReplicated);</b>
<i class="no-highlight">1242</i>&nbsp;        }
<i class="no-highlight">1243</i>&nbsp;    }
<i class="no-highlight">1244</i>&nbsp;
<i class="no-highlight">1245</i>&nbsp;    /**
<i class="no-highlight">1246</i>&nbsp;     * For unit testing.  Returns the current memory usage in bytes for all
<i class="no-highlight">1247</i>&nbsp;     * btrees in the envImpl.
<i class="no-highlight">1248</i>&nbsp;     */
<i class="no-highlight">1249</i>&nbsp;    long getMemoryUsage()
<i class="no-highlight">1250</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">1251</i>&nbsp;
<b class="nc"><i class="no-highlight">1252</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">1253</i>&nbsp;
<b class="nc"><i class="no-highlight">1254</i>&nbsp;        return envImpl.getMemoryBudget().getCacheMemoryUsage();</b>
<i class="no-highlight">1255</i>&nbsp;    }
<i class="no-highlight">1256</i>&nbsp;
<i class="no-highlight">1257</i>&nbsp;    /**
<i class="no-highlight">1258</i>&nbsp;     * Returns the database environment&#39;s home directory.
<i class="no-highlight">1259</i>&nbsp;     *
<i class="no-highlight">1260</i>&nbsp;     * This method may be called when the environment has been invalidated, but
<i class="no-highlight">1261</i>&nbsp;     * not yet closed. In other words, {@link EnvironmentFailureException} is
<i class="no-highlight">1262</i>&nbsp;     * never thrown by this method.
<i class="no-highlight">1263</i>&nbsp;     *
<i class="no-highlight">1264</i>&nbsp;     * @return The database environment&#39;s home directory.
<i class="no-highlight">1265</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">1266</i>&nbsp;     *
<i class="no-highlight">1267</i>&nbsp;     * @throws IllegalStateException if this handle has been closed.
<i class="no-highlight">1268</i>&nbsp;     */
<i class="no-highlight">1269</i>&nbsp;    public File getHome()
<i class="no-highlight">1270</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">1271</i>&nbsp;
<b class="nc"><i class="no-highlight">1272</i>&nbsp;        final EnvironmentImpl envImpl = getNonNullEnvImpl();</b>
<i class="no-highlight">1273</i>&nbsp;
<b class="nc"><i class="no-highlight">1274</i>&nbsp;        return envImpl.getEnvironmentHome();</b>
<i class="no-highlight">1275</i>&nbsp;    }
<i class="no-highlight">1276</i>&nbsp;
<i class="no-highlight">1277</i>&nbsp;    /*
<i class="no-highlight">1278</i>&nbsp;     * Transaction management
<i class="no-highlight">1279</i>&nbsp;     */
<i class="no-highlight">1280</i>&nbsp;
<i class="no-highlight">1281</i>&nbsp;    /**
<i class="no-highlight">1282</i>&nbsp;     * Returns the default txn config for this environment handle.
<i class="no-highlight">1283</i>&nbsp;     */
<i class="no-highlight">1284</i>&nbsp;    TransactionConfig getDefaultTxnConfig() {
<b class="nc"><i class="no-highlight">1285</i>&nbsp;        return defaultTxnConfig;</b>
<i class="no-highlight">1286</i>&nbsp;    }
<i class="no-highlight">1287</i>&nbsp;
<i class="no-highlight">1288</i>&nbsp;    /**
<i class="no-highlight">1289</i>&nbsp;     * Copies the handle properties out of the config properties, and
<i class="no-highlight">1290</i>&nbsp;     * initializes the default transaction config.
<i class="no-highlight">1291</i>&nbsp;     */
<i class="no-highlight">1292</i>&nbsp;    private void copyToHandleConfig(EnvironmentMutableConfig useConfig,
<i class="no-highlight">1293</i>&nbsp;                                    EnvironmentConfig initStaticConfig,
<i class="no-highlight">1294</i>&nbsp;                                    RepConfigProxy initRepConfig) {
<i class="no-highlight">1295</i>&nbsp;
<i class="no-highlight">1296</i>&nbsp;        /*
<i class="no-highlight">1297</i>&nbsp;         * Create the new objects, initialize them, then change the instance
<i class="no-highlight">1298</i>&nbsp;         * fields. This avoids synchronization issues.
<i class="no-highlight">1299</i>&nbsp;         */
<b class="fc"><i class="no-highlight">1300</i>&nbsp;        EnvironmentMutableConfig newHandleConfig =</b>
<i class="no-highlight">1301</i>&nbsp;            new EnvironmentMutableConfig();
<b class="fc"><i class="no-highlight">1302</i>&nbsp;        useConfig.copyHandlePropsTo(newHandleConfig);</b>
<b class="fc"><i class="no-highlight">1303</i>&nbsp;        this.handleConfig = newHandleConfig;</b>
<i class="no-highlight">1304</i>&nbsp;
<b class="fc"><i class="no-highlight">1305</i>&nbsp;        TransactionConfig newTxnConfig =</b>
<b class="fc"><i class="no-highlight">1306</i>&nbsp;            TransactionConfig.DEFAULT.clone();</b>
<b class="fc"><i class="no-highlight">1307</i>&nbsp;        newTxnConfig.setNoSync(handleConfig.getTxnNoSync());</b>
<b class="fc"><i class="no-highlight">1308</i>&nbsp;        newTxnConfig.setWriteNoSync(handleConfig.getTxnWriteNoSync());</b>
<b class="fc"><i class="no-highlight">1309</i>&nbsp;        newTxnConfig.setDurability(handleConfig.getDurability());</b>
<i class="no-highlight">1310</i>&nbsp;
<b class="fc"><i class="no-highlight">1311</i>&nbsp;        if (initStaticConfig != null) {</b>
<b class="fc"><i class="no-highlight">1312</i>&nbsp;            newTxnConfig.setSerializableIsolation</b>
<b class="fc"><i class="no-highlight">1313</i>&nbsp;                (initStaticConfig.getTxnSerializableIsolation());</b>
<b class="fc"><i class="no-highlight">1314</i>&nbsp;            newTxnConfig.setReadCommitted</b>
<b class="fc"><i class="no-highlight">1315</i>&nbsp;                (initStaticConfig.getTxnReadCommitted());</b>
<i class="no-highlight">1316</i>&nbsp;        } else {
<b class="nc"><i class="no-highlight">1317</i>&nbsp;            newTxnConfig.setSerializableIsolation</b>
<b class="nc"><i class="no-highlight">1318</i>&nbsp;                (defaultTxnConfig.getSerializableIsolation());</b>
<b class="nc"><i class="no-highlight">1319</i>&nbsp;            newTxnConfig.setReadCommitted</b>
<b class="nc"><i class="no-highlight">1320</i>&nbsp;                (defaultTxnConfig.getReadCommitted());</b>
<b class="nc"><i class="no-highlight">1321</i>&nbsp;            newTxnConfig.setConsistencyPolicy</b>
<b class="nc"><i class="no-highlight">1322</i>&nbsp;                (defaultTxnConfig.getConsistencyPolicy());</b>
<i class="no-highlight">1323</i>&nbsp;        }
<b class="fc"><i class="no-highlight">1324</i>&nbsp;        if (initRepConfig != null) {</b>
<b class="nc"><i class="no-highlight">1325</i>&nbsp;            newTxnConfig.setConsistencyPolicy</b>
<b class="nc"><i class="no-highlight">1326</i>&nbsp;                (initRepConfig.getConsistencyPolicy());</b>
<i class="no-highlight">1327</i>&nbsp;        }
<b class="fc"><i class="no-highlight">1328</i>&nbsp;        this.defaultTxnConfig = newTxnConfig;</b>
<b class="fc"><i class="no-highlight">1329</i>&nbsp;    }</b>
<i class="no-highlight">1330</i>&nbsp;
<i class="no-highlight">1331</i>&nbsp;    /**
<i class="no-highlight">1332</i>&nbsp;     * Creates a new transaction in the database environment.
<i class="no-highlight">1333</i>&nbsp;     *
<i class="no-highlight">1334</i>&nbsp;     * &lt;p&gt;Transaction handles are free-threaded; transactions handles may be
<i class="no-highlight">1335</i>&nbsp;     * used concurrently by multiple threads.&lt;/p&gt;
<i class="no-highlight">1336</i>&nbsp;     *
<i class="no-highlight">1337</i>&nbsp;     * &lt;p&gt;Cursors may not span transactions; that is, each cursor must be
<i class="no-highlight">1338</i>&nbsp;     * opened and closed within a single transaction. The parent parameter is a
<i class="no-highlight">1339</i>&nbsp;     * placeholder for nested transactions, and must currently be null.&lt;/p&gt;
<i class="no-highlight">1340</i>&nbsp;     *
<i class="no-highlight">1341</i>&nbsp;     * @param txnConfig The transaction attributes.  If null, default
<i class="no-highlight">1342</i>&nbsp;     * attributes are used.
<i class="no-highlight">1343</i>&nbsp;     *
<i class="no-highlight">1344</i>&nbsp;     * @return The newly created transaction&#39;s handle.
<i class="no-highlight">1345</i>&nbsp;     *
<i class="no-highlight">1346</i>&nbsp;     * @throws com.sleepycat.je.rep.InsufficientReplicasException if the Master
<i class="no-highlight">1347</i>&nbsp;     * in a replicated environment could not contact a quorum of replicas as
<i class="no-highlight">1348</i>&nbsp;     * determined by the {@link ReplicaAckPolicy}.
<i class="no-highlight">1349</i>&nbsp;     *
<i class="no-highlight">1350</i>&nbsp;     * @throws com.sleepycat.je.rep.ReplicaConsistencyException if a replica
<i class="no-highlight">1351</i>&nbsp;     * in a replicated environment cannot become consistent within the timeout
<i class="no-highlight">1352</i>&nbsp;     * period.
<i class="no-highlight">1353</i>&nbsp;     *
<i class="no-highlight">1354</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">1355</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">1356</i>&nbsp;     *
<i class="no-highlight">1357</i>&nbsp;     * @throws UnsupportedOperationException if this is not a transactional
<i class="no-highlight">1358</i>&nbsp;     * environment.
<i class="no-highlight">1359</i>&nbsp;     *
<i class="no-highlight">1360</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">1361</i>&nbsp;     * environment has been closed.
<i class="no-highlight">1362</i>&nbsp;     *
<i class="no-highlight">1363</i>&nbsp;     * @throws IllegalArgumentException if an invalid parameter is specified,
<i class="no-highlight">1364</i>&nbsp;     * for example, an invalid {@code TransactionConfig} parameter.
<i class="no-highlight">1365</i>&nbsp;     */
<i class="no-highlight">1366</i>&nbsp;    public Transaction beginTransaction(Transaction parent,
<i class="no-highlight">1367</i>&nbsp;                                        TransactionConfig txnConfig)
<i class="no-highlight">1368</i>&nbsp;        throws DatabaseException,
<i class="no-highlight">1369</i>&nbsp;               IllegalArgumentException {
<i class="no-highlight">1370</i>&nbsp;
<i class="no-highlight">1371</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">1372</i>&nbsp;            return beginTransactionInternal(parent, txnConfig,</b>
<i class="no-highlight">1373</i>&nbsp;                                            false /*isInternalTxn*/);
<b class="nc"><i class="no-highlight">1374</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">1375</i>&nbsp;            invalidate(E);</b>
<b class="nc"><i class="no-highlight">1376</i>&nbsp;            throw E;</b>
<i class="no-highlight">1377</i>&nbsp;        }
<i class="no-highlight">1378</i>&nbsp;    }
<i class="no-highlight">1379</i>&nbsp;
<i class="no-highlight">1380</i>&nbsp;    /**
<i class="no-highlight">1381</i>&nbsp;     * Like beginTransaction, but does not require that the Environment is
<i class="no-highlight">1382</i>&nbsp;     * transactional.
<i class="no-highlight">1383</i>&nbsp;     */
<i class="no-highlight">1384</i>&nbsp;    Transaction beginInternalTransaction(TransactionConfig txnConfig) {
<b class="nc"><i class="no-highlight">1385</i>&nbsp;        return beginTransactionInternal(null /*parent*/, txnConfig,</b>
<i class="no-highlight">1386</i>&nbsp;                                        true /*isInternalTxn*/);
<i class="no-highlight">1387</i>&nbsp;    }
<i class="no-highlight">1388</i>&nbsp;
<i class="no-highlight">1389</i>&nbsp;    /**
<i class="no-highlight">1390</i>&nbsp;     * @throws IllegalArgumentException via beginTransaction.
<i class="no-highlight">1391</i>&nbsp;     * @throws UnsupportedOperationException via beginTransaction.
<i class="no-highlight">1392</i>&nbsp;     */
<i class="no-highlight">1393</i>&nbsp;    private Transaction beginTransactionInternal(Transaction parent,
<i class="no-highlight">1394</i>&nbsp;                                                 TransactionConfig txnConfig,
<i class="no-highlight">1395</i>&nbsp;                                                 boolean isInternalTxn )
<i class="no-highlight">1396</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">1397</i>&nbsp;
<b class="nc"><i class="no-highlight">1398</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">1399</i>&nbsp;
<b class="nc"><i class="no-highlight">1400</i>&nbsp;        if (parent != null) {</b>
<b class="nc"><i class="no-highlight">1401</i>&nbsp;            throw new IllegalArgumentException</b>
<i class="no-highlight">1402</i>&nbsp;                (&quot;Parent txn is non-null. &quot; +
<i class="no-highlight">1403</i>&nbsp;                 &quot;Nested transactions are not supported.&quot;);
<i class="no-highlight">1404</i>&nbsp;        }
<i class="no-highlight">1405</i>&nbsp;
<b class="nc"><i class="no-highlight">1406</i>&nbsp;        if (!isInternalTxn &amp;&amp; !envImpl.isTransactional()) {</b>
<b class="nc"><i class="no-highlight">1407</i>&nbsp;            throw new UnsupportedOperationException</b>
<i class="no-highlight">1408</i>&nbsp;                (&quot;Transactions can not be used in a non-transactional &quot; +
<i class="no-highlight">1409</i>&nbsp;                 &quot;environment&quot;);
<i class="no-highlight">1410</i>&nbsp;        }
<i class="no-highlight">1411</i>&nbsp;
<b class="nc"><i class="no-highlight">1412</i>&nbsp;        checkTxnConfig(txnConfig);</b>
<i class="no-highlight">1413</i>&nbsp;
<i class="no-highlight">1414</i>&nbsp;        /*
<i class="no-highlight">1415</i>&nbsp;         * Apply txn config defaults.  We don&#39;t need to clone unless we have to
<i class="no-highlight">1416</i>&nbsp;         * apply the env default, since we don&#39;t hold onto a txn config
<i class="no-highlight">1417</i>&nbsp;         * reference.
<i class="no-highlight">1418</i>&nbsp;         */
<b class="nc"><i class="no-highlight">1419</i>&nbsp;        TransactionConfig useConfig = null;</b>
<b class="nc"><i class="no-highlight">1420</i>&nbsp;        if (txnConfig == null) {</b>
<b class="nc"><i class="no-highlight">1421</i>&nbsp;            useConfig = defaultTxnConfig;</b>
<i class="no-highlight">1422</i>&nbsp;        } else {
<b class="nc"><i class="no-highlight">1423</i>&nbsp;            if (defaultTxnConfig.getNoSync() ||</b>
<b class="nc"><i class="no-highlight">1424</i>&nbsp;                defaultTxnConfig.getWriteNoSync()) {</b>
<i class="no-highlight">1425</i>&nbsp;
<i class="no-highlight">1426</i>&nbsp;                /*
<i class="no-highlight">1427</i>&nbsp;                 * The environment sync settings have been set, check if any
<i class="no-highlight">1428</i>&nbsp;                 * were set in the user&#39;s txn config. If none were set in the
<i class="no-highlight">1429</i>&nbsp;                 * user&#39;s config, apply the environment defaults
<i class="no-highlight">1430</i>&nbsp;                 */
<b class="nc"><i class="no-highlight">1431</i>&nbsp;                if (!txnConfig.getNoSync() &amp;&amp;</b>
<b class="nc"><i class="no-highlight">1432</i>&nbsp;                    !txnConfig.getSync() &amp;&amp;</b>
<b class="nc"><i class="no-highlight">1433</i>&nbsp;                    !txnConfig.getWriteNoSync()) {</b>
<b class="nc"><i class="no-highlight">1434</i>&nbsp;                    useConfig = txnConfig.clone();</b>
<b class="nc"><i class="no-highlight">1435</i>&nbsp;                    if (defaultTxnConfig.getWriteNoSync()) {</b>
<b class="nc"><i class="no-highlight">1436</i>&nbsp;                        useConfig.setWriteNoSync(true);</b>
<i class="no-highlight">1437</i>&nbsp;                    } else {
<b class="nc"><i class="no-highlight">1438</i>&nbsp;                        useConfig.setNoSync(true);</b>
<i class="no-highlight">1439</i>&nbsp;                    }
<i class="no-highlight">1440</i>&nbsp;                }
<i class="no-highlight">1441</i>&nbsp;            }
<i class="no-highlight">1442</i>&nbsp;
<b class="nc"><i class="no-highlight">1443</i>&nbsp;            if ((defaultTxnConfig.getDurability() != null) &amp;&amp;</b>
<b class="nc"><i class="no-highlight">1444</i>&nbsp;                 (txnConfig.getDurability() == null)) {</b>
<i class="no-highlight">1445</i>&nbsp;
<i class="no-highlight">1446</i>&nbsp;                /*
<i class="no-highlight">1447</i>&nbsp;                 * Inherit transaction durability from the environment in the
<i class="no-highlight">1448</i>&nbsp;                 * absence of an explicit transaction config durability.
<i class="no-highlight">1449</i>&nbsp;                 */
<b class="nc"><i class="no-highlight">1450</i>&nbsp;                if (useConfig == null) {</b>
<b class="nc"><i class="no-highlight">1451</i>&nbsp;                    useConfig = txnConfig.clone();</b>
<i class="no-highlight">1452</i>&nbsp;                }
<b class="nc"><i class="no-highlight">1453</i>&nbsp;                useConfig.setDurability(defaultTxnConfig.getDurability());</b>
<i class="no-highlight">1454</i>&nbsp;            }
<i class="no-highlight">1455</i>&nbsp;
<b class="nc"><i class="no-highlight">1456</i>&nbsp;            if ((defaultTxnConfig.getConsistencyPolicy() != null) &amp;&amp;</b>
<b class="nc"><i class="no-highlight">1457</i>&nbsp;                (txnConfig.getConsistencyPolicy() == null)) {</b>
<b class="nc"><i class="no-highlight">1458</i>&nbsp;                   if (useConfig == null) {</b>
<b class="nc"><i class="no-highlight">1459</i>&nbsp;                       useConfig = txnConfig.clone();</b>
<i class="no-highlight">1460</i>&nbsp;                   }
<b class="nc"><i class="no-highlight">1461</i>&nbsp;                   useConfig.setConsistencyPolicy</b>
<b class="nc"><i class="no-highlight">1462</i>&nbsp;                       (defaultTxnConfig.getConsistencyPolicy());</b>
<i class="no-highlight">1463</i>&nbsp;            }
<i class="no-highlight">1464</i>&nbsp;
<i class="no-highlight">1465</i>&nbsp;            /* Apply isolation level default. */
<b class="nc"><i class="no-highlight">1466</i>&nbsp;            if (!txnConfig.getSerializableIsolation() &amp;&amp;</b>
<b class="nc"><i class="no-highlight">1467</i>&nbsp;                !txnConfig.getReadCommitted() &amp;&amp;</b>
<b class="nc"><i class="no-highlight">1468</i>&nbsp;                !txnConfig.getReadUncommitted()) {</b>
<b class="nc"><i class="no-highlight">1469</i>&nbsp;                if (defaultTxnConfig.getSerializableIsolation()) {</b>
<b class="nc"><i class="no-highlight">1470</i>&nbsp;                    if (useConfig == null) {</b>
<b class="nc"><i class="no-highlight">1471</i>&nbsp;                        useConfig = txnConfig.clone();</b>
<i class="no-highlight">1472</i>&nbsp;                    }
<b class="nc"><i class="no-highlight">1473</i>&nbsp;                    useConfig.setSerializableIsolation(true);</b>
<b class="nc"><i class="no-highlight">1474</i>&nbsp;                } else if (defaultTxnConfig.getReadCommitted()) {</b>
<b class="nc"><i class="no-highlight">1475</i>&nbsp;                    if (useConfig == null) {</b>
<b class="nc"><i class="no-highlight">1476</i>&nbsp;                        useConfig = txnConfig.clone();</b>
<i class="no-highlight">1477</i>&nbsp;                    }
<b class="nc"><i class="no-highlight">1478</i>&nbsp;                    useConfig.setReadCommitted(true);</b>
<i class="no-highlight">1479</i>&nbsp;                }
<i class="no-highlight">1480</i>&nbsp;            }
<i class="no-highlight">1481</i>&nbsp;
<i class="no-highlight">1482</i>&nbsp;            /* No environment level defaults applied. */
<b class="nc"><i class="no-highlight">1483</i>&nbsp;            if (useConfig == null) {</b>
<b class="nc"><i class="no-highlight">1484</i>&nbsp;                useConfig = txnConfig;</b>
<i class="no-highlight">1485</i>&nbsp;            }
<i class="no-highlight">1486</i>&nbsp;        }
<b class="nc"><i class="no-highlight">1487</i>&nbsp;        Txn internalTxn = envImpl.txnBegin(parent, useConfig);</b>
<b class="nc"><i class="no-highlight">1488</i>&nbsp;        Transaction txn = new Transaction(this, internalTxn);</b>
<b class="nc"><i class="no-highlight">1489</i>&nbsp;        addReferringHandle(txn);</b>
<b class="nc"><i class="no-highlight">1490</i>&nbsp;        return txn;</b>
<i class="no-highlight">1491</i>&nbsp;    }
<i class="no-highlight">1492</i>&nbsp;
<i class="no-highlight">1493</i>&nbsp;    /**
<i class="no-highlight">1494</i>&nbsp;     * Checks the txnConfig object to ensure that its correctly configured and
<i class="no-highlight">1495</i>&nbsp;     * is compatible with the configuration of the Environment.
<i class="no-highlight">1496</i>&nbsp;     *
<i class="no-highlight">1497</i>&nbsp;     * @param txnConfig the configuration being checked.
<i class="no-highlight">1498</i>&nbsp;     *
<i class="no-highlight">1499</i>&nbsp;     * @throws IllegalArgumentException via beginTransaction
<i class="no-highlight">1500</i>&nbsp;     */
<i class="no-highlight">1501</i>&nbsp;    private void checkTxnConfig(TransactionConfig txnConfig)
<i class="no-highlight">1502</i>&nbsp;        throws IllegalArgumentException {
<i class="no-highlight">1503</i>&nbsp;
<b class="nc"><i class="no-highlight">1504</i>&nbsp;        if (txnConfig == null) {</b>
<b class="nc"><i class="no-highlight">1505</i>&nbsp;            return;</b>
<i class="no-highlight">1506</i>&nbsp;        }
<b class="nc"><i class="no-highlight">1507</i>&nbsp;        if ((txnConfig.getSerializableIsolation() &amp;&amp;</b>
<b class="nc"><i class="no-highlight">1508</i>&nbsp;             txnConfig.getReadUncommitted()) ||</b>
<b class="nc"><i class="no-highlight">1509</i>&nbsp;            (txnConfig.getSerializableIsolation() &amp;&amp;</b>
<b class="nc"><i class="no-highlight">1510</i>&nbsp;             txnConfig.getReadCommitted()) ||</b>
<b class="nc"><i class="no-highlight">1511</i>&nbsp;            (txnConfig.getReadUncommitted() &amp;&amp;</b>
<b class="nc"><i class="no-highlight">1512</i>&nbsp;             txnConfig.getReadCommitted())) {</b>
<b class="nc"><i class="no-highlight">1513</i>&nbsp;            throw new IllegalArgumentException</b>
<i class="no-highlight">1514</i>&nbsp;                (&quot;Only one may be specified: SerializableIsolation, &quot; +
<i class="no-highlight">1515</i>&nbsp;                &quot;ReadCommitted or ReadUncommitted&quot;);
<i class="no-highlight">1516</i>&nbsp;        }
<b class="nc"><i class="no-highlight">1517</i>&nbsp;        if ((txnConfig.getDurability() != null) &amp;&amp;</b>
<b class="nc"><i class="no-highlight">1518</i>&nbsp;            ((defaultTxnConfig.getSync() ||</b>
<b class="nc"><i class="no-highlight">1519</i>&nbsp;              defaultTxnConfig.getNoSync() ||</b>
<b class="nc"><i class="no-highlight">1520</i>&nbsp;              defaultTxnConfig.getWriteNoSync()))) {</b>
<b class="nc"><i class="no-highlight">1521</i>&nbsp;           throw new IllegalArgumentException</b>
<i class="no-highlight">1522</i>&nbsp;               (&quot;Mixed use of deprecated durability API for the &quot; +
<i class="no-highlight">1523</i>&nbsp;                &quot;Environment with the new durability API for &quot; +
<i class="no-highlight">1524</i>&nbsp;                &quot;TransactionConfig.setDurability()&quot;);
<i class="no-highlight">1525</i>&nbsp;        }
<b class="nc"><i class="no-highlight">1526</i>&nbsp;        if ((defaultTxnConfig.getDurability() != null) &amp;&amp;</b>
<b class="nc"><i class="no-highlight">1527</i>&nbsp;            ((txnConfig.getSync() ||</b>
<b class="nc"><i class="no-highlight">1528</i>&nbsp;              txnConfig.getNoSync() ||</b>
<b class="nc"><i class="no-highlight">1529</i>&nbsp;              txnConfig.getWriteNoSync()))) {</b>
<b class="nc"><i class="no-highlight">1530</i>&nbsp;            throw new IllegalArgumentException</b>
<i class="no-highlight">1531</i>&nbsp;                   (&quot;Mixed use of new durability API for the &quot; +
<i class="no-highlight">1532</i>&nbsp;                    &quot;Environment with the deprecated durability API for &quot; +
<i class="no-highlight">1533</i>&nbsp;                    &quot;TransactionConfig.&quot;);
<i class="no-highlight">1534</i>&nbsp;        }
<b class="nc"><i class="no-highlight">1535</i>&nbsp;    }</b>
<i class="no-highlight">1536</i>&nbsp;
<i class="no-highlight">1537</i>&nbsp;    /**
<i class="no-highlight">1538</i>&nbsp;     * Synchronously checkpoint the database environment.
<i class="no-highlight">1539</i>&nbsp;     * &lt;p&gt;
<i class="no-highlight">1540</i>&nbsp;     * This is an optional action for the application since this activity
<i class="no-highlight">1541</i>&nbsp;     * is, by default, handled by a database environment owned background
<i class="no-highlight">1542</i>&nbsp;     * thread.
<i class="no-highlight">1543</i>&nbsp;     * &lt;p&gt;
<i class="no-highlight">1544</i>&nbsp;     * A checkpoint has the side effect of flushing all preceding
<i class="no-highlight">1545</i>&nbsp;     * non-transactional write operations, as well as any preceding
<i class="no-highlight">1546</i>&nbsp;     * transactions that were committed with {@link
<i class="no-highlight">1547</i>&nbsp;     * Durability.SyncPolicy#NO_SYNC no-sync durability}.  However, for best
<i class="no-highlight">1548</i>&nbsp;     * performance, checkpoints should be used only to bound recovery time.
<i class="no-highlight">1549</i>&nbsp;     * {@link #flushLog} can be used to write buffered data for durability
<i class="no-highlight">1550</i>&nbsp;     * purposes.
<i class="no-highlight">1551</i>&nbsp;     *
<i class="no-highlight">1552</i>&nbsp;     * @param ckptConfig The checkpoint attributes.  If null, default
<i class="no-highlight">1553</i>&nbsp;     * attributes are used.
<i class="no-highlight">1554</i>&nbsp;     *
<i class="no-highlight">1555</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">1556</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">1557</i>&nbsp;     *
<i class="no-highlight">1558</i>&nbsp;     * @throws DiskLimitException if the checkpoint cannot be performed
<i class="no-highlight">1559</i>&nbsp;     * because a disk limit has been violated.
<i class="no-highlight">1560</i>&nbsp;     *
<i class="no-highlight">1561</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">1562</i>&nbsp;     * environment has been closed.
<i class="no-highlight">1563</i>&nbsp;     */
<i class="no-highlight">1564</i>&nbsp;    public void checkpoint(CheckpointConfig ckptConfig)
<i class="no-highlight">1565</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">1566</i>&nbsp;
<b class="nc"><i class="no-highlight">1567</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">1568</i>&nbsp;
<b class="nc"><i class="no-highlight">1569</i>&nbsp;        if (ckptConfig == null) {</b>
<b class="nc"><i class="no-highlight">1570</i>&nbsp;            ckptConfig = CheckpointConfig.DEFAULT;</b>
<i class="no-highlight">1571</i>&nbsp;        }
<i class="no-highlight">1572</i>&nbsp;
<i class="no-highlight">1573</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">1574</i>&nbsp;            envImpl.invokeCheckpoint(ckptConfig, &quot;api&quot;);</b>
<b class="nc"><i class="no-highlight">1575</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">1576</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">1577</i>&nbsp;            throw E;</b>
<b class="nc"><i class="no-highlight">1578</i>&nbsp;        }</b>
<b class="nc"><i class="no-highlight">1579</i>&nbsp;    }</b>
<i class="no-highlight">1580</i>&nbsp;
<i class="no-highlight">1581</i>&nbsp;    /**
<i class="no-highlight">1582</i>&nbsp;     * Synchronously flushes database environment databases to stable storage.
<i class="no-highlight">1583</i>&nbsp;     * Calling this method is equivalent to forcing a checkpoint and setting
<i class="no-highlight">1584</i>&nbsp;     * {@link CheckpointConfig#setMinimizeRecoveryTime} to true.
<i class="no-highlight">1585</i>&nbsp;     * &lt;p&gt;
<i class="no-highlight">1586</i>&nbsp;     * A checkpoint has the side effect of flushing all preceding
<i class="no-highlight">1587</i>&nbsp;     * non-transactional write operations, as well as any preceding
<i class="no-highlight">1588</i>&nbsp;     * transactions that were committed with {@link
<i class="no-highlight">1589</i>&nbsp;     * Durability.SyncPolicy#NO_SYNC no-sync durability}.  However, for best
<i class="no-highlight">1590</i>&nbsp;     * performance, checkpoints should be used only to bound recovery time.
<i class="no-highlight">1591</i>&nbsp;     * {@link #flushLog} can be used to write buffered data for durability
<i class="no-highlight">1592</i>&nbsp;     * purposes.
<i class="no-highlight">1593</i>&nbsp;     *
<i class="no-highlight">1594</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">1595</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">1596</i>&nbsp;     *
<i class="no-highlight">1597</i>&nbsp;     * @throws DiskLimitException if the sync cannot be performed
<i class="no-highlight">1598</i>&nbsp;     * because a disk limit has been violated.
<i class="no-highlight">1599</i>&nbsp;     *
<i class="no-highlight">1600</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">1601</i>&nbsp;     * environment has been closed.
<i class="no-highlight">1602</i>&nbsp;     */
<i class="no-highlight">1603</i>&nbsp;    public void sync()
<i class="no-highlight">1604</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">1605</i>&nbsp;
<b class="nc"><i class="no-highlight">1606</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">1607</i>&nbsp;
<i class="no-highlight">1608</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">1609</i>&nbsp;            final CheckpointConfig config = new CheckpointConfig();</b>
<b class="nc"><i class="no-highlight">1610</i>&nbsp;            config.setForce(true);</b>
<b class="nc"><i class="no-highlight">1611</i>&nbsp;            config.setMinimizeRecoveryTime(true);</b>
<i class="no-highlight">1612</i>&nbsp;
<b class="nc"><i class="no-highlight">1613</i>&nbsp;            envImpl.invokeCheckpoint(config, &quot;sync&quot;);</b>
<b class="nc"><i class="no-highlight">1614</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">1615</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">1616</i>&nbsp;            throw E;</b>
<b class="nc"><i class="no-highlight">1617</i>&nbsp;        }</b>
<b class="nc"><i class="no-highlight">1618</i>&nbsp;    }</b>
<i class="no-highlight">1619</i>&nbsp;
<i class="no-highlight">1620</i>&nbsp;    /**
<i class="no-highlight">1621</i>&nbsp;     * Writes buffered data to the log, and optionally performs an fsync to
<i class="no-highlight">1622</i>&nbsp;     * guarantee that data is written to the physical device.
<i class="no-highlight">1623</i>&nbsp;     * &lt;p&gt;
<i class="no-highlight">1624</i>&nbsp;     * This method is used to make durable, by writing to the log, all
<i class="no-highlight">1625</i>&nbsp;     * preceding non-transactional write operations, as well as any preceding
<i class="no-highlight">1626</i>&nbsp;     * transactions that were committed with {@link
<i class="no-highlight">1627</i>&nbsp;     * Durability.SyncPolicy#NO_SYNC no-sync durability}.  If the {@code fsync}
<i class="no-highlight">1628</i>&nbsp;     * parameter is true, it can also be used to flush all logged data to the
<i class="no-highlight">1629</i>&nbsp;     * physical storage device, by performing an fsync.
<i class="no-highlight">1630</i>&nbsp;     * &lt;p&gt;
<i class="no-highlight">1631</i>&nbsp;     * Note that this method &lt;em&gt;does not&lt;/em&gt; flush previously unwritten data
<i class="no-highlight">1632</i>&nbsp;     * in deferred-write databases; that is done by calling {@link
<i class="no-highlight">1633</i>&nbsp;     * Database#sync} or performing a checkpoint.
<i class="no-highlight">1634</i>&nbsp;     *
<i class="no-highlight">1635</i>&nbsp;     * @param fsync is true to perform an fsync as well as a file write, or
<i class="no-highlight">1636</i>&nbsp;     * false to perform only a file write.
<i class="no-highlight">1637</i>&nbsp;     *
<i class="no-highlight">1638</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">1639</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">1640</i>&nbsp;     *
<i class="no-highlight">1641</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">1642</i>&nbsp;     * environment has been closed.
<i class="no-highlight">1643</i>&nbsp;     */
<i class="no-highlight">1644</i>&nbsp;    public void flushLog(boolean fsync) {
<i class="no-highlight">1645</i>&nbsp;
<b class="nc"><i class="no-highlight">1646</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">1647</i>&nbsp;
<i class="no-highlight">1648</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">1649</i>&nbsp;            envImpl.flushLog(fsync);</b>
<b class="nc"><i class="no-highlight">1650</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">1651</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">1652</i>&nbsp;            throw E;</b>
<b class="nc"><i class="no-highlight">1653</i>&nbsp;        }</b>
<b class="nc"><i class="no-highlight">1654</i>&nbsp;    }</b>
<i class="no-highlight">1655</i>&nbsp;
<i class="no-highlight">1656</i>&nbsp;    /**
<i class="no-highlight">1657</i>&nbsp;     * Synchronously invokes log file (data file) cleaning until the target
<i class="no-highlight">1658</i>&nbsp;     * disk space utilization has been reached; this method is called
<i class="no-highlight">1659</i>&nbsp;     * periodically by the cleaner background threads.
<i class="no-highlight">1660</i>&nbsp;     *
<i class="no-highlight">1661</i>&nbsp;     * &lt;p&gt;Zero or more log files will be cleaned as necessary to bring the
<i class="no-highlight">1662</i>&nbsp;     * current {@link EnvironmentStats#getCurrentMinUtilization disk space
<i class="no-highlight">1663</i>&nbsp;     * utilization} of the environment above the configured {@link
<i class="no-highlight">1664</i>&nbsp;     * EnvironmentConfig#CLEANER_MIN_UTILIZATION utilization threshold}.
<i class="no-highlight">1665</i>&nbsp;     *
<i class="no-highlight">1666</i>&nbsp;     * &lt;p&gt;Note that this method does not perform the complete task of cleaning
<i class="no-highlight">1667</i>&nbsp;     * a log file. Eviction and checkpointing log Btree information that is
<i class="no-highlight">1668</i>&nbsp;     * marked dirty by the cleaner, and a full checkpoint is necessary,
<i class="no-highlight">1669</i>&nbsp;     * following cleaning, before cleaned files will be deleted (or renamed).
<i class="no-highlight">1670</i>&nbsp;     * Checkpoints occur periodically and when the environment is closed.&lt;/p&gt;
<i class="no-highlight">1671</i>&nbsp;     *
<i class="no-highlight">1672</i>&nbsp;     * &lt;p&gt;This is an optional action for the application since this activity
<i class="no-highlight">1673</i>&nbsp;     * is, by default, handled by one or more Environment-owned background
<i class="no-highlight">1674</i>&nbsp;     * threads.&lt;/p&gt;
<i class="no-highlight">1675</i>&nbsp;     *
<i class="no-highlight">1676</i>&nbsp;     * &lt;p&gt;The intended use case for the {@code cleanLog} method is when the
<i class="no-highlight">1677</i>&nbsp;     * application wishes to disable the built-in cleaner threads using the
<i class="no-highlight">1678</i>&nbsp;     * {@link EnvironmentConfig#ENV_RUN_CLEANER} property. To replace the
<i class="no-highlight">1679</i>&nbsp;     * functionality of the cleaner threads, the application should call
<i class="no-highlight">1680</i>&nbsp;     * {@code cleanLog} periodically.&lt;/p&gt;
<i class="no-highlight">1681</i>&nbsp;     *
<i class="no-highlight">1682</i>&nbsp;     * &lt;p&gt;Note that because this method cleans multiple files before returning,
<i class="no-highlight">1683</i>&nbsp;     * in an attempt to reach the target utilization, it may not return for a
<i class="no-highlight">1684</i>&nbsp;     * long time when there is a large {@link
<i class="no-highlight">1685</i>&nbsp;     * EnvironmentStats#getCleanerBacklog backlog} of files to be cleaned. This
<i class="no-highlight">1686</i>&nbsp;     * method cannot be aborted except by closing the environment. If the
<i class="no-highlight">1687</i>&nbsp;     * application needs the ability to abort the cleaning process, the
<i class="no-highlight">1688</i>&nbsp;     * {@link #cleanLogFile} method should be used instead.&lt;/p&gt;
<i class="no-highlight">1689</i>&nbsp;     *
<i class="no-highlight">1690</i>&nbsp;     * &lt;p&gt;Note that in certain unusual situations the cleaner may not be able
<i class="no-highlight">1691</i>&nbsp;     * to make forward progress and the target utilization will never be
<i class="no-highlight">1692</i>&nbsp;     * reached. For example, this can occur if the target utilization is set
<i class="no-highlight">1693</i>&nbsp;     * too high or checkpoints are performed too often. To guard against
<i class="no-highlight">1694</i>&nbsp;     * cleaning &quot;forever&quot;, this method will return when all files have been
<i class="no-highlight">1695</i>&nbsp;     * cleaned, even when the target utilization has not been reached.&lt;/p&gt;
<i class="no-highlight">1696</i>&nbsp;     *
<i class="no-highlight">1697</i>&nbsp;     * @return The number of log files that were cleaned, and that will be
<i class="no-highlight">1698</i>&nbsp;     * deleted (or renamed) when a qualifying checkpoint occurs.
<i class="no-highlight">1699</i>&nbsp;     *
<i class="no-highlight">1700</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">1701</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">1702</i>&nbsp;     *
<i class="no-highlight">1703</i>&nbsp;     * @throws UnsupportedOperationException if this is a read-only or
<i class="no-highlight">1704</i>&nbsp;     * memory-only environment.
<i class="no-highlight">1705</i>&nbsp;     *
<i class="no-highlight">1706</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">1707</i>&nbsp;     * environment has been closed.
<i class="no-highlight">1708</i>&nbsp;     */
<i class="no-highlight">1709</i>&nbsp;    public int cleanLog()
<i class="no-highlight">1710</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">1711</i>&nbsp;
<b class="nc"><i class="no-highlight">1712</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">1713</i>&nbsp;
<i class="no-highlight">1714</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">1715</i>&nbsp;            return envImpl.invokeCleaner(true /*cleanMultipleFiles*/);</b>
<b class="nc"><i class="no-highlight">1716</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">1717</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">1718</i>&nbsp;            throw E;</b>
<i class="no-highlight">1719</i>&nbsp;        }
<i class="no-highlight">1720</i>&nbsp;    }
<i class="no-highlight">1721</i>&nbsp;
<i class="no-highlight">1722</i>&nbsp;    /**
<i class="no-highlight">1723</i>&nbsp;     * Synchronously invokes cleaning of a single log file (data file), if
<i class="no-highlight">1724</i>&nbsp;     * the target disk space utilization has not been reached.
<i class="no-highlight">1725</i>&nbsp;     *
<i class="no-highlight">1726</i>&nbsp;     * &lt;p&gt;One log file will be cleaned if the current {@link
<i class="no-highlight">1727</i>&nbsp;     * EnvironmentStats#getCurrentMinUtilization disk space utilization} of the
<i class="no-highlight">1728</i>&nbsp;     * environment is below the configured {@link
<i class="no-highlight">1729</i>&nbsp;     * EnvironmentConfig#CLEANER_MIN_UTILIZATION utilization threshold}. No
<i class="no-highlight">1730</i>&nbsp;     * files will be cleaned if disk space utilization is currently above the
<i class="no-highlight">1731</i>&nbsp;     * threshold. The lowest utilized file is selected for cleaning, since it
<i class="no-highlight">1732</i>&nbsp;     * has the lowest cleaning cost.&lt;/p&gt;
<i class="no-highlight">1733</i>&nbsp;     *
<i class="no-highlight">1734</i>&nbsp;     * &lt;p&gt;Note that this method does not perform the complete task of cleaning
<i class="no-highlight">1735</i>&nbsp;     * a log file. Eviction and checkpointing log Btree information that is
<i class="no-highlight">1736</i>&nbsp;     * marked dirty by the cleaner, and a full checkpoint is necessary,
<i class="no-highlight">1737</i>&nbsp;     * following cleaning, before cleaned files will be deleted (or renamed).
<i class="no-highlight">1738</i>&nbsp;     * Checkpoints occur periodically and when the environment is closed.&lt;/p&gt;
<i class="no-highlight">1739</i>&nbsp;     *
<i class="no-highlight">1740</i>&nbsp;     * &lt;p&gt;The intended use case for the {@code cleanLog} method is &quot;batch
<i class="no-highlight">1741</i>&nbsp;     * cleaning&quot;. This is when the application disables the cleaner threads
<i class="no-highlight">1742</i>&nbsp;     * (using the {@link EnvironmentConfig#ENV_RUN_CLEANER} property)
<i class="no-highlight">1743</i>&nbsp;     * for maximum performance during active periods, and calls {@code
<i class="no-highlight">1744</i>&nbsp;     * cleanLog} during periods when the application is quiescent or less
<i class="no-highlight">1745</i>&nbsp;     * active than usual. Similarly, there may be times when an application
<i class="no-highlight">1746</i>&nbsp;     * wishes to perform cleaning explicitly until the target utilization
<i class="no-highlight">1747</i>&nbsp;     * rather than relying on the cleaner&#39;s background threads. For example,
<i class="no-highlight">1748</i>&nbsp;     * some applications may wish to perform batch cleaning prior to closing
<i class="no-highlight">1749</i>&nbsp;     * the environment, to reclaim as much disk space as possible at that
<i class="no-highlight">1750</i>&nbsp;     * time.&lt;/p&gt;
<i class="no-highlight">1751</i>&nbsp;     *
<i class="no-highlight">1752</i>&nbsp;     * &lt;p&gt;To clean until the target utilization threshold is reached, {@code
<i class="no-highlight">1753</i>&nbsp;     * cleanLogFile} can be called in a loop until it returns {@code false}.
<i class="no-highlight">1754</i>&nbsp;     * When there is a large {@link EnvironmentStats#getCleanerBacklog
<i class="no-highlight">1755</i>&nbsp;     * backlog} of files to be cleaned, the application may wish to limit the
<i class="no-highlight">1756</i>&nbsp;     * amount of cleaning. Batch cleaning can be aborted simply by breaking out
<i class="no-highlight">1757</i>&nbsp;     * of the loop. The cleaning of a single file is not a long operation; it
<i class="no-highlight">1758</i>&nbsp;     * should take several minutes at most. For example:&lt;/p&gt;
<i class="no-highlight">1759</i>&nbsp;     *
<i class="no-highlight">1760</i>&nbsp;     * &lt;pre&gt;
<i class="no-highlight">1761</i>&nbsp;     *     boolean cleaningAborted;
<i class="no-highlight">1762</i>&nbsp;     *     boolean anyCleaned = false;
<i class="no-highlight">1763</i>&nbsp;     *
<i class="no-highlight">1764</i>&nbsp;     *     while (!cleaningAborted &amp;&amp; env.cleanLogFile()) {
<i class="no-highlight">1765</i>&nbsp;     *         anyCleaned = true;
<i class="no-highlight">1766</i>&nbsp;     *     }
<i class="no-highlight">1767</i>&nbsp;     * &lt;/pre&gt;
<i class="no-highlight">1768</i>&nbsp;     *
<i class="no-highlight">1769</i>&nbsp;     * &lt;p&gt;Note that in certain unusual situations the cleaner may not be able
<i class="no-highlight">1770</i>&nbsp;     * to make forward progress and the target utilization will never be
<i class="no-highlight">1771</i>&nbsp;     * reached. For example, this can occur if the target utilization is set
<i class="no-highlight">1772</i>&nbsp;     * too high or checkpoints are performed too often. To guard against
<i class="no-highlight">1773</i>&nbsp;     * cleaning &quot;forever&quot;, the application may wish to cancel the batch
<i class="no-highlight">1774</i>&nbsp;     * cleaning (break out of the loop) when the cleaning time or number of
<i class="no-highlight">1775</i>&nbsp;     * files cleaned exceeds some reasonable limit.&lt;/p&gt;
<i class="no-highlight">1776</i>&nbsp;     *
<i class="no-highlight">1777</i>&nbsp;     * &lt;p&gt;As mentioned above, the cleaned log files will not be deleted until
<i class="no-highlight">1778</i>&nbsp;     * the next full checkpoint. If the application wishes to reclaim this disk
<i class="no-highlight">1779</i>&nbsp;     * space as soon as possible, an explicit checkpoint may be performed after
<i class="no-highlight">1780</i>&nbsp;     * the batch cleaning operation. For example:&lt;/p&gt;
<i class="no-highlight">1781</i>&nbsp;     *
<i class="no-highlight">1782</i>&nbsp;     * &lt;pre&gt;
<i class="no-highlight">1783</i>&nbsp;     *     if (anyCleaned) {
<i class="no-highlight">1784</i>&nbsp;     *         env.checkpoint(new CheckpointConfig().setForce(true));
<i class="no-highlight">1785</i>&nbsp;     *     }
<i class="no-highlight">1786</i>&nbsp;     * &lt;/pre&gt;
<i class="no-highlight">1787</i>&nbsp;     *
<i class="no-highlight">1788</i>&nbsp;     * &lt;p&gt;However, even an explicit checkpoint is not guaranteed to delete the
<i class="no-highlight">1789</i>&nbsp;     * cleaned log files if, at the time the file was cleaned, records in the
<i class="no-highlight">1790</i>&nbsp;     * file were locked or were part of a database that was being removed, due
<i class="no-highlight">1791</i>&nbsp;     * to concurrent application activity that was accessing records or
<i class="no-highlight">1792</i>&nbsp;     * removing databases. In this case the files will be deleted only after
<i class="no-highlight">1793</i>&nbsp;     * these operations are complete and a subsequent checkpoint is performed.
<i class="no-highlight">1794</i>&nbsp;     * To guarantee that the cleaned files will be deleted, an application may
<i class="no-highlight">1795</i>&nbsp;     * stop all concurrent activity (ensure all operations and transactions
<i class="no-highlight">1796</i>&nbsp;     * have ended) and then perform a checkpoint.&lt;/p&gt;
<i class="no-highlight">1797</i>&nbsp;     *
<i class="no-highlight">1798</i>&nbsp;     * &lt;p&gt;When closing the environment and minimizing recovery time is desired
<i class="no-highlight">1799</i>&nbsp;     * (see {@link #close}), as well as reclaiming disk space, the recommended
<i class="no-highlight">1800</i>&nbsp;     * procedure is as follows:&lt;/p&gt;
<i class="no-highlight">1801</i>&nbsp;
<i class="no-highlight">1802</i>&nbsp;     * &lt;pre&gt;
<i class="no-highlight">1803</i>&nbsp;     *     // Stop/finish all application operations that are using JE.
<i class="no-highlight">1804</i>&nbsp;     *     ...
<i class="no-highlight">1805</i>&nbsp;     *
<i class="no-highlight">1806</i>&nbsp;     *     // Stop the cleaner daemon threads.
<i class="no-highlight">1807</i>&nbsp;     *     EnvironmentMutableConfig config = env.getMutableConfig();
<i class="no-highlight">1808</i>&nbsp;     *     config.setConfigParam(EnvironmentConfig.ENV_RUN_CLEANER, &quot;false&quot;);
<i class="no-highlight">1809</i>&nbsp;     *     env.setMutableConfig(config);
<i class="no-highlight">1810</i>&nbsp;     *
<i class="no-highlight">1811</i>&nbsp;     *     // Perform batch cleaning.
<i class="no-highlight">1812</i>&nbsp;     *     while (!cleaningAborted &amp;&amp; env.cleanLogFile()) {
<i class="no-highlight">1813</i>&nbsp;     *     }
<i class="no-highlight">1814</i>&nbsp;     *
<i class="no-highlight">1815</i>&nbsp;     *     // Perform an extra checkpoint
<i class="no-highlight">1816</i>&nbsp;     *     env.checkpoint(new CheckpointConfig().setForce(true));
<i class="no-highlight">1817</i>&nbsp;     *
<i class="no-highlight">1818</i>&nbsp;     *     // Finally, close the environment.
<i class="no-highlight">1819</i>&nbsp;     *     env.close();
<i class="no-highlight">1820</i>&nbsp;     * &lt;/pre&gt;
<i class="no-highlight">1821</i>&nbsp;     *
<i class="no-highlight">1822</i>&nbsp;     * @return true if one log was cleaned, or false if none were cleaned.
<i class="no-highlight">1823</i>&nbsp;     *
<i class="no-highlight">1824</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">1825</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">1826</i>&nbsp;     *
<i class="no-highlight">1827</i>&nbsp;     * @throws UnsupportedOperationException if this is a read-only or
<i class="no-highlight">1828</i>&nbsp;     * memory-only environment.
<i class="no-highlight">1829</i>&nbsp;     *
<i class="no-highlight">1830</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">1831</i>&nbsp;     * environment has been closed.
<i class="no-highlight">1832</i>&nbsp;     */
<i class="no-highlight">1833</i>&nbsp;    public boolean cleanLogFile()
<i class="no-highlight">1834</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">1835</i>&nbsp;
<b class="nc"><i class="no-highlight">1836</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">1837</i>&nbsp;
<i class="no-highlight">1838</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">1839</i>&nbsp;            return envImpl.invokeCleaner(false /*cleanMultipleFiles*/) &gt; 0;</b>
<b class="nc"><i class="no-highlight">1840</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">1841</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">1842</i>&nbsp;            throw E;</b>
<i class="no-highlight">1843</i>&nbsp;        }
<i class="no-highlight">1844</i>&nbsp;    }
<i class="no-highlight">1845</i>&nbsp;
<i class="no-highlight">1846</i>&nbsp;    /**
<i class="no-highlight">1847</i>&nbsp;     * Synchronously invokes the mechanism for keeping memory usage within the
<i class="no-highlight">1848</i>&nbsp;     * cache size boundaries.
<i class="no-highlight">1849</i>&nbsp;     *
<i class="no-highlight">1850</i>&nbsp;     * &lt;p&gt;This is an optional action for the application since this activity
<i class="no-highlight">1851</i>&nbsp;     * is, by default, handled by a database environment owned background
<i class="no-highlight">1852</i>&nbsp;     * thread.&lt;/p&gt;
<i class="no-highlight">1853</i>&nbsp;     *
<i class="no-highlight">1854</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">1855</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">1856</i>&nbsp;     *
<i class="no-highlight">1857</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">1858</i>&nbsp;     * environment has been closed.
<i class="no-highlight">1859</i>&nbsp;     */
<i class="no-highlight">1860</i>&nbsp;    public void evictMemory()
<i class="no-highlight">1861</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">1862</i>&nbsp;
<b class="nc"><i class="no-highlight">1863</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">1864</i>&nbsp;
<i class="no-highlight">1865</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">1866</i>&nbsp;            envImpl.invokeEvictor();</b>
<b class="nc"><i class="no-highlight">1867</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">1868</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">1869</i>&nbsp;            throw E;</b>
<b class="nc"><i class="no-highlight">1870</i>&nbsp;        }</b>
<b class="nc"><i class="no-highlight">1871</i>&nbsp;    }</b>
<i class="no-highlight">1872</i>&nbsp;
<i class="no-highlight">1873</i>&nbsp;    /**
<i class="no-highlight">1874</i>&nbsp;     * Synchronously invokes the compressor mechanism which compacts in memory
<i class="no-highlight">1875</i>&nbsp;     * data structures after delete operations.
<i class="no-highlight">1876</i>&nbsp;     *
<i class="no-highlight">1877</i>&nbsp;     * &lt;p&gt;This is an optional action for the application since this activity
<i class="no-highlight">1878</i>&nbsp;     * is, by default, handled by a database environment owned background
<i class="no-highlight">1879</i>&nbsp;     * thread.&lt;/p&gt;
<i class="no-highlight">1880</i>&nbsp;     *
<i class="no-highlight">1881</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">1882</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">1883</i>&nbsp;     *
<i class="no-highlight">1884</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">1885</i>&nbsp;     * environment has been closed.
<i class="no-highlight">1886</i>&nbsp;     */
<i class="no-highlight">1887</i>&nbsp;    public void compress()
<i class="no-highlight">1888</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">1889</i>&nbsp;
<b class="nc"><i class="no-highlight">1890</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">1891</i>&nbsp;
<i class="no-highlight">1892</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">1893</i>&nbsp;            envImpl.invokeCompressor();</b>
<b class="nc"><i class="no-highlight">1894</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">1895</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">1896</i>&nbsp;            throw E;</b>
<b class="nc"><i class="no-highlight">1897</i>&nbsp;        }</b>
<b class="nc"><i class="no-highlight">1898</i>&nbsp;    }</b>
<i class="no-highlight">1899</i>&nbsp;
<i class="no-highlight">1900</i>&nbsp;    /**
<i class="no-highlight">1901</i>&nbsp;     * Preloads the cache with multiple databases.  This method should only be
<i class="no-highlight">1902</i>&nbsp;     * called when there are no operations being performed on the specified
<i class="no-highlight">1903</i>&nbsp;     * databases in other threads.  Executing preload during concurrent updates
<i class="no-highlight">1904</i>&nbsp;     * of the specified databases may result in some or all of the tree being
<i class="no-highlight">1905</i>&nbsp;     * loaded into the JE cache.  Executing preload during any other types of
<i class="no-highlight">1906</i>&nbsp;     * operations may result in JE exceeding its allocated cache
<i class="no-highlight">1907</i>&nbsp;     * size. preload() effectively locks all of the specified database and
<i class="no-highlight">1908</i>&nbsp;     * therefore will lock out the checkpointer, cleaner, and compressor, as
<i class="no-highlight">1909</i>&nbsp;     * well as not allow eviction to occur.  If databases are replicated and
<i class="no-highlight">1910</i>&nbsp;     * the environment is in the replica state, then the replica may become
<i class="no-highlight">1911</i>&nbsp;     * temporarily disconnected from the master if the replica needs to replay
<i class="no-highlight">1912</i>&nbsp;     * changes against the database and is locked out because the time taken by
<i class="no-highlight">1913</i>&nbsp;     * the preload operation exceeds {@link
<i class="no-highlight">1914</i>&nbsp;     * com.sleepycat.je.rep.ReplicationConfig#FEEDER_TIMEOUT}.
<i class="no-highlight">1915</i>&nbsp;     *
<i class="no-highlight">1916</i>&nbsp;     * @param config The PreloadConfig object that specifies the parameters
<i class="no-highlight">1917</i>&nbsp;     * of the preload.
<i class="no-highlight">1918</i>&nbsp;     *
<i class="no-highlight">1919</i>&nbsp;     * @return A PreloadStats object with the result of the preload operation
<i class="no-highlight">1920</i>&nbsp;     * and various statistics about the preload() operation.
<i class="no-highlight">1921</i>&nbsp;     *
<i class="no-highlight">1922</i>&nbsp;     * @throws OperationFailureException if one of the &lt;a
<i class="no-highlight">1923</i>&nbsp;     * href=&quot;OperationFailureException.html#readFailures&quot;&gt;Read Operation
<i class="no-highlight">1924</i>&nbsp;     * Failures&lt;/a&gt; occurs.
<i class="no-highlight">1925</i>&nbsp;     *
<i class="no-highlight">1926</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">1927</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">1928</i>&nbsp;     *
<i class="no-highlight">1929</i>&nbsp;     * @throws IllegalStateException if any of the databases has been closed.
<i class="no-highlight">1930</i>&nbsp;     *
<i class="no-highlight">1931</i>&nbsp;     * @see Database#preload(PreloadConfig)
<i class="no-highlight">1932</i>&nbsp;     */
<i class="no-highlight">1933</i>&nbsp;    public PreloadStats preload(final Database[] databases,
<i class="no-highlight">1934</i>&nbsp;                                PreloadConfig config)
<i class="no-highlight">1935</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">1936</i>&nbsp;
<b class="nc"><i class="no-highlight">1937</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">1938</i>&nbsp;
<b class="nc"><i class="no-highlight">1939</i>&nbsp;        DatabaseUtil.checkForZeroLengthArrayParam(databases, &quot;databases&quot;);</b>
<i class="no-highlight">1940</i>&nbsp;
<b class="nc"><i class="no-highlight">1941</i>&nbsp;        if (config == null) {</b>
<b class="nc"><i class="no-highlight">1942</i>&nbsp;            config = new PreloadConfig();</b>
<i class="no-highlight">1943</i>&nbsp;        }
<i class="no-highlight">1944</i>&nbsp;
<i class="no-highlight">1945</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">1946</i>&nbsp;            final int nDbs = databases.length;</b>
<b class="nc"><i class="no-highlight">1947</i>&nbsp;            final DatabaseImpl[] dbImpls = new DatabaseImpl[nDbs];</b>
<b class="nc"><i class="no-highlight">1948</i>&nbsp;            for (int i = 0; i &lt; nDbs; i += 1) {</b>
<b class="nc"><i class="no-highlight">1949</i>&nbsp;                dbImpls[i] = DbInternal.getDbImpl(databases[i]);</b>
<i class="no-highlight">1950</i>&nbsp;            }
<b class="nc"><i class="no-highlight">1951</i>&nbsp;            return envImpl.preload(dbImpls, config);</b>
<b class="nc"><i class="no-highlight">1952</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">1953</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">1954</i>&nbsp;            throw E;</b>
<i class="no-highlight">1955</i>&nbsp;        }
<i class="no-highlight">1956</i>&nbsp;    }
<i class="no-highlight">1957</i>&nbsp;
<i class="no-highlight">1958</i>&nbsp;    /**
<i class="no-highlight">1959</i>&nbsp;     *
<i class="no-highlight">1960</i>&nbsp;     * Create a DiskOrderedCursor to iterate over the records of a given set
<i class="no-highlight">1961</i>&nbsp;     * of databases. Because the retrieval is based on Log Sequence Number
<i class="no-highlight">1962</i>&nbsp;     * (LSN) order rather than key order, records are returned in unsorted
<i class="no-highlight">1963</i>&nbsp;     * order in exchange for generally faster retrieval. LSN order
<i class="no-highlight">1964</i>&nbsp;     * approximates disk sector order.
<i class="no-highlight">1965</i>&nbsp;     * &lt;p&gt;
<i class="no-highlight">1966</i>&nbsp;     * See {@link DiskOrderedCursor} for more details and a description of the
<i class="no-highlight">1967</i>&nbsp;     * consistency guarantees provided by the scan.
<i class="no-highlight">1968</i>&nbsp;     * &lt;p&gt;
<i class="no-highlight">1969</i>&nbsp;     * &lt;em&gt;WARNING:&lt;/em&gt; After calling this method, deletion of log files by
<i class="no-highlight">1970</i>&nbsp;     * the JE log cleaner will be disabled until {@link
<i class="no-highlight">1971</i>&nbsp;     * DiskOrderedCursor#close()} is called.  To prevent unbounded growth of
<i class="no-highlight">1972</i>&nbsp;     * disk usage, be sure to call {@link DiskOrderedCursor#close()} to
<i class="no-highlight">1973</i>&nbsp;     * re-enable log file deletion.
<i class="no-highlight">1974</i>&nbsp;     *
<i class="no-highlight">1975</i>&nbsp;     * @param databases An array containing the handles to the database that
<i class="no-highlight">1976</i>&nbsp;     * are to be scanned. All these handles must be currently open.
<i class="no-highlight">1977</i>&nbsp;     * Furthermore, all the databases must belong to this environments, and
<i class="no-highlight">1978</i>&nbsp;     * they should all support duplicates or none of them should support
<i class="no-highlight">1979</i>&nbsp;     * duplicates. Note: this method does not make a copy of this array,
<i class="no-highlight">1980</i>&nbsp;     * and as a result, the contents of the array should not be modified
<i class="no-highlight">1981</i>&nbsp;     * while the returned DiskOrderedCursor is still in use.
<i class="no-highlight">1982</i>&nbsp;     *
<i class="no-highlight">1983</i>&nbsp;     * @param config The DiskOrderedCursorConfig object that specifies the
<i class="no-highlight">1984</i>&nbsp;     * parameters of the disk ordered scan.
<i class="no-highlight">1985</i>&nbsp;     *
<i class="no-highlight">1986</i>&nbsp;     * @return the new DiskOrderedCursor object.
<i class="no-highlight">1987</i>&nbsp;     *
<i class="no-highlight">1988</i>&nbsp;     * @throws IllegalArgumentException if (a) the databases parameter is
<i class="no-highlight">1989</i>&nbsp;     * null or an empty array, or (b) any of the handles in the databases
<i class="no-highlight">1990</i>&nbsp;     * parameter is null, or (c) the databases do not all belong to this
<i class="no-highlight">1991</i>&nbsp;     * environment, or (d) some databases support duplicates and some don&#39;t.
<i class="no-highlight">1992</i>&nbsp;     *
<i class="no-highlight">1993</i>&nbsp;     * @throws IllegalStateException if any of the databases has been
<i class="no-highlight">1994</i>&nbsp;     * closed or invalidated.
<i class="no-highlight">1995</i>&nbsp;     *
<i class="no-highlight">1996</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">1997</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">1998</i>&nbsp;     */
<i class="no-highlight">1999</i>&nbsp;    public DiskOrderedCursor openDiskOrderedCursor(
<i class="no-highlight">2000</i>&nbsp;        final Database[] databases,
<i class="no-highlight">2001</i>&nbsp;        DiskOrderedCursorConfig config)
<i class="no-highlight">2002</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">2003</i>&nbsp;
<b class="nc"><i class="no-highlight">2004</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">2005</i>&nbsp;
<b class="nc"><i class="no-highlight">2006</i>&nbsp;        DatabaseUtil.checkForZeroLengthArrayParam(databases, &quot;databases&quot;);</b>
<i class="no-highlight">2007</i>&nbsp;
<b class="nc"><i class="no-highlight">2008</i>&nbsp;        if (config == null) {</b>
<b class="nc"><i class="no-highlight">2009</i>&nbsp;            config = DiskOrderedCursorConfig.DEFAULT;</b>
<i class="no-highlight">2010</i>&nbsp;        }
<i class="no-highlight">2011</i>&nbsp;
<i class="no-highlight">2012</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">2013</i>&nbsp;            int nDbs = databases.length;</b>
<i class="no-highlight">2014</i>&nbsp;
<b class="nc"><i class="no-highlight">2015</i>&nbsp;            for (int i = 0; i &lt; nDbs; i += 1) {</b>
<i class="no-highlight">2016</i>&nbsp;
<b class="nc"><i class="no-highlight">2017</i>&nbsp;                if (databases[i] == null) {</b>
<b class="nc"><i class="no-highlight">2018</i>&nbsp;                    throw new IllegalArgumentException(</b>
<i class="no-highlight">2019</i>&nbsp;                        &quot;The handle at position &quot; + i + &quot; of the databases &quot; +
<i class="no-highlight">2020</i>&nbsp;                        &quot;array is null.&quot;);
<i class="no-highlight">2021</i>&nbsp;                }
<i class="no-highlight">2022</i>&nbsp;
<b class="nc"><i class="no-highlight">2023</i>&nbsp;                if (databases[i].getEnvironment() != this) {</b>
<b class="nc"><i class="no-highlight">2024</i>&nbsp;                    throw new IllegalArgumentException(</b>
<i class="no-highlight">2025</i>&nbsp;                        &quot;The handle at position &quot; + i + &quot; of the databases &quot; +
<i class="no-highlight">2026</i>&nbsp;                        &quot;array points to a database that does not belong &quot; +
<i class="no-highlight">2027</i>&nbsp;                        &quot;to this environment&quot;);
<i class="no-highlight">2028</i>&nbsp;                }
<i class="no-highlight">2029</i>&nbsp;            }
<i class="no-highlight">2030</i>&nbsp;
<b class="nc"><i class="no-highlight">2031</i>&nbsp;            return new DiskOrderedCursor(databases, config);</b>
<i class="no-highlight">2032</i>&nbsp;
<b class="nc"><i class="no-highlight">2033</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">2034</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">2035</i>&nbsp;            throw E;</b>
<i class="no-highlight">2036</i>&nbsp;        }
<i class="no-highlight">2037</i>&nbsp;    }
<i class="no-highlight">2038</i>&nbsp;
<i class="no-highlight">2039</i>&nbsp;
<i class="no-highlight">2040</i>&nbsp;    /**
<i class="no-highlight">2041</i>&nbsp;     * Returns this object&#39;s configuration.
<i class="no-highlight">2042</i>&nbsp;     *
<i class="no-highlight">2043</i>&nbsp;     * @return This object&#39;s configuration.
<i class="no-highlight">2044</i>&nbsp;     *
<i class="no-highlight">2045</i>&nbsp;     * &lt;p&gt;Unlike most Environment methods, this method may be called if the
<i class="no-highlight">2046</i>&nbsp;     * environment is invalid, but not yet closed.&lt;/p&gt;
<i class="no-highlight">2047</i>&nbsp;     *
<i class="no-highlight">2048</i>&nbsp;     * @throws IllegalStateException if this handle has been closed.
<i class="no-highlight">2049</i>&nbsp;     */
<i class="no-highlight">2050</i>&nbsp;    public EnvironmentConfig getConfig()
<i class="no-highlight">2051</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">2052</i>&nbsp;
<b class="nc"><i class="no-highlight">2053</i>&nbsp;        final EnvironmentImpl envImpl = getNonNullEnvImpl();</b>
<i class="no-highlight">2054</i>&nbsp;
<i class="no-highlight">2055</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">2056</i>&nbsp;            final EnvironmentConfig config = envImpl.cloneConfig();</b>
<b class="nc"><i class="no-highlight">2057</i>&nbsp;            handleConfig.copyHandlePropsTo(config);</b>
<b class="nc"><i class="no-highlight">2058</i>&nbsp;            config.fillInEnvironmentGeneratedProps(envImpl);</b>
<b class="nc"><i class="no-highlight">2059</i>&nbsp;            return config;</b>
<b class="nc"><i class="no-highlight">2060</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">2061</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">2062</i>&nbsp;            throw E;</b>
<i class="no-highlight">2063</i>&nbsp;        }
<i class="no-highlight">2064</i>&nbsp;    }
<i class="no-highlight">2065</i>&nbsp;
<i class="no-highlight">2066</i>&nbsp;    /**
<i class="no-highlight">2067</i>&nbsp;     * Sets database environment attributes.
<i class="no-highlight">2068</i>&nbsp;     *
<i class="no-highlight">2069</i>&nbsp;     * &lt;p&gt;Attributes only apply to a specific Environment object and are not
<i class="no-highlight">2070</i>&nbsp;     * necessarily shared by other Environment objects accessing this
<i class="no-highlight">2071</i>&nbsp;     * database environment.&lt;/p&gt;
<i class="no-highlight">2072</i>&nbsp;     *
<i class="no-highlight">2073</i>&nbsp;     * &lt;p&gt;Unlike most Environment methods, this method may be called if the
<i class="no-highlight">2074</i>&nbsp;     * environment is invalid, but not yet closed.&lt;/p&gt;
<i class="no-highlight">2075</i>&nbsp;     *
<i class="no-highlight">2076</i>&nbsp;     * @param mutableConfig The database environment attributes.  If null,
<i class="no-highlight">2077</i>&nbsp;     * default attributes are used.
<i class="no-highlight">2078</i>&nbsp;     *
<i class="no-highlight">2079</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">2080</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">2081</i>&nbsp;     *
<i class="no-highlight">2082</i>&nbsp;     * @throws IllegalStateException if this handle has been closed.
<i class="no-highlight">2083</i>&nbsp;     */
<i class="no-highlight">2084</i>&nbsp;    public synchronized void setMutableConfig(
<i class="no-highlight">2085</i>&nbsp;        EnvironmentMutableConfig mutableConfig)
<i class="no-highlight">2086</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">2087</i>&nbsp;
<b class="nc"><i class="no-highlight">2088</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">2089</i>&nbsp;
<b class="nc"><i class="no-highlight">2090</i>&nbsp;        DatabaseUtil.checkForNullParam(mutableConfig, &quot;mutableConfig&quot;);</b>
<i class="no-highlight">2091</i>&nbsp;
<i class="no-highlight">2092</i>&nbsp;        /*
<i class="no-highlight">2093</i>&nbsp;         * This method is synchronized so that we atomically call both
<i class="no-highlight">2094</i>&nbsp;         * EnvironmentImpl.setMutableConfig and copyToHandleConfig. This
<i class="no-highlight">2095</i>&nbsp;         * ensures that the handle and the EnvironmentImpl properties match.
<i class="no-highlight">2096</i>&nbsp;         */
<i class="no-highlight">2097</i>&nbsp;        try {
<i class="no-highlight">2098</i>&nbsp;
<i class="no-highlight">2099</i>&nbsp;            /*
<i class="no-highlight">2100</i>&nbsp;             * Change the mutable properties specified in the given
<i class="no-highlight">2101</i>&nbsp;             * configuration.
<i class="no-highlight">2102</i>&nbsp;             */
<b class="nc"><i class="no-highlight">2103</i>&nbsp;            envImpl.setMutableConfig(mutableConfig);</b>
<i class="no-highlight">2104</i>&nbsp;
<i class="no-highlight">2105</i>&nbsp;            /* Reset the handle config properties. */
<b class="nc"><i class="no-highlight">2106</i>&nbsp;            copyToHandleConfig(mutableConfig, null, null);</b>
<b class="nc"><i class="no-highlight">2107</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">2108</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">2109</i>&nbsp;            throw E;</b>
<b class="nc"><i class="no-highlight">2110</i>&nbsp;        }</b>
<b class="nc"><i class="no-highlight">2111</i>&nbsp;    }</b>
<i class="no-highlight">2112</i>&nbsp;
<i class="no-highlight">2113</i>&nbsp;    /**
<i class="no-highlight">2114</i>&nbsp;     * Returns database environment attributes.
<i class="no-highlight">2115</i>&nbsp;     *
<i class="no-highlight">2116</i>&nbsp;     * &lt;p&gt;Unlike most Environment methods, this method may be called if the
<i class="no-highlight">2117</i>&nbsp;     * environment is invalid, but not yet closed.&lt;/p&gt;
<i class="no-highlight">2118</i>&nbsp;     *
<i class="no-highlight">2119</i>&nbsp;     * @return Environment attributes.
<i class="no-highlight">2120</i>&nbsp;     *
<i class="no-highlight">2121</i>&nbsp;     * @throws IllegalStateException if this handle has been closed.
<i class="no-highlight">2122</i>&nbsp;     */
<i class="no-highlight">2123</i>&nbsp;    public EnvironmentMutableConfig getMutableConfig()
<i class="no-highlight">2124</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">2125</i>&nbsp;
<b class="nc"><i class="no-highlight">2126</i>&nbsp;        final EnvironmentImpl envImpl = getNonNullEnvImpl();</b>
<i class="no-highlight">2127</i>&nbsp;
<i class="no-highlight">2128</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">2129</i>&nbsp;            final EnvironmentMutableConfig config =</b>
<b class="nc"><i class="no-highlight">2130</i>&nbsp;                envImpl.cloneMutableConfig();</b>
<b class="nc"><i class="no-highlight">2131</i>&nbsp;            handleConfig.copyHandlePropsTo(config);</b>
<b class="nc"><i class="no-highlight">2132</i>&nbsp;            config.fillInEnvironmentGeneratedProps(envImpl);</b>
<b class="nc"><i class="no-highlight">2133</i>&nbsp;            return config;</b>
<b class="nc"><i class="no-highlight">2134</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">2135</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">2136</i>&nbsp;            throw E;</b>
<i class="no-highlight">2137</i>&nbsp;        }
<i class="no-highlight">2138</i>&nbsp;    }
<i class="no-highlight">2139</i>&nbsp;
<i class="no-highlight">2140</i>&nbsp;    /**
<i class="no-highlight">2141</i>&nbsp;     * Returns the general database environment statistics.
<i class="no-highlight">2142</i>&nbsp;     *
<i class="no-highlight">2143</i>&nbsp;     * @param config The general statistics attributes.  If null, default
<i class="no-highlight">2144</i>&nbsp;     * attributes are used.
<i class="no-highlight">2145</i>&nbsp;     *
<i class="no-highlight">2146</i>&nbsp;     * @return The general database environment statistics.
<i class="no-highlight">2147</i>&nbsp;     *
<i class="no-highlight">2148</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">2149</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">2150</i>&nbsp;     *
<i class="no-highlight">2151</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">2152</i>&nbsp;     * environment has been closed.
<i class="no-highlight">2153</i>&nbsp;     */
<i class="no-highlight">2154</i>&nbsp;    public EnvironmentStats getStats(StatsConfig config)
<i class="no-highlight">2155</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">2156</i>&nbsp;
<b class="nc"><i class="no-highlight">2157</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">2158</i>&nbsp;
<b class="nc"><i class="no-highlight">2159</i>&nbsp;        if (config == null) {</b>
<b class="nc"><i class="no-highlight">2160</i>&nbsp;            config = StatsConfig.DEFAULT;</b>
<i class="no-highlight">2161</i>&nbsp;        }
<i class="no-highlight">2162</i>&nbsp;
<i class="no-highlight">2163</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">2164</i>&nbsp;            return envImpl.loadStats(config);</b>
<b class="nc"><i class="no-highlight">2165</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">2166</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">2167</i>&nbsp;            throw E;</b>
<i class="no-highlight">2168</i>&nbsp;        }
<i class="no-highlight">2169</i>&nbsp;    }
<i class="no-highlight">2170</i>&nbsp;
<i class="no-highlight">2171</i>&nbsp;    /**
<i class="no-highlight">2172</i>&nbsp;     * Returns the database environment&#39;s locking statistics.
<i class="no-highlight">2173</i>&nbsp;     *
<i class="no-highlight">2174</i>&nbsp;     * @param config The locking statistics attributes.  If null, default
<i class="no-highlight">2175</i>&nbsp;     * attributes are used.
<i class="no-highlight">2176</i>&nbsp;     *
<i class="no-highlight">2177</i>&nbsp;     * @return The database environment&#39;s locking statistics.
<i class="no-highlight">2178</i>&nbsp;     *
<i class="no-highlight">2179</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">2180</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">2181</i>&nbsp;     *
<i class="no-highlight">2182</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">2183</i>&nbsp;     * environment has been closed.
<i class="no-highlight">2184</i>&nbsp;     *
<i class="no-highlight">2185</i>&nbsp;     * @deprecated as of 4.0.10, replaced by {@link
<i class="no-highlight">2186</i>&nbsp;     * Environment#getStats(StatsConfig)}.&lt;/p&gt;
<i class="no-highlight">2187</i>&nbsp;     */
<i class="no-highlight">2188</i>&nbsp;    public LockStats getLockStats(StatsConfig config)
<i class="no-highlight">2189</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">2190</i>&nbsp;
<b class="nc"><i class="no-highlight">2191</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">2192</i>&nbsp;
<b class="nc"><i class="no-highlight">2193</i>&nbsp;        if (config == null) {</b>
<b class="nc"><i class="no-highlight">2194</i>&nbsp;            config = StatsConfig.DEFAULT;</b>
<i class="no-highlight">2195</i>&nbsp;        }
<i class="no-highlight">2196</i>&nbsp;
<i class="no-highlight">2197</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">2198</i>&nbsp;            return envImpl.lockStat(config);</b>
<b class="nc"><i class="no-highlight">2199</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">2200</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">2201</i>&nbsp;            throw E;</b>
<i class="no-highlight">2202</i>&nbsp;        }
<i class="no-highlight">2203</i>&nbsp;    }
<i class="no-highlight">2204</i>&nbsp;
<i class="no-highlight">2205</i>&nbsp;    /**
<i class="no-highlight">2206</i>&nbsp;     * Returns the database environment&#39;s transactional statistics.
<i class="no-highlight">2207</i>&nbsp;     *
<i class="no-highlight">2208</i>&nbsp;     * @param config The transactional statistics attributes.  If null,
<i class="no-highlight">2209</i>&nbsp;     * default attributes are used.
<i class="no-highlight">2210</i>&nbsp;     *
<i class="no-highlight">2211</i>&nbsp;     * @return The database environment&#39;s transactional statistics.
<i class="no-highlight">2212</i>&nbsp;     *
<i class="no-highlight">2213</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">2214</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">2215</i>&nbsp;     *
<i class="no-highlight">2216</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">2217</i>&nbsp;     * environment has been closed.
<i class="no-highlight">2218</i>&nbsp;     */
<i class="no-highlight">2219</i>&nbsp;    public TransactionStats getTransactionStats(StatsConfig config)
<i class="no-highlight">2220</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">2221</i>&nbsp;
<b class="nc"><i class="no-highlight">2222</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">2223</i>&nbsp;
<b class="nc"><i class="no-highlight">2224</i>&nbsp;        if (config == null) {</b>
<b class="nc"><i class="no-highlight">2225</i>&nbsp;            config = StatsConfig.DEFAULT;</b>
<i class="no-highlight">2226</i>&nbsp;        }
<i class="no-highlight">2227</i>&nbsp;
<i class="no-highlight">2228</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">2229</i>&nbsp;            return envImpl.txnStat(config);</b>
<b class="nc"><i class="no-highlight">2230</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">2231</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">2232</i>&nbsp;            throw E;</b>
<i class="no-highlight">2233</i>&nbsp;        }
<i class="no-highlight">2234</i>&nbsp;    }
<i class="no-highlight">2235</i>&nbsp;
<i class="no-highlight">2236</i>&nbsp;    /**
<i class="no-highlight">2237</i>&nbsp;     * Returns a List of database names for the database environment.
<i class="no-highlight">2238</i>&nbsp;     *
<i class="no-highlight">2239</i>&nbsp;     * &lt;p&gt;Each element in the list is a String.&lt;/p&gt;
<i class="no-highlight">2240</i>&nbsp;     *
<i class="no-highlight">2241</i>&nbsp;     * @return A List of database names for the database environment.
<i class="no-highlight">2242</i>&nbsp;     *
<i class="no-highlight">2243</i>&nbsp;     * @throws OperationFailureException if one of the &lt;a
<i class="no-highlight">2244</i>&nbsp;     * href=&quot;OperationFailureException.html#readFailures&quot;&gt;Read Operation
<i class="no-highlight">2245</i>&nbsp;     * Failures&lt;/a&gt; occurs.
<i class="no-highlight">2246</i>&nbsp;     *
<i class="no-highlight">2247</i>&nbsp;     * @throws EnvironmentFailureException if an unexpected, internal or
<i class="no-highlight">2248</i>&nbsp;     * environment-wide failure occurs.
<i class="no-highlight">2249</i>&nbsp;     *
<i class="no-highlight">2250</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">2251</i>&nbsp;     * environment has been closed.
<i class="no-highlight">2252</i>&nbsp;     */
<i class="no-highlight">2253</i>&nbsp;    public List&lt;String&gt; getDatabaseNames()
<i class="no-highlight">2254</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">2255</i>&nbsp;
<b class="nc"><i class="no-highlight">2256</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">2257</i>&nbsp;
<i class="no-highlight">2258</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">2259</i>&nbsp;            return envImpl.getDbTree().getDbNames();</b>
<b class="nc"><i class="no-highlight">2260</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">2261</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">2262</i>&nbsp;            throw E;</b>
<i class="no-highlight">2263</i>&nbsp;        }
<i class="no-highlight">2264</i>&nbsp;    }
<i class="no-highlight">2265</i>&nbsp;
<i class="no-highlight">2266</i>&nbsp;    /**
<i class="no-highlight">2267</i>&nbsp;     * Returns if the database environment is consistent and correct.
<i class="no-highlight">2268</i>&nbsp;     *
<i class="no-highlight">2269</i>&nbsp;     * &lt;p&gt;Verification is an expensive operation that should normally only be
<i class="no-highlight">2270</i>&nbsp;     * used for troubleshooting and debugging.&lt;/p&gt;
<i class="no-highlight">2271</i>&nbsp;     *
<i class="no-highlight">2272</i>&nbsp;     * @param config The verification attributes.  If null, default
<i class="no-highlight">2273</i>&nbsp;     * attributes are used.
<i class="no-highlight">2274</i>&nbsp;     *
<i class="no-highlight">2275</i>&nbsp;     * @param out is unused. To specify the output stream for verification
<i class="no-highlight">2276</i>&nbsp;     * information, use {@link VerifyConfig#setShowProgressStream}.
<i class="no-highlight">2277</i>&nbsp;     *
<i class="no-highlight">2278</i>&nbsp;     * @return true if the database environment is consistent and correct.
<i class="no-highlight">2279</i>&nbsp;     * Currently true is always returned when this method returns normally,
<i class="no-highlight">2280</i>&nbsp;     * i.e., when no exception is thrown.
<i class="no-highlight">2281</i>&nbsp;     *
<i class="no-highlight">2282</i>&nbsp;     * @throws EnvironmentFailureException if a corruption is detected, or if
<i class="no-highlight">2283</i>&nbsp;     * an unexpected, internal or environment-wide failure occurs. If a
<i class="no-highlight">2284</i>&nbsp;     * persistent corruption is detected,
<i class="no-highlight">2285</i>&nbsp;     * {@link EnvironmentFailureException#isCorrupted()} will return true.
<i class="no-highlight">2286</i>&nbsp;     *
<i class="no-highlight">2287</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">2288</i>&nbsp;     * environment has been closed.
<i class="no-highlight">2289</i>&nbsp;     */
<i class="no-highlight">2290</i>&nbsp;    public boolean verify(VerifyConfig config,
<i class="no-highlight">2291</i>&nbsp;                          @SuppressWarnings(&quot;unused&quot;) PrintStream out)
<i class="no-highlight">2292</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">2293</i>&nbsp;
<b class="nc"><i class="no-highlight">2294</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">2295</i>&nbsp;
<b class="nc"><i class="no-highlight">2296</i>&nbsp;        if (config == null) {</b>
<b class="nc"><i class="no-highlight">2297</i>&nbsp;            config = VerifyConfig.DEFAULT;</b>
<i class="no-highlight">2298</i>&nbsp;        }
<i class="no-highlight">2299</i>&nbsp;
<i class="no-highlight">2300</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">2301</i>&nbsp;            envImpl.verify(config);</b>
<b class="nc"><i class="no-highlight">2302</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">2303</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">2304</i>&nbsp;            throw E;</b>
<b class="nc"><i class="no-highlight">2305</i>&nbsp;        }</b>
<i class="no-highlight">2306</i>&nbsp;
<b class="nc"><i class="no-highlight">2307</i>&nbsp;        return true;</b>
<i class="no-highlight">2308</i>&nbsp;    }
<i class="no-highlight">2309</i>&nbsp;
<i class="no-highlight">2310</i>&nbsp;    /**
<i class="no-highlight">2311</i>&nbsp;     * Returns the transaction associated with this thread if implied
<i class="no-highlight">2312</i>&nbsp;     * transactions are being used.  Implied transactions are used in an XA or
<i class="no-highlight">2313</i>&nbsp;     * JCA &quot;Local Transaction&quot; environment.  In an XA environment the
<i class="no-highlight">2314</i>&nbsp;     * XAEnvironment.start() entrypoint causes a transaction to be created and
<i class="no-highlight">2315</i>&nbsp;     * become associated with the calling thread.  Subsequent API calls
<i class="no-highlight">2316</i>&nbsp;     * implicitly use that transaction.  XAEnvironment.end() causes the
<i class="no-highlight">2317</i>&nbsp;     * transaction to be disassociated with the thread.  In a JCA Local
<i class="no-highlight">2318</i>&nbsp;     * Transaction environment, the call to JEConnectionFactory.getConnection()
<i class="no-highlight">2319</i>&nbsp;     * causes a new transaction to be created and associated with the calling
<i class="no-highlight">2320</i>&nbsp;     * thread.
<i class="no-highlight">2321</i>&nbsp;     *
<i class="no-highlight">2322</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">2323</i>&nbsp;     * environment has been closed.
<i class="no-highlight">2324</i>&nbsp;     */
<i class="no-highlight">2325</i>&nbsp;    public Transaction getThreadTransaction()
<i class="no-highlight">2326</i>&nbsp;        throws DatabaseException {
<i class="no-highlight">2327</i>&nbsp;
<b class="fc"><i class="no-highlight">2328</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">2329</i>&nbsp;
<i class="no-highlight">2330</i>&nbsp;        try {
<b class="fc"><i class="no-highlight">2331</i>&nbsp;            return envImpl.getTxnManager().getTxnForThread();</b>
<b class="nc"><i class="no-highlight">2332</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">2333</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">2334</i>&nbsp;            throw E;</b>
<i class="no-highlight">2335</i>&nbsp;        }
<i class="no-highlight">2336</i>&nbsp;    }
<i class="no-highlight">2337</i>&nbsp;
<i class="no-highlight">2338</i>&nbsp;    /**
<i class="no-highlight">2339</i>&nbsp;     * Sets the transaction associated with this thread if implied transactions
<i class="no-highlight">2340</i>&nbsp;     * are being used.  Implied transactions are used in an XA or JCA &quot;Local
<i class="no-highlight">2341</i>&nbsp;     * Transaction&quot; environment.  In an XA environment the
<i class="no-highlight">2342</i>&nbsp;     * XAEnvironment.start() entrypoint causes a transaction to be created and
<i class="no-highlight">2343</i>&nbsp;     * become associated with the calling thread.  Subsequent API calls
<i class="no-highlight">2344</i>&nbsp;     * implicitly use that transaction.  XAEnvironment.end() causes the
<i class="no-highlight">2345</i>&nbsp;     * transaction to be disassociated with the thread.  In a JCA Local
<i class="no-highlight">2346</i>&nbsp;     * Transaction environment, the call to JEConnectionFactory.getConnection()
<i class="no-highlight">2347</i>&nbsp;     * causes a new transaction to be created and associated with the calling
<i class="no-highlight">2348</i>&nbsp;     * thread.
<i class="no-highlight">2349</i>&nbsp;     *
<i class="no-highlight">2350</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">2351</i>&nbsp;     * environment has been closed.
<i class="no-highlight">2352</i>&nbsp;     */
<i class="no-highlight">2353</i>&nbsp;    public void setThreadTransaction(Transaction txn) {
<i class="no-highlight">2354</i>&nbsp;
<b class="nc"><i class="no-highlight">2355</i>&nbsp;        final EnvironmentImpl envImpl = checkOpen();</b>
<i class="no-highlight">2356</i>&nbsp;
<i class="no-highlight">2357</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">2358</i>&nbsp;            envImpl.getTxnManager().setTxnForThread(txn);</b>
<b class="nc"><i class="no-highlight">2359</i>&nbsp;        } catch (Error E) {</b>
<b class="nc"><i class="no-highlight">2360</i>&nbsp;            envImpl.invalidate(E);</b>
<b class="nc"><i class="no-highlight">2361</i>&nbsp;            throw E;</b>
<b class="nc"><i class="no-highlight">2362</i>&nbsp;        }</b>
<b class="nc"><i class="no-highlight">2363</i>&nbsp;    }</b>
<i class="no-highlight">2364</i>&nbsp;
<i class="no-highlight">2365</i>&nbsp;    /**
<i class="no-highlight">2366</i>&nbsp;     * Returns whether this {@code Environment} is open, valid and can be used.
<i class="no-highlight">2367</i>&nbsp;     *
<i class="no-highlight">2368</i>&nbsp;     * &lt;p&gt;When an {@link EnvironmentFailureException}, or one of its
<i class="no-highlight">2369</i>&nbsp;     * subclasses, is caught, the {@code isValid} method can be called to
<i class="no-highlight">2370</i>&nbsp;     * determine whether the {@code Environment} can continue to be used, or
<i class="no-highlight">2371</i>&nbsp;     * should be closed. Some EnvironmentFailureExceptions invalidate the
<i class="no-highlight">2372</i>&nbsp;     * environment and others do not.&lt;/p&gt;
<i class="no-highlight">2373</i>&nbsp;     *
<i class="no-highlight">2374</i>&nbsp;     * &lt;p&gt;If this method returns false, the environment may have been closed by
<i class="no-highlight">2375</i>&nbsp;     * the application, or may have been invalidated by an exception and not
<i class="no-highlight">2376</i>&nbsp;     * yet closed. The {@link #isClosed()} method may be used to distinguish
<i class="no-highlight">2377</i>&nbsp;     * between these two cases, and {@link #getInvalidatingException()} can be
<i class="no-highlight">2378</i>&nbsp;     * used to return the exception. Note that it is safe to call {@link
<i class="no-highlight">2379</i>&nbsp;     * #close} redundantly, so it is safe to always call {@link #close} when
<i class="no-highlight">2380</i>&nbsp;     * this method returns false.&lt;/p&gt;
<i class="no-highlight">2381</i>&nbsp;     */
<i class="no-highlight">2382</i>&nbsp;    public boolean isValid() {
<b class="nc"><i class="no-highlight">2383</i>&nbsp;        final EnvironmentImpl envImpl = environmentImpl;</b>
<b class="nc"><i class="no-highlight">2384</i>&nbsp;        return envImpl != null &amp;&amp; envImpl.isValid();</b>
<i class="no-highlight">2385</i>&nbsp;    }
<i class="no-highlight">2386</i>&nbsp;
<i class="no-highlight">2387</i>&nbsp;    /**
<i class="no-highlight">2388</i>&nbsp;     * Returns whether the environment has been closed by the application.
<i class="no-highlight">2389</i>&nbsp;     *
<i class="no-highlight">2390</i>&nbsp;     * &lt;p&gt;If this method returns true, {@link #close()}} has been called. If
<i class="no-highlight">2391</i>&nbsp;     * the environment was previously invalidated by an exception, it will be
<i class="no-highlight">2392</i>&nbsp;     * returned by {@link #getInvalidatingException()}.&lt;/p&gt;
<i class="no-highlight">2393</i>&nbsp;     *
<i class="no-highlight">2394</i>&nbsp;     * &lt;p&gt;If this method returns false, the environment may or may not be
<i class="no-highlight">2395</i>&nbsp;     * usable, since it may have been invalidated by an exception but not yet
<i class="no-highlight">2396</i>&nbsp;     * closed. To determine whether it was invalidated, call {@link #isValid()}
<i class="no-highlight">2397</i>&nbsp;     * or {@link #getInvalidatingException()}.&lt;/p&gt;
<i class="no-highlight">2398</i>&nbsp;     *
<i class="no-highlight">2399</i>&nbsp;     * @return whether the environment has been closed by the application.
<i class="no-highlight">2400</i>&nbsp;     *
<i class="no-highlight">2401</i>&nbsp;     * @since 7.2
<i class="no-highlight">2402</i>&nbsp;     */
<i class="no-highlight">2403</i>&nbsp;    public boolean isClosed() {
<b class="nc"><i class="no-highlight">2404</i>&nbsp;        final EnvironmentImpl envImpl = environmentImpl;</b>
<b class="nc"><i class="no-highlight">2405</i>&nbsp;        return envImpl == null || envImpl.isClosed();</b>
<i class="no-highlight">2406</i>&nbsp;    }
<i class="no-highlight">2407</i>&nbsp;
<i class="no-highlight">2408</i>&nbsp;    /**
<i class="no-highlight">2409</i>&nbsp;     * Returns the exception that caused the environment to be invalidated, or
<i class="no-highlight">2410</i>&nbsp;     * null if the environment was not invalidated by an exception.
<i class="no-highlight">2411</i>&nbsp;     *
<i class="no-highlight">2412</i>&nbsp;     * &lt;p&gt;This method may be used to determine whether the environment was
<i class="no-highlight">2413</i>&nbsp;     * invalidated by an exception, by checking for a non-null return value.
<i class="no-highlight">2414</i>&nbsp;     * This method will return the invalidating exception, regardless of
<i class="no-highlight">2415</i>&nbsp;     * whether the environment is closed. Note that {@link #isValid()} will
<i class="no-highlight">2416</i>&nbsp;     * return false when the environment is closed, even when it was not
<i class="no-highlight">2417</i>&nbsp;     * invalidated by an exception.&lt;/p&gt;
<i class="no-highlight">2418</i>&nbsp;     *
<i class="no-highlight">2419</i>&nbsp;     * &lt;p&gt;This method may also be used to identify and handle the original
<i class="no-highlight">2420</i>&nbsp;     * invalidating exception, when more than one exception is thrown. When an
<i class="no-highlight">2421</i>&nbsp;     * environment is first invalidated by an EnvironmentFailureException, the
<i class="no-highlight">2422</i>&nbsp;     * exception is saved so that it can be returned by this method. Other
<i class="no-highlight">2423</i>&nbsp;     * EnvironmentFailureExceptions may be thrown later as side effects of the
<i class="no-highlight">2424</i>&nbsp;     * original problem, or possibly as separate problems. It is normally the
<i class="no-highlight">2425</i>&nbsp;     * first invalidating exception that is most relevant.&lt;/p&gt;
<i class="no-highlight">2426</i>&nbsp;     *
<i class="no-highlight">2427</i>&nbsp;     * @return the invalidating exception or null.
<i class="no-highlight">2428</i>&nbsp;     *
<i class="no-highlight">2429</i>&nbsp;     * @since 7.2
<i class="no-highlight">2430</i>&nbsp;     */
<i class="no-highlight">2431</i>&nbsp;    public EnvironmentFailureException getInvalidatingException() {
<b class="nc"><i class="no-highlight">2432</i>&nbsp;        assert invalidatingEFE != null;</b>
<b class="nc"><i class="no-highlight">2433</i>&nbsp;        return invalidatingEFE.get();</b>
<i class="no-highlight">2434</i>&nbsp;    }
<i class="no-highlight">2435</i>&nbsp;
<i class="no-highlight">2436</i>&nbsp;    /**
<i class="no-highlight">2437</i>&nbsp;     * Print a detailed report about the costs of different phases of
<i class="no-highlight">2438</i>&nbsp;     * environment startup. This report is by default logged to the je.info
<i class="no-highlight">2439</i>&nbsp;     * file if startup takes longer than je.env.startupThreshold.
<i class="no-highlight">2440</i>&nbsp;     *
<i class="no-highlight">2441</i>&nbsp;     * &lt;p&gt;Unlike most Environment methods, this method may be called if the
<i class="no-highlight">2442</i>&nbsp;     * environment is invalid, but not yet closed.&lt;/p&gt;
<i class="no-highlight">2443</i>&nbsp;     *
<i class="no-highlight">2444</i>&nbsp;     * @throws IllegalStateException if this handle or the underlying
<i class="no-highlight">2445</i>&nbsp;     * environment has been closed.
<i class="no-highlight">2446</i>&nbsp;     */
<i class="no-highlight">2447</i>&nbsp;    public void printStartupInfo(PrintStream out) {
<b class="nc"><i class="no-highlight">2448</i>&nbsp;        final EnvironmentImpl envImpl = getNonNullEnvImpl();</b>
<b class="nc"><i class="no-highlight">2449</i>&nbsp;        envImpl.getStartupTracker().displayStats(out, Phase.TOTAL_ENV_OPEN);</b>
<b class="nc"><i class="no-highlight">2450</i>&nbsp;    }</b>
<i class="no-highlight">2451</i>&nbsp;
<i class="no-highlight">2452</i>&nbsp;    /*
<i class="no-highlight">2453</i>&nbsp;     * Non public api -- helpers
<i class="no-highlight">2454</i>&nbsp;     */
<i class="no-highlight">2455</i>&nbsp;
<i class="no-highlight">2456</i>&nbsp;    /**
<i class="no-highlight">2457</i>&nbsp;     * Let the Environment remember what&#39;s opened against it.
<i class="no-highlight">2458</i>&nbsp;     */
<i class="no-highlight">2459</i>&nbsp;    private void addReferringHandle(Database db) {
<b class="fc"><i class="no-highlight">2460</i>&nbsp;        referringDbs.put(db, db);</b>
<b class="fc"><i class="no-highlight">2461</i>&nbsp;    }</b>
<i class="no-highlight">2462</i>&nbsp;
<i class="no-highlight">2463</i>&nbsp;    /**
<i class="no-highlight">2464</i>&nbsp;     * Lets the Environment remember what&#39;s opened against it.
<i class="no-highlight">2465</i>&nbsp;     */
<i class="no-highlight">2466</i>&nbsp;    private void addReferringHandle(Transaction txn) {
<b class="nc"><i class="no-highlight">2467</i>&nbsp;        referringDbTxns.put(txn, txn);</b>
<b class="nc"><i class="no-highlight">2468</i>&nbsp;    }</b>
<i class="no-highlight">2469</i>&nbsp;
<i class="no-highlight">2470</i>&nbsp;    /**
<i class="no-highlight">2471</i>&nbsp;     * The referring db has been closed.
<i class="no-highlight">2472</i>&nbsp;     */
<i class="no-highlight">2473</i>&nbsp;    void removeReferringHandle(Database db) {
<b class="fc"><i class="no-highlight">2474</i>&nbsp;        referringDbs.remove(db);</b>
<b class="fc"><i class="no-highlight">2475</i>&nbsp;    }</b>
<i class="no-highlight">2476</i>&nbsp;
<i class="no-highlight">2477</i>&nbsp;    /**
<i class="no-highlight">2478</i>&nbsp;     * The referring Transaction has been closed.
<i class="no-highlight">2479</i>&nbsp;     */
<i class="no-highlight">2480</i>&nbsp;    void removeReferringHandle(Transaction txn) {
<b class="nc"><i class="no-highlight">2481</i>&nbsp;        referringDbTxns.remove(txn);</b>
<b class="nc"><i class="no-highlight">2482</i>&nbsp;    }</b>
<i class="no-highlight">2483</i>&nbsp;
<i class="no-highlight">2484</i>&nbsp;    /**
<i class="no-highlight">2485</i>&nbsp;     * @throws EnvironmentFailureException if the underlying environment is
<i class="no-highlight">2486</i>&nbsp;     * invalid.
<i class="no-highlight">2487</i>&nbsp;     * @throws IllegalStateException if the environment is not open.
<i class="no-highlight">2488</i>&nbsp;     */
<i class="no-highlight">2489</i>&nbsp;    EnvironmentImpl checkOpen() {
<b class="fc"><i class="no-highlight">2490</i>&nbsp;        final EnvironmentImpl envImpl = getNonNullEnvImpl();</b>
<b class="fc"><i class="no-highlight">2491</i>&nbsp;        envImpl.checkOpen();</b>
<b class="fc"><i class="no-highlight">2492</i>&nbsp;        return envImpl;</b>
<i class="no-highlight">2493</i>&nbsp;    }
<i class="no-highlight">2494</i>&nbsp;
<i class="no-highlight">2495</i>&nbsp;    /**
<i class="no-highlight">2496</i>&nbsp;     * Returns the non-null, underlying EnvironmentImpl.
<i class="no-highlight">2497</i>&nbsp;     *
<i class="no-highlight">2498</i>&nbsp;     * This method is called to access the environmentImpl field, to guard
<i class="no-highlight">2499</i>&nbsp;     * against NPE when the environment has been closed.
<i class="no-highlight">2500</i>&nbsp;     *
<i class="no-highlight">2501</i>&nbsp;     * This method does not check whether the env is valid. For API method
<i class="no-highlight">2502</i>&nbsp;     * calls, checkOpen is called at API entry points to check validity. The
<i class="no-highlight">2503</i>&nbsp;     * validity of the env should also be checked before critical operations
<i class="no-highlight">2504</i>&nbsp;     * (e.g., disk writes), after idle periods, and periodically during time
<i class="no-highlight">2505</i>&nbsp;     * consuming operations.
<i class="no-highlight">2506</i>&nbsp;     *
<i class="no-highlight">2507</i>&nbsp;     * @throws IllegalStateException if the env has been closed.
<i class="no-highlight">2508</i>&nbsp;     */
<i class="no-highlight">2509</i>&nbsp;    EnvironmentImpl getNonNullEnvImpl() {
<i class="no-highlight">2510</i>&nbsp;
<b class="fc"><i class="no-highlight">2511</i>&nbsp;        final EnvironmentImpl envImpl = environmentImpl;</b>
<i class="no-highlight">2512</i>&nbsp;
<b class="fc"><i class="no-highlight">2513</i>&nbsp;        if (envImpl == null) {</b>
<b class="nc"><i class="no-highlight">2514</i>&nbsp;            throw new IllegalStateException(&quot;Environment is closed.&quot;);</b>
<i class="no-highlight">2515</i>&nbsp;        }
<i class="no-highlight">2516</i>&nbsp;
<b class="fc"><i class="no-highlight">2517</i>&nbsp;        return envImpl;</b>
<i class="no-highlight">2518</i>&nbsp;    }
<i class="no-highlight">2519</i>&nbsp;
<i class="no-highlight">2520</i>&nbsp;    /**
<i class="no-highlight">2521</i>&nbsp;     * Returns the underlying EnvironmentImpl, or null if the env has been
<i class="no-highlight">2522</i>&nbsp;     * closed.
<i class="no-highlight">2523</i>&nbsp;     *
<i class="no-highlight">2524</i>&nbsp;     * WARNING: This method will be phased out over time and normally
<i class="no-highlight">2525</i>&nbsp;     * getNonNullEnvImpl should be called instead.
<i class="no-highlight">2526</i>&nbsp;     */
<i class="no-highlight">2527</i>&nbsp;    EnvironmentImpl getMaybeNullEnvImpl() {
<b class="nc"><i class="no-highlight">2528</i>&nbsp;        return environmentImpl;</b>
<i class="no-highlight">2529</i>&nbsp;    }
<i class="no-highlight">2530</i>&nbsp;
<i class="no-highlight">2531</i>&nbsp;    /* Returns true, if this is a handle allocated internally by JE. */
<i class="no-highlight">2532</i>&nbsp;    protected boolean isInternalHandle() {
<b class="fc"><i class="no-highlight">2533</i>&nbsp;        return false;</b>
<i class="no-highlight">2534</i>&nbsp;    }
<i class="no-highlight">2535</i>&nbsp;
<i class="no-highlight">2536</i>&nbsp;    /**
<i class="no-highlight">2537</i>&nbsp;     * @throws UnsupportedOperationException via the database operation methods
<i class="no-highlight">2538</i>&nbsp;     * (remove, truncate, rename) and potentially other methods that require a
<i class="no-highlight">2539</i>&nbsp;     * writable environment.
<i class="no-highlight">2540</i>&nbsp;     */
<i class="no-highlight">2541</i>&nbsp;    private void checkWritable(final EnvironmentImpl envImpl ) {
<b class="nc"><i class="no-highlight">2542</i>&nbsp;        if (envImpl.isReadOnly()) {</b>
<b class="nc"><i class="no-highlight">2543</i>&nbsp;            throw new UnsupportedOperationException</b>
<i class="no-highlight">2544</i>&nbsp;                (&quot;Environment is Read-Only.&quot;);
<i class="no-highlight">2545</i>&nbsp;        }
<b class="nc"><i class="no-highlight">2546</i>&nbsp;    }</b>
<i class="no-highlight">2547</i>&nbsp;
<i class="no-highlight">2548</i>&nbsp;    void invalidate(Error e) {
<b class="nc"><i class="no-highlight">2549</i>&nbsp;        final EnvironmentImpl envImpl = environmentImpl;</b>
<b class="nc"><i class="no-highlight">2550</i>&nbsp;        if (envImpl == null) {</b>
<b class="nc"><i class="no-highlight">2551</i>&nbsp;            return;</b>
<i class="no-highlight">2552</i>&nbsp;        }
<b class="nc"><i class="no-highlight">2553</i>&nbsp;        envImpl.invalidate(e);</b>
<b class="nc"><i class="no-highlight">2554</i>&nbsp;    }</b>
<i class="no-highlight">2555</i>&nbsp;}
</div>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
        var codeBlock = document.getElementById('sourceCode');

        if (codeBlock) {
            hljs.highlightBlock(codeBlock);
        }
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2021-04-19 13:44</div>
</div>
</body>
</html>
